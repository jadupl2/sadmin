<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<meta name="author" content="Dag Wieers, Jeroen Hoekx, Gratien Dhaese">
<title>Relax-and-Recover user guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="book">
<div id="header">
<h1>Relax-and-Recover user guide</h1>
<div class="details">
<span id="author" class="author">Dag Wieers, Jeroen Hoekx, Gratien Dhaese</span><br>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a>
<ul class="sectlevel2">
<li><a href="#_relax_and_recover_project">1.1. Relax-and-Recover project</a></li>
<li><a href="#_design_concepts">1.2. Design concepts</a></li>
<li><a href="#_features_and_functionality">1.3. Features and functionality</a></li>
</ul>
</li>
<li><a href="#_getting_started">2. Getting started</a>
<ul class="sectlevel2">
<li><a href="#_software_requirements">2.1. Software requirements</a></li>
<li><a href="#_distribution_support">2.2. Distribution support</a></li>
<li><a href="#_known_limitations">2.3. Known limitations</a></li>
<li><a href="#_installation">2.4. Installation</a></li>
<li><a href="#_file_locations">2.5. File locations</a></li>
</ul>
</li>
<li><a href="#_configuration">3. Configuration</a>
<ul class="sectlevel2">
<li><a href="#_rescue_media_output">3.1. Rescue media (OUTPUT)</a></li>
<li><a href="#_backuprestore_strategy_backup">3.2. Backup/Restore strategy (BACKUP)</a></li>
<li><a href="#_using_netfs_as_backup_strategy_internal_archive_method">3.3. Using NETFS as backup strategy (internal archive method)</a></li>
<li><a href="#_using_rsync_as_backup_mechanism">3.4. Using RSYNC as backup mechanism</a></li>
</ul>
</li>
<li><a href="#_scenarios">4. Scenarios</a>
<ul class="sectlevel2">
<li><a href="#_bootable_iso">4.1. Bootable ISO</a></li>
<li><a href="#_bootable_iso_with_an_external_commercial_backup_software">4.2. Bootable ISO with an external (commercial) backup software</a></li>
<li><a href="#_bootable_iso_together_with_backup_archive_stored_on_nfsnas">4.3. Bootable ISO together with backup archive stored on NFS/NAS</a></li>
<li><a href="#_bootable_rear_rescue_initramfs_on_ibm_z_s390x_under_zvm">4.4. Bootable ReaR rescue initramfs on IBM Z (s390x) under z/VM</a></li>
<li><a href="#_bootable_usb_device_with_backup_to_usb">4.5. Bootable USB device with backup to USB</a></li>
<li><a href="#_bootable_tape_drive_obdr_with_backup_to_tape">4.6. Bootable tape drive (OBDR) with backup to tape</a></li>
<li><a href="#_bootable_tape_drive_obdr_and_bacula_restore">4.7. Bootable tape drive (OBDR) and Bacula restore</a></li>
<li><a href="#_rear_with_borg_back_end">4.8. ReaR with Borg back end</a></li>
<li><a href="#_backuprestore_alien_file_system_using_blockclone_and_dd">4.9. Backup/restore alien file system using BLOCKCLONE and dd</a></li>
<li><a href="#_using_relax_and_recover_with_usb_storage_devices">4.10. Using Relax-and-Recover with USB storage devices</a></li>
<li><a href="#_using_relax_and_recover_with_obdr_tapes">4.11. Using Relax-and-Recover with OBDR tapes</a></li>
<li><a href="#_using_rear_to_mount_and_repair_your_system">4.12. Using ReaR to mount and repair your system</a></li>
</ul>
</li>
<li><a href="#_integration">5. Integration</a>
<ul class="sectlevel2">
<li><a href="#_monitoring_your_disk_layout_with_relax_and_recover_rear">5.1. Monitoring your disk layout with Relax-and-Recover (ReaR)</a></li>
<li><a href="#_integration_with_nagios_and_opsview">5.2. Integration with Nagios and Opsview</a></li>
</ul>
</li>
<li><a href="#_layout_configuration">6. Layout configuration</a>
<ul class="sectlevel2">
<li><a href="#_general_overview">6.1. General overview</a></li>
<li><a href="#_layout_information_gathered_during_rescue_image_creation">6.2. Layout information gathered during rescue image creation</a></li>
<li><a href="#_excluding_components">6.3. Excluding components</a></li>
<li><a href="#_restore_to_the_same_hardware">6.4. Restore to the same hardware</a></li>
<li><a href="#_restore_to_different_hardware">6.5. Restore to different hardware</a></li>
<li><a href="#_disk_layout_file_syntax">6.6. Disk layout file syntax</a></li>
<li><a href="#_disk_restore_script_recover_mode">6.7. Disk Restore Script (recover mode)</a></li>
</ul>
</li>
<li><a href="#_tips_and_tricks_using_relax_and_recover">7. Tips and Tricks using Relax-and-Recover</a></li>
<li><a href="#_troubleshooting_relax_and_recover">8. Troubleshooting Relax-and-Recover</a>
<ul class="sectlevel2">
<li><a href="#_during_backup">8.1. During backup</a></li>
<li><a href="#_during_recovery">8.2. During recovery</a></li>
</ul>
</li>
<li><a href="#_design_concepts_2">9. Design concepts</a>
<ul class="sectlevel2">
<li><a href="#_the_workflow_system">9.1. The Workflow System</a></li>
<li><a href="#_workflow_make_rescue_media">9.2. Workflow - Make Rescue Media</a></li>
<li><a href="#_workflow_recovery">9.3. Workflow - Recovery</a></li>
<li><a href="#_fs_layout">9.4. FS layout</a></li>
<li><a href="#_inter_module_communication">9.5. Inter-module communication</a></li>
<li><a href="#_major_changes_compared_with_mkcdrec">9.6. Major changes compared with mkCDrec</a></li>
</ul>
</li>
<li><a href="#_integrating_external_backup_programs_into_rear">10. Integrating external backup programs into ReaR</a>
<ul class="sectlevel2">
<li><a href="#_think_before_coding">10.1. Think before coding</a></li>
<li><a href="#_steal_code_from_previous_backup_integrations">10.2. Steal code from previous backup integrations</a></li>
</ul>
</li>
<li><a href="#_using_multiple_backups_for_relax_and_recover">11. Using Multiple Backups for Relax-and-Recover</a>
<ul class="sectlevel2">
<li><a href="#_basics">11.1. Basics</a></li>
<li><a href="#_relax_and_recover_setup_for_multiple_backups">11.2. Relax-and-Recover Setup for Multiple Backups</a></li>
<li><a href="#_relax_and_recover_setup_for_different_backup_methods">11.3. Relax-and-Recover Setup for Different Backup Methods</a></li>
<li><a href="#_running_multiple_backups_and_restores_in_parallel">11.4. Running Multiple Backups and Restores in Parallel</a></li>
</ul>
</li>
<li><a href="#_blockclone_as_backup_method">12. BLOCKCLONE as backup method</a>
<ul class="sectlevel2">
<li><a href="#_limitations">12.1. Limitations</a></li>
<li><a href="#_warning">12.2. Warning!</a></li>
<li><a href="#_examples">12.3. Examples</a></li>
</ul>
</li>
<li><a href="#_support_for_tcg_opal_2_compliant_self_encrypting_disks">13. Support for TCG Opal 2-compliant Self-Encrypting Disks</a>
<ul class="sectlevel2">
<li><a href="#_prerequisites">13.1. Prerequisites</a></li>
<li><a href="#_quick_start_setting_up_self_encrypting_disks">13.2. Quick Start: Setting up Self-Encrypting Disks</a></li>
<li><a href="#_tcg_opal_2_compliant_self_encrypting_disks_2">13.3. TCG Opal 2-compliant Self-Encrypting Disks</a></li>
<li><a href="#_administering_self_encrypting_disks">13.4. Administering Self-Encrypting Disks</a></li>
<li><a href="#_details">13.5. Details</a></li>
<li><a href="#_documentation_for_the_zypper_and_yum_methods">13.6. Documentation for the ZYPPER and YUM Methods</a></li>
<li><a href="#_zypper">13.7. ZYPPER</a></li>
<li><a href="#_yum">13.8. YUM</a></li>
<li><a href="#_yumbackup">13.9. YUM+backup</a></li>
</ul>
</li>
<li><a href="#_efistub_support">14. EFISTUB support</a>
<ul class="sectlevel2">
<li><a href="#_prerequisites_2">14.1. Prerequisites</a></li>
<li><a href="#_rear_configuration">14.2. ReaR Configuration</a></li>
<li><a href="#_migration">14.3. Migration</a></li>
<li><a href="#_checks_done_by_rear">14.4. Checks done by ReaR</a></li>
<li><a href="#_tests">14.5. Tests</a></li>
<li><a href="#_migration_from_grub2_to_efistub_on_sles12_sp2">14.6. Migration from GRUB2 to EFISTUB on SLES12 SP2</a></li>
</ul>
</li>
<li><a href="#_documentation_for_the_rubrik_cloud_data_management_cdm_backup_and_restore_method">15. Documentation for the Rubrik Cloud Data Management (CDM) Backup and Restore Method</a>
<ul class="sectlevel2">
<li><a href="#_summary_2">15.1. Summary</a></li>
<li><a href="#_configuration_10">15.2. Configuration</a></li>
<li><a href="#_known_issues">15.3. Known Issues</a></li>
<li><a href="#_troubleshooting">15.4. Troubleshooting</a></li>
<li><a href="#_test_matrix">15.5. Test Matrix</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This document describes everything there is to know regarding
Relax-and-Recover, an Open Source bare-metal disaster recovery and system
migration solution designed for Linux.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Relax-and-Recover is the leading Open Source bare metal disaster recovery
solution. It is a modular framework with many ready-to-go workflows for
common situations.</p>
</div>
<div class="paragraph">
<p>Relax-and-Recover produces a bootable image which can recreate the system&#8217;s
original storage layout. Once that is done it initiates a restore from backup.
Since the storage layout can be modified prior to recovery, and disimilar
hardware and virtualization is supported, Relax-and-Recover offers the
flexibility to be used for complex system migrations.</p>
</div>
<div class="paragraph">
<p>Currently Relax-and-Recover supports various boot media (incl. ISO, PXE,
OBDR tape, USB or eSATA storage), a variety of network protocols (incl.
sftp, ftp, http, nfs, cifs) as well as a multitude of backup strategies
(incl.  IBM TSM, Micro Focus Data Protector, Symantec NetBackup,
EMC NetWorker [Legato], Dell PowerProtect Data Manager, SEP Sesam,
Galaxy [Simpana], Bacula, Bareos, RBME, rsync, duplicity, Borg).</p>
</div>
<div class="paragraph">
<p>Relax-and-Recover was designed to be easy to set up, requires no maintenance
and is there to assist when disaster strikes. Its setup-and-forget nature
removes any excuse for not having a disaster recovery solution implemented.</p>
</div>
<div class="paragraph">
<p>Recovering from disaster is made very straight-forward by a 2-step recovery
process so that it can be executed by operational teams when required.
When used interactively (e.g. when used for migrating systems), menus help
make decisions to restore to a new (hardware) environment.</p>
</div>
<div class="paragraph">
<p>Extending and integrating Relax-and-Recover into complex environments is made
possible by its modular framework. Consistent logging and optionally extended
output help understand the concepts behind Relax-and-Recover, troubleshoot
during initial configuration and help debug during integration.</p>
</div>
<div class="paragraph">
<p>Professional services and support are available.</p>
</div>
<div class="sect2">
<h3 id="_relax_and_recover_project">1.1. Relax-and-Recover project</h3>
<div class="paragraph">
<p>The support and development of the Relax-and-Recover project takes place
on Github:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Relax-and-Recover website</dt>
<dd>
<p><a href="http://relax-and-recover.org/" class="bare">http://relax-and-recover.org/</a></p>
</dd>
<dt class="hdlist1">Github project</dt>
<dd>
<p><a href="http://github.com/rear/rear/" class="bare">http://github.com/rear/rear/</a></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In case you have questions, ideas or feedback about this document, you
can contact the development team on the Relax-and-Recover mailinglist at:
<a href="mailto:rear-users@lists.relax-and-recover.org">rear-users@lists.relax-and-recover.org</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Note that you have to be subscribed to be able to send mails to the
Relax-and-Recover mailinglist. You can subscribe to the list at:
<a href="http://lists.relax-and-recover.org/mailman/listinfo/rear-users" class="bare">http://lists.relax-and-recover.org/mailman/listinfo/rear-users</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_design_concepts">1.2. Design concepts</h3>
<div class="paragraph">
<p>Based on experience from previous projects, a set of design principles were
defined, and improved over time:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Focus on easy and automated disaster recovery</p>
</li>
<li>
<p>Modular design, focused on system administrators</p>
</li>
<li>
<p>For Linux (and possibly Unix operating systems)</p>
</li>
<li>
<p>Few external dependencies (Bash and standard Unix tools)</p>
</li>
<li>
<p>Easy to use and easy to extend</p>
</li>
<li>
<p>Easy to integrate with <strong>real</strong> backup software</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The goal is to make Relax-and-Recover as least demanding as possible, it will
require only the applications necessary to fulfill the job Relax-and-Recover
is configured for.</p>
</div>
<div class="paragraph">
<p>Furthermore, Relax-and-Recover should be platform independent and ideally
install just as a set of scripts that utilizes everything that the Linux
operating system provides.</p>
</div>
</div>
<div class="sect2">
<h3 id="_features_and_functionality">1.3. Features and functionality</h3>
<div class="paragraph">
<p>Relax-and-Recover has a wide range of features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Improvements to HP SmartArray and CCISS driver integration</p>
</li>
<li>
<p>Improvements to software RAID integration</p>
</li>
<li>
<p>Disk layout change detection for monitoring</p>
</li>
<li>
<p>One-Button-Disaster-Recovery (OBDR) tape support</p>
</li>
<li>
<p>DRBD filesystem support</p>
</li>
<li>
<p>Bacula or Bareos tape support</p>
</li>
<li>
<p>Multiple DR images per system on single USB storage device</p>
</li>
<li>
<p>USB ext3/ext4 support</p>
</li>
<li>
<p>GRUB[2] bootloader re-implementation</p>
</li>
<li>
<p>UEFI support</p>
</li>
<li>
<p>ebiso support (needed by SLES UEFI ISO booting)</p>
</li>
<li>
<p>Add Relax-and-Recover entry to local GRUB configuration (optional)</p>
</li>
<li>
<p>Nagios and webmin integration</p>
</li>
<li>
<p>Syslinux boot menu</p>
</li>
<li>
<p>Storing rescue/backup logfile on rescue media</p>
</li>
<li>
<p>Restoring to different hardware</p>
</li>
<li>
<p>RHEL5, RHEL6 and RHEL7 support</p>
</li>
<li>
<p>SLES 11 and SLES 12 support</p>
</li>
<li>
<p>Debian and Ubuntu support</p>
</li>
<li>
<p>Various usability improvements</p>
</li>
<li>
<p>Serial console support auto-detected</p>
</li>
<li>
<p>Lockless workflows</p>
</li>
<li>
<p>USB udev integration to trigger mkrescue on inserting USB device</p>
</li>
<li>
<p>Beep/UID led/USB suspend integration</p>
</li>
<li>
<p>Migrate UUID from disks and MAC addressed from network interfaces</p>
</li>
<li>
<p>Integrates with Disaster Recovery Linux Manager (DRLM)</p>
</li>
<li>
<p>Data deduplication with Borg as backend</p>
</li>
<li>
<p>Block device level backup/restore</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started">2. Getting started</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_software_requirements">2.1. Software requirements</h3>
<div class="paragraph">
<p>Relax-and-Recover aims to have as little dependencies as possible, however
over time certain capabilities were added using utilities and specific
features, causing older distributions to fall out of support. We try to avoid
this where practically possible and be conservative to add new dependencies.</p>
</div>
<div class="paragraph">
<p>The most basic requirement for Relax-and-Recover is having bash, and
ubiquitous Linux tools like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>dd (coreutils)</p>
</li>
<li>
<p>ethtool</p>
</li>
<li>
<p>file</p>
</li>
<li>
<p>grep</p>
</li>
<li>
<p>gzip</p>
</li>
<li>
<p>ip (iproute[2])</p>
</li>
<li>
<p>mount (util-linux-ng)</p>
</li>
<li>
<p>ps (procps)</p>
</li>
<li>
<p>sed</p>
</li>
<li>
<p>ssh (openssh-clients)</p>
</li>
<li>
<p>strings (binutils)</p>
</li>
<li>
<p>tar</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Optionally, some use-cases require other tools:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>lsscsi and sg3_utils (for OBDR tape support)</p>
</li>
<li>
<p>mkisofs or genisoimage (for ISO output support)</p>
</li>
<li>
<p>syslinux (for ISO or USB output support)</p>
</li>
<li>
<p>syslinux-extlinux (for USB support)</p>
</li>
<li>
<p>ebiso (for SLES UEFI booting)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In some cases having newer versions of tools may provide better support:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>syslinux &gt;= 4.00 (provides menu support)</p>
</li>
<li>
<p>parted</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In case we are using BACKUP=NETFS with nfs or cifs we might need also:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>nfs-client</p>
</li>
<li>
<p>cifs-utils</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_distribution_support">2.2. Distribution support</h3>
<div class="paragraph">
<p>As a project our aim is not to exclude any distribution from being supported,
however (as already noted) some older distributions fell out of support over
time and there is little interest from the project or the community to spend
the effort to add this support.</p>
</div>
<div class="paragraph">
<p>On the other hand there is a larger demand for a tool like Relax-and-Recover
from the Enterprise Linux distributions, and as a result more people are
testing and contributing to support those distributions.</p>
</div>
<div class="paragraph">
<p>Currently we aim to support the following distributions by testing them
regularly:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Red Hat Enterprise Linux and derivatives: RHEL5, RHEL6 and RHEL7</p>
</li>
<li>
<p>SUSE Linux Enterprise Server 11 and 12</p>
</li>
<li>
<p>Ubuntu LTS: 12, 13, 14 and 15</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Distributions dropped as supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ubuntu LTS &lt;12</p>
</li>
<li>
<p>Fedora &lt;21</p>
</li>
<li>
<p>RHEL 3 and 4</p>
</li>
<li>
<p>SLES 9 and 10</p>
</li>
<li>
<p>openSUSE &lt;11</p>
</li>
<li>
<p>Debian &lt;6</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Distributions known to be 'unsupported' are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ubuntu LTS 8.04 (as it does not implement grep -P)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_known_limitations">2.3. Known limitations</h3>
<div class="paragraph">
<p>Relax-and-Recover offers a lot of flexibility in various use-cases, however it
does have some limitations under certain circumstances:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Relax-and-Recover depends on the software of the running system. When
recovering this system to newer hardware, it is possible that the hardware
support of the original system does not support the newer hardware.</p>
<div class="paragraph">
<p>This problem has been seen when restoring an older RHEL4 with an older HP
Proliant Support Pack (PSP) to more recent hardware. This PSP did not detect
the newer HP SmartArray controller or its firmware.</p>
</div>
</li>
<li>
<p>Relax-and-Recover supports recovering to different hardware, but it cannot
always automatically adapt to this new environment. In such cases it
requires a manual intervention to e.g.</p>
<div class="ulist">
<ul>
<li>
<p>modify the <em>disklayout.conf</em> to indicate the number of controller, disks
or specific custom desires during restore</p>
</li>
<li>
<p>reduce the partition-sizes/LV-sizes when restoring to smaller storage</p>
</li>
<li>
<p>pull network-media or configure the network interfaces manually</p>
</li>
</ul>
</div>
</li>
<li>
<p>Depending on your back-up strategy you may have to perform actions, like:</p>
<div class="ulist">
<ul>
<li>
<p>insert the required tape(s)</p>
</li>
<li>
<p>perform commands to restore the backup</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_installation">2.4. Installation</h3>
<div class="paragraph">
<p>You can find the RPM and DEB packages from our web site at <a href="http://relax-and-recover.org/download/" class="bare">http://relax-and-recover.org/download/</a></p>
</div>
<div class="paragraph">
<p>The latest stable versions of Fedora and SLES can be installed via yum and zypper</p>
</div>
<div class="sect3">
<h4 id="_from_rpm_packages">2.4.1. From RPM packages</h4>
<div class="paragraph">
<p>Simply install (or update) the provided packages using
the command: rpm -Uhv rear-1.17-1.fc20.noarch.rpm</p>
</div>
<div class="paragraph">
<p>You can test your installation by running rear dump:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[root@system ~]# rear dump
Relax-and-Recover 1.12.0svn497 / 2011-07-11
Dumping out configuration and system information
System definition:
                                    ARCH = Linux-x86_64
                                      OS = GNU/Linux
                               OS_VENDOR = RedHatEnterpriseServer
                              OS_VERSION = 5.6
...</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_from_deb_packages">2.4.2. From DEB packages</h4>
<div class="paragraph">
<p>On a Debian system (or Ubuntu) you can download the DEB packages from our download page and install it with the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>dpkg -i rear*.deb</pre>
</div>
</div>
<div class="paragraph">
<p>On Debian (Ubuntu) use the following command to install missing dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>apt-get -f install</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_from_source">2.4.3. From source</h4>
<div class="paragraph">
<p>The latest and greatest sources are available at GitHub location : <a href="https://github.com/rear/rear" class="bare">https://github.com/rear/rear</a></p>
</div>
<div class="paragraph">
<p>To make local copy with our github repository just type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git clone git@github.com:rear/rear.git</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_file_locations">2.5. File locations</h3>
<div class="paragraph">
<p>Remember the general configuration file is found at /usr/share/rear/conf/default.conf. In that file you find all variables used by rear which can be overruled by redefining these in the /etc/rear/site.conf or /etc/rear/local.conf files. Please do not modify the default.conf file itself, but use the site.conf or local.conf for this purpose.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Important note about the configuration files inside ReaR. Treat these as Bash scripts! ReaR will source these configuration files, and therefore, if you make any syntax error against Bash scripting rules ReaR will break.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration">3. Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The configuration is performed by changing <em>/etc/rear/local.conf</em> or
<em>/etc/rear/site.conf</em>.</p>
</div>
<div class="paragraph">
<p>There are two important variables that influence Relax-and-Recover and
the rescue image. Set OUTPUT to your preferred boot method and define
BACKUP for your favorite BACKUP strategy.</p>
</div>
<div class="paragraph">
<p>In most cases only these two settings are required.</p>
</div>
<div class="sect2">
<h3 id="_rescue_media_output">3.1. Rescue media (OUTPUT)</h3>
<div class="paragraph">
<p>The OUTPUT variable defines where the rescue image should be sent to.
Possible OUTPUT setting are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">OUTPUT=RAMDISK</dt>
<dd>
<p>Copy the kernel and the initramfs containing the rescue system to a selected
location.</p>
</dd>
<dt class="hdlist1">OUTPUT=ISO</dt>
<dd>
<p>Create a bootable ISO9660 image on disk as <em>rear-$(hostname).iso</em></p>
</dd>
<dt class="hdlist1">OUTPUT=PXE</dt>
<dd>
<p>Create on a remote PXE/NFS server the required files (such as configuration
file, kernel and initrd image)</p>
</dd>
<dt class="hdlist1">OUTPUT=OBDR</dt>
<dd>
<p>Create a bootable OBDR tape including the backup archive. Specify the OBDR
tape device by using TAPE_DEVICE.</p>
</dd>
<dt class="hdlist1">OUTPUT=USB</dt>
<dd>
<p>Create a bootable USB disk (using extlinux). Specify the USB storage device by
using USB_DEVICE.</p>
</dd>
<dt class="hdlist1">OUTPUT=RAWDISK</dt>
<dd>
<p>Create a bootable raw disk image on as <code>rear-$(hostname).raw.gz</code>. Supports UEFI
boot if syslinux/EFI or Grub 2/EFI is installed. Supports Legacy BIOS boot if
syslinux is installed. Supports UEFI/Legacy BIOS dual boot if syslinux <em>and</em> one
of the supported EFI bootloaders are installed.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="_using_output_url_with_iso_ramdisk_or_rawdisk_output_methods">3.1.1. Using OUTPUT_URL with ISO, RAMDISK or RAWDISK output methods</h4>
<div class="paragraph">
<p>When using OUTPUT=ISO, OUTPUT=RAMDISK or OUTPUT=RAWDISK you should provide
the backup target location through the OUTPUT_URL variable. Possible
OUTPUT_URL settings are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">OUTPUT_URL=file://</dt>
<dd>
<p>Write the ISO image to disk. The default is in <em>/var/lib/rear/output/</em>.</p>
</dd>
<dt class="hdlist1">OUTPUT_URL=fish//</dt>
<dd>
<p>Write the ISO image using lftp and the FISH protocol.</p>
</dd>
<dt class="hdlist1">OUTPUT_URL=ftp://</dt>
<dd>
<p>Write the ISO image using lftp and the FTP protocol.</p>
</dd>
<dt class="hdlist1">OUTPUT_URL=ftps://</dt>
<dd>
<p>Write the ISO image using lftp and the FTPS protocol.</p>
</dd>
<dt class="hdlist1">OUTPUT_URL=hftp://</dt>
<dd>
<p>Write the ISO image using lftp and the HFTP protocol.</p>
</dd>
<dt class="hdlist1">OUTPUT_URL=http://</dt>
<dd>
<p>Write the ISO image using lftp and the HTTP (PUT) protocol.</p>
</dd>
<dt class="hdlist1">OUTPUT_URL=https://</dt>
<dd>
<p>Write the ISO image using lftp and the HTTPS (PUT) protocol.</p>
</dd>
<dt class="hdlist1">OUTPUT_URL=nfs://</dt>
<dd>
<p>Write the ISO image using nfs and the NFS protocol.</p>
</dd>
<dt class="hdlist1">OUTPUT_URL=sftp://</dt>
<dd>
<p>Write the ISO image using lftp and the secure FTP (SFTP) protocol.</p>
</dd>
<dt class="hdlist1">OUTPUT_URL=rsync://</dt>
<dd>
<p>Write the ISO image using rsync and the RSYNC protocol.</p>
</dd>
<dt class="hdlist1">OUTPUT_URL=sshfs://</dt>
<dd>
<p>Write the image using sshfs and the SSH protocol.</p>
</dd>
<dt class="hdlist1">OUTPUT_URL=null</dt>
<dd>
<p>Do not copy the ISO image from <em>/var/lib/rear/output/</em> to a remote output location.
OUTPUT_URL=null is useful when another program (e.g. an <em>external</em> backup program)
is used to save the ISO image from the local system to a remote place,
or with BACKUP_URL=iso:///backup when the backup is included in the ISO image
to avoid a (big) copy of the ISO image at a remote output location.
In the latter case the ISO image must be manually saved from the local system to a remote place.
OUTPUT_URL=null is only supported together with BACKUP=NETFS.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The default boot option of the created ISO is boothd / "boot from first harddisk". If you want to change this,
e.g. because you integrate REAR into some automation process, you can change the default using
<em>ISO_DEFAULT={manual,automatic,boothd}</em></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_backuprestore_strategy_backup">3.2. Backup/Restore strategy (BACKUP)</h3>
<div class="paragraph">
<p>The BACKUP setting defines our backup/restore strategy. The BACKUP can be handled via internal archive executable (tar or rsync) or by an external backup program (commercial or open source).</p>
</div>
<div class="paragraph">
<p>Possible BACKUP settings are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">BACKUP=TSM</dt>
<dd>
<p>Use IBM Tivoli Storage Manager programs</p>
</dd>
<dt class="hdlist1">BACKUP=DP</dt>
<dd>
<p>Use Micro Focus Data Protector programs</p>
</dd>
<dt class="hdlist1">BACKUP=FDRUPSTREAM</dt>
<dd>
<p>Use FDR/Upstream</p>
</dd>
<dt class="hdlist1">BACKUP=NBU</dt>
<dd>
<p>Use Symantec NetBackup programs</p>
</dd>
<dt class="hdlist1">BACKUP=NSR</dt>
<dd>
<p>Use EMC NetWorker (Legato)</p>
</dd>
<dt class="hdlist1">BACKUP=PPDM</dt>
<dd>
<p>Use Dell PowerProtect Data Manager</p>
</dd>
<dt class="hdlist1">BACKUP=BACULA</dt>
<dd>
<p>Use Bacula programs</p>
</dd>
<dt class="hdlist1">BACKUP=BAREOS</dt>
<dd>
<p>Use Bareos fork of Bacula</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>BAREOS_FILESET=Full
Only if you have more than one fileset defined for your clients backup jobs, you need to specify which
to use for restore</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">BACKUP=GALAXY</dt>
<dd>
<p>Use CommVault Galaxy (5, probably 6)</p>
</dd>
<dt class="hdlist1">BACKUP=GALAXY7</dt>
<dd>
<p>Use CommVault Galaxy (7 and probably newer)</p>
</dd>
<dt class="hdlist1">BACKUP=GALAXY10</dt>
<dd>
<p>Use CommVault Galaxy 10 (or Simpana 10)</p>
</dd>
<dt class="hdlist1">BACKUP=BORG</dt>
<dd>
<p>Use BorgBackup (short Borg) a deduplicating backup program to restore the data.</p>
</dd>
<dt class="hdlist1">BACKUP=NETFS</dt>
<dd>
<p>Use Relax-and-Recover internal backup with tar or rsync (or similar).
When using BACKUP=NETFS and BACKUP_PROG=tar there is an option to select
BACKUP_TYPE=incremental or BACKUP_TYPE=differential to let rear make
incremental or differential backups until the next full backup day
e.g. via FULLBACKUPDAY="Mon" is reached or when the last full backup
is too old after FULLBACKUP_OUTDATED_DAYS has passed.
Incremental or differential backup is currently only known to work
with BACKUP_URL=nfs. Other BACKUP_URL schemes may work but
at least BACKUP_URL=usb requires USB_SUFFIX to be set
to work with incremental or differential backup.</p>
</dd>
<dt class="hdlist1">BACKUP=REQUESTRESTORE</dt>
<dd>
<p>No backup, just ask user to somehow restore the filesystems.</p>
</dd>
<dt class="hdlist1">BACKUP=EXTERNAL</dt>
<dd>
<p>Use a custom strategy by providing backup and restore commands.</p>
</dd>
<dt class="hdlist1">BACKUP=DUPLICITY</dt>
<dd>
<p>Use duplicity to manage backup (see <a href="http://duplicity.nongnu.org" class="bare">http://duplicity.nongnu.org</a>). Additionally if duply
(see <a href="http://duply.net" class="bare">http://duply.net</a>) is also installed while generating the rescue images it is
part of the image.</p>
</dd>
<dt class="hdlist1">BACKUP=RBME</dt>
<dd>
<p>Use Rsync Backup Made Easy (rbme) to restore the data.</p>
</dd>
<dt class="hdlist1">BACKUP=RSYNC</dt>
<dd>
<p>Use rsync to foresee in backup and restore of your system disks.</p>
</dd>
<dt class="hdlist1">BACKUP=BLOCKCLONE</dt>
<dd>
<p>Backup block devices using dd or ntfsclone</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_using_netfs_as_backup_strategy_internal_archive_method">3.3. Using NETFS as backup strategy (internal archive method)</h3>
<div class="paragraph">
<p>When using BACKUP=NETFS you should provide the backup target location through
the BACKUP_URL variable. Possible BACKUP_URL settings are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">BACKUP_URL=file://</dt>
<dd>
<p>To backup to local disk, use BACKUP_URL=file:///directory/path/</p>
</dd>
<dt class="hdlist1">BACKUP_URL=nfs://</dt>
<dd>
<p>To backup to NFS disk, use BACKUP_URL=nfs://nfs-server-name/share/path</p>
</dd>
<dt class="hdlist1">BACKUP_URL=tape://</dt>
<dd>
<p>To backup to tape device, use BACKUP_URL=tape:///dev/nst0 or alternatively,
simply define TAPE_DEVICE=/dev/nst0</p>
</dd>
<dt class="hdlist1">BACKUP_URL=cifs://</dt>
<dd>
<p>To backup to a Samba share (CIFS), use
BACKUP_URL=cifs://cifs-server-name/share/path. To provide credentials for
CIFS mounting use a <em>/etc/rear/cifs</em> credentials file and define
BACKUP_OPTIONS="cred=/etc/rear/cifs" and pass along:</p>
<div class="listingblock">
<div class="content">
<pre>username=_username_
password=_secret password_
domain=_domain_</pre>
</div>
</div>
</dd>
<dt class="hdlist1">BACKUP_URL=sshfs://</dt>
<dd>
<p>To backup over the network with the help of sshfs. You need the fuse-sshfs package before you can use FUSE-Filesystem to access remote filesystems via SSH. An example of defining the BACKUP_URL could be:</p>
<div class="listingblock">
<div class="content">
<pre>BACKUP_URL=sshfs://root@server/export/archives</pre>
</div>
</div>
</dd>
<dt class="hdlist1">BACKUP_URL=usb://</dt>
<dd>
<p>To backup to USB storage device, use BACKUP_URL=usb:///dev/disk/by-label/REAR-000
or use a real device node or a specific filesystem label. Alternatively, you
can specify the device using USB_DEVICE=/dev/disk/by-label/REAR-000.</p>
<div class="paragraph">
<p>If you combine this with OUTPUT=USB you will end up with a bootable USB device.</p>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Optional settings:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">BACKUP_PROG=rsync</dt>
<dd>
<p>If you want to use rsync instead of tar (only for BACKUP=NETFS). Do not confuse this with the BACKUP=RSYNC backup mechanism.</p>
</dd>
<dt class="hdlist1">NETFS_KEEP_OLD_BACKUP_COPY=y</dt>
<dd>
<p>If you want to keep the previous backup archive.
Incremental or differential backup and NETFS_KEEP_OLD_BACKUP_COPY contradict each other so that
NETFS_KEEP_OLD_BACKUP_COPY must not be 'true' in case of incremental or differential backup.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Another point of interest is the ISO_DIR variable to choose another location of the ISO image instead of the default location (/var/lib/rear/output).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
With USB we refer to all kinds of external storage devices, like USB
keys, USB disks, eSATA disks, ZIP drives, etc&#8230;&#8203;
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_using_rsync_as_backup_mechanism">3.4. Using RSYNC as backup mechanism</h3>
<div class="paragraph">
<p>When using BACKUP=RSYNC you should provide the backup target location through
the BACKUP_URL variable. Possible BACKUP_URL settings are:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>BACKUP_URL=rsync://root@server/export/archives
BACKUP_URL=rsync://root@server::/export/archives</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scenarios">4. Scenarios</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_bootable_iso">4.1. Bootable ISO</h3>
<div class="paragraph">
<p>If you simply want a bootable ISO on a central server, you would do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">OUTPUT=ISO
OUTPUT_URL=http://server/path-to-push/</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_bootable_iso_with_an_external_commercial_backup_software">4.2. Bootable ISO with an external (commercial) backup software</h3>
<div class="paragraph">
<p>If you rely on your backup software to do the full restore of a system then you could define:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">OUTPUT=ISO
BACKUP=[TSM|NSR|DP|NBU|GALAXY10|SEP|DUPLICITY|BACULA|BAREOS|RBME|FDRUPSTREAM]</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using one of the above backup solution (commercial or open source) then there is no need to use rear mkbackup as the backup workflow would be empty. Just use rear mkrescue</p>
</div>
<div class="paragraph">
<p>ReaR will incorporate the needed executables and libraries of your chosen backup solution into the rescue image of ReaR.</p>
</div>
</div>
<div class="sect2">
<h3 id="_bootable_iso_together_with_backup_archive_stored_on_nfsnas">4.3. Bootable ISO together with backup archive stored on NFS/NAS</h3>
<div class="paragraph">
<p>To create an ISO rescue image and using a central NFS/NAS server to store it together with the backup archive, you could define:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">OUTPUT=ISO
BACKUP=NETFS
# BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://your.NFS.server.IP/path/to/your/rear/backup
# BACKUP_PROG_CRYPT_ENABLED="yes"
# { BACKUP_PROG_CRYPT_KEY='my_secret_passphrase' ; } 2&gt;/dev/null</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example shows that it is also possible to encrypt the backup archive.
Currently only 'tar' is supported for backup archive encryption and decryption.
When BACKUP_PROG_CRYPT_ENABLED is set to a true value, BACKUP_PROG_CRYPT_KEY must be also set.
There is no BACKUP_PROG_CRYPT_KEY value in the /etc/rear/local.conf file in the rescue image.
It gets removed because the ReaR rescue/recovery system must be free of secrets.
Otherwise the rescue system ISO image and any recovery medium that is made from it
would have to be carefully protected against any unwanted access.
Therefore BACKUP_PROG_CRYPT_KEY must be manually set before running "rear recover".
For example in the running ReaR rescue system via
<code>export BACKUP_PROG_CRYPT_KEY='my_secret_passphrase'</code>
before calling "rear recover".
You may also do this on the original system before calling "rear mkbackup"
so that there is no need to store it ever in a ReaR config file
but then ensure to run commands that contain 'my_secret_passphrase'
without keeping the command in a history file (e.g. ~/.bash_history).
On the other hand it is crucial to remember the BACKUP_PROG_CRYPT_KEY value
that was used during "rear mkbackup" so that possibly a long time later that
rescue image can be used (possibly by someone else) to recover from a disaster.
If the BACKUP_PROG_CRYPT_KEY value should be set in a ReaR config file
you should avoid that the BACKUP_PROG_CRYPT_KEY value is shown in a log file
when 'rear' is run in debugscript mode (where 'set -x' is set) by redirecting
STDERR to /dev/null via <code>{ command confidential_argument ; } 2&gt;/dev/null</code>
where the redirection must be done via a compound group command even for
a single confidential command to let the redirection also apply for 'set -x'.
See the description in /usr/share/rear/conf/default.conf
how to set variables for secret values in a confidential way.</p>
</div>
</div>
<div class="sect2">
<h3 id="_bootable_rear_rescue_initramfs_on_ibm_z_s390x_under_zvm">4.4. Bootable ReaR rescue initramfs on IBM Z (s390x) under z/VM</h3>
<div class="paragraph">
<p>If you want to create the rescue initramfs with a (tar) backup stored on NFS
server, add the following settings to <code>/etc/rear/local.conf</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">OUTPUT=RAMDISK
OUTPUT_URL=file:///path/to/initramfs
BACKUP=NETFS
BACKUP_URL=nfs://NFS.server.IP/path/to/backup</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure that the path in <code>OUTPUT_URL</code> exists and create the rescue initramfs
and backup using <code>rear mkbackup</code>.</p>
</div>
<div class="paragraph">
<p>There are two options how to boot the rescue environment on IBM Z (s390x) under
z/VM created using the <code>OUTPUT=RAMDISK</code> setting.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using the <code>kexec</code> tool as described in <a href="../../usr/share/rear/conf/templates/RESULT_usage_RAMDISK.txt">RESULT_usage_RAMDISK.txt</a>,
if you have access to a running Linux instance.</p>
</li>
<li>
<p>Using the <code>zipl</code> tool for management of boot devices on s390/s390x.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_booting_rear_rescue_initramfs_on_ibm_z_s390x_under_zvm_with_zipl">4.4.1. Booting ReaR rescue initramfs on IBM Z (s390x) under z/VM with <code>zipl</code></h4>
<div class="paragraph">
<p>First, we have to select a partition on the disk that we want to make bootable.
Assume that the disk is called <code>/dev/dasda</code> and the partition with the filesystem
that will contain the kernel and initramfs is <code>/dev/dasda1</code>.</p>
</div>
<div class="paragraph">
<p>We mount this partition to <code>/mnt/bootdisk</code> and copy there the kernel and initramfs
created in the previous section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># mount /dev/dasda1 /mnt/bootdisk
# cp /path/to/initramfs/HOSTNAME/* /mnt/bootdisk/</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
See <code>zipl(8)</code> for all device types supported by the <code>--target</code> option
      (e.g. DASD, SCSI, &#8230;&#8203;). If you want to use a tape device, see <code>zipl(8)</code>
      to use the <code>--tape</code> option instead. Note that the <code>--tape</code> option with
      ReaR is untested so contributions to this guide are welcome! Also, it is
      not possible to use <code>zipl</code> with the z/VM reader device.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The following method will overwrite the boot configuration on a device
           which contains the given <code>--target</code> directory, in our case
           <code>/dev/dasda</code>!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Use the following command to make the device mounted at <code>/mnt/bootdisk</code> bootable
with <code>zipl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># zipl --target=/mnt/bootdisk \
       --parameters='root=/dev/ram0 ro' \
       --image=/mnt/bootdisk/kernel-HOSTNAME \
       --ramdisk=/mnt/bootdisk/initramfs-HOSTNAME.img

Run /lib/s390-tools//zipl_helper.device-mapper /mnt/bootdisk/
Building bootmap in '/mnt/bootdisk/'
Adding IPL section
  initial ramdisk...: /mnt/bootdisk/initramfs-HOSTNAME.img
  kernel image......: /mnt/bootdisk/kernel-HOSTNAME
  kernel parmline...: 'root=/dev/ram0 ro'
  component address:
    internal loader.: 0x0000a000-0x0000dfff
    parameters......: 0x00009000-0x00009fff
    kernel image....: 0x00010000-0x0076afff
    parmline........: 0x0076c000-0x0076cfff
    initial ramdisk.: 0x00780000-0x28708fff
    environment blk.: 0x0077c000-0x0077cfff
Preparing boot device for CCW- and LD-IPL: dasda.
Done.</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to boot the device with ReaR recovery from a running Linux
instance, you can use the <code>chreipl</code> tool to select a new default boot device
and reboot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># chreipl /mnt/bootdisk
Re-IPL type: ccw
Device:      0.0.0120
Loadparm:    ""
Bootparms:   ""
clear:       0
# reboot
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you do not have a running Linux instance at hand, you can force the boot
from the given device using the z/VM Control Program (CP) directly, e.g. through
a terminal connection.</p>
</div>
<div class="paragraph">
<p>The following example only considers DASD disk devices. Consult the official
z/VM CP Manual for booting from other devices (e.g. FCP attached SCSI) or for
additional details in general.</p>
</div>
<div class="paragraph">
<p>Use the following command to boot from a DASD boot device through z/VM CP,
where the last argument corresponds to the virtual device number (<code>vdev</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>CP IPL 0120</code></pre>
</div>
</div>
<div class="paragraph">
<p>The virtual device number can be either obtained from the <code>Bus-ID</code> column using
the <code>lsdasd -s</code> command from a running Linux instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># lsdasd -s
Bus-ID    Status    Name      Device  Type         BlkSz  Size      Blocks
================================================================================
0120      active    dasda     94:0    ECKD         4096   39128MB   10017000</code></pre>
</div>
</div>
<div class="paragraph">
<p>or directly from z/VM CP with the following query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>CP QUERY VIRTUAL DASD
00:
00: CP QUERY VIRTUAL DASD
00: DASD 0120 ON DASD  2213 R/W 0X0120 SUBCHANNEL = 0004
00: DASD 0121 ON DASD  201A R/W 0X0121 SUBCHANNEL = 0005
...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_bootable_usb_device_with_backup_to_usb">4.5. Bootable USB device with backup to USB</h3>
<div class="paragraph">
<p>If you want a bootable USB device with a (tar) backup to USB as well, you
would use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">BACKUP=NETFS
OUTPUT=USB
USB_DEVICE=/dev/disk/by-label/REAR-000</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_bootable_tape_drive_obdr_with_backup_to_tape">4.6. Bootable tape drive (OBDR) with backup to tape</h3>
<div class="paragraph">
<p>If you want an OBDR image and backup on tape, and use GNU tar for
backup/restore, you would use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">BACKUP=NETFS
OUTPUT=OBDR
TAPE_DEVICE=/dev/nst0</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_bootable_tape_drive_obdr_and_bacula_restore">4.7. Bootable tape drive (OBDR) and Bacula restore</h3>
<div class="paragraph">
<p>If you want an OBDR image on tape, and the Bacula tools to recover your
backup, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">BACKUP=BACULA
OUTPUT=OBDR
TAPE_DEVICE=/dev/nst0</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rear_with_borg_back_end">4.8. ReaR with Borg back end</h3>
<div class="ulist">
<ul>
<li>
<p>Install Borg backup (<a href="https://borgbackup.readthedocs.io/en/stable/installation.html" class="bare">https://borgbackup.readthedocs.io/en/stable/installation.html</a>).</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
We strongly recommend to use Borg standalone binary (<a href="https://github.com/borgbackup/borg/releases" class="bare">https://github.com/borgbackup/borg/releases</a>) as it includes all necessities for Borg operations.
			If you decide to go for different type of Borg installation types, make sure you include all needed files for Borg runtime into ReaR rescue/recovery system.
			E.g. by using <code>COPY_AS_IS_BORG=( '/usr/lib64/python3.4*' '/usr/bin/python3*' '/usr/bin/pyvenv*' '/usr/lib/python3.4*' '/usr/lib64/libpython3*' )</code>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_borg_ssh">4.8.1. Borg &#8594; SSH</h4>
<div class="ulist">
<ul>
<li>
<p>Setup ssh key infrastructure for user that will be running backup.
Issuing following command must work without any password prompts or remote host identity confirmation:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>ssh &lt;BORGBACKUP_USERNAME&gt;@&lt;BORGBACKUP_HOST&gt;</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Example <em>local.conf</em>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>OUTPUT=ISO
OUTPUT_URL=nfs://foo.bar.xy/mnt/backup/iso

BACKUP=BORG
BORGBACKUP_HOST="foo.bar.xy"
BORGBACKUP_USERNAME="borg_user"
BORGBACKUP_REPO="/mnt/backup/client"
BORGBACKUP_REMOTE_PATH="/usr/local/bin/borg"

# Automatic archive pruning
# (https://borgbackup.readthedocs.io/en/stable/usage/prune.html)
BORGBACKUP_PRUNE_KEEP_WEEKLY=2

# Archive compression
# (https://borgbackup.readthedocs.io/en/stable/usage/create.html)
BORGBACKUP_COMPRESSION="lzma,6"     # Slowest backup, best compression

# Repository encryption
# (https://borgbackup.readthedocs.io/en/stable/usage/init.html)
BORGBACKUP_ENC_TYPE="keyfile"
export BORG_PASSPHRASE='S3cr37_P455w0rD'
COPY_AS_IS_BORG=( "$ROOT_HOME_DIR/.config/borg/keys/" )

# Borg environment variables
# (https://borgbackup.readthedocs.io/en/stable/usage/general.html#environment-variables)
export BORG_RELOCATED_REPO_ACCESS_IS_OK="yes"
export BORG_UNKNOWN_UNENCRYPTED_REPO_ACCESS_IS_OK="yes"</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_borg_usb">4.8.2. Borg &#8594; USB</h4>
<div class="ulist">
<ul>
<li>
<p>Example <em>local.conf</em>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>OUTPUT=USB
BACKUP=BORG

USB_DEVICE=/dev/disk/by-label/REAR-000

BORGBACKUP_REPO="/my_borg_backup"
BORGBACKUP_UMASK="0002"

BORGBACKUP_PRUNE_KEEP_WEEKLY=2

BORGBACKUP_ENC_TYPE="keyfile"
export BORG_PASSPHRASE='S3cr37_P455w0rD'

export BORG_RELOCATED_REPO_ACCESS_IS_OK="yes"
export BORG_UNKNOWN_UNENCRYPTED_REPO_ACCESS_IS_OK="yes"

COPY_AS_IS_EXCLUDE=( "${COPY_AS_IS_EXCLUDE[@]}" )
COPY_AS_IS_BORG=( "$ROOT_HOME_DIR/.config/borg/keys/" )

SSH_UNPROTECTED_PRIVATE_KEYS="yes"
SSH_FILES="yes"</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
If using BORGBACKUP_ENC_TYPE="keyfile", don&#8217;t forget to make your
           encryption key available for case of restore!
           (using <code>COPY_AS_IS_BORG=( "$ROOT_HOME_DIR/.config/borg/keys/" )</code> is a option to consider).
           Be sure to read <a href="https://borgbackup.readthedocs.io/en/stable/usage/init.html" class="bare">https://borgbackup.readthedocs.io/en/stable/usage/init.html</a>,
           and make your self familiar how encryption in Borg works.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Executing <code>rear mkbackup</code> will create Relax-and-Recover rescue/recovery system and
start Borg backup process. Once backup finishes, it will also prune old archives from repository,
if at least one of <code>BORGBACKUP_PRUNE_KEEP_*</code> variables is set.</p>
</li>
<li>
<p>To recover your system, boot Relax-and-Recover rescue/recovery system and trigger <code>rear recover</code>.
You will be prompted which archive to recover from Borg repository, once ReaR finished with layout configuration.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>...
Disk layout created.
Starting Borg restore

=== Borg archives list ===
Host:       foo.bar.xy
Repository: /mnt/backup/client

[1] rear_1 	Sun, 2016-10-16 14:08:16
[2] rear_2 	Sun, 2016-10-16 14:32:11

[3] Exit

Choose archive to recover from:</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_backuprestore_alien_file_system_using_blockclone_and_dd">4.9. Backup/restore alien file system using BLOCKCLONE and dd</h3>
<div class="sect3">
<h4 id="_configuration_2">4.9.1. Configuration</h4>
<div class="ulist">
<ul>
<li>
<p>First we need to set some global options to <em>local.conf</em></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># cat local.conf
OUTPUT=ISO
BACKUP=NETFS
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://beta.virtual.sk/mnt/rear</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Now we can define variables that will apply only for targeted block device</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># cat alien.conf
BACKUP=BLOCKCLONE                                        # Define BLOCKCLONE as backup method
BACKUP_PROG_ARCHIVE="alien"                              # Name of image file
BACKUP_PROG_SUFFIX=".dd.img"                             # Suffix of image file
BACKUP_PROG_COMPRESS_SUFFIX=""                           # Clear additional suffixes

BLOCKCLONE_PROG=dd                                       # Use dd for image creation
BLOCKCLONE_PROG_OPTS="bs=4k"                             # Additional options that will be passed to dd
BLOCKCLONE_SOURCE_DEV="/dev/sdc1"                        # Device that should be backed up

BLOCKCLONE_SAVE_MBR_DEV="/dev/sdc"                       # Device where partitioning information is stored (optional)
BLOCKCLONE_MBR_FILE="alien_boot_strap.img"               # Output filename for boot strap code
BLOCKCLONE_PARTITIONS_CONF_FILE="alien_partitions.conf"  # Output filename for partition configuration
BLOCKCLONE_ALLOW_MOUNTED="yes"                           # Device can be mounted during backup (default NO)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_running_backup">4.9.2. Running backup</h4>
<div class="ulist">
<ul>
<li>
<p>Save partitions configuration, bootstrap code and create actual backup of /dev/sdc1</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -C alien mkbackuponly</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Running restore from ReaR restore/recovery system</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -C alien restoreonly

Restore alien.dd.img to device: [/dev/sdc1]                 # User is always prompted for restore destination
Device /dev/sdc1 was not found.                             # If destination does not exist ReaR will try to create it (or fail if BLOCKCLONE_SAVE_MBR_DEV was not set during backup)
Restore partition layout to (^c to abort): [/dev/sdc]       # Prompt user for device where partition configuration should be restored
Checking that no-one is using this disk right now ... OK

Disk /dev/sdc: 5 GiB, 5368709120 bytes, 10485760 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes

&gt;&gt;&gt; Script header accepted.
&gt;&gt;&gt; Script header accepted.
&gt;&gt;&gt; Script header accepted.
&gt;&gt;&gt; Script header accepted.
&gt;&gt;&gt; Created a new DOS disklabel with disk identifier 0x10efb7a9.
Created a new partition 1 of type 'HPFS/NTFS/exFAT' and of size 120 MiB.

/dev/sdc2:
New situation:

Device     Boot Start    End Sectors  Size Id Type
/dev/sdc1        4096 249855  245760  120M  7 HPFS/NTFS/exFAT

The partition table has been altered.
Calling ioctl() to re-read partition table.
Syncing disks.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_relax_and_recover_with_usb_storage_devices">4.10. Using Relax-and-Recover with USB storage devices</h3>
<div class="paragraph">
<p>Using USB devices with Relax-and-Recover can be appealing for several reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you only need to have a bootable rescue environment,
a USB device is a cheap device to store it (needs up to about 1 GB)</p>
</li>
<li>
<p>When you have plenty of space, it could be a simple solution
to store complete disaster recovery images (rescue environment + backup)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>However USB devices may be slow for backup purposes,
especially on older systems and/or with cheap devices.</p>
</div>
<div class="sect3">
<h4 id="_configuring_relax_and_recover_for_usb_storage_devices">4.10.1. Configuring Relax-and-Recover for USB storage devices</h4>
<div class="paragraph">
<p>The below configuration (<em>/etc/rear/local.conf</em>) gives a list of possible
options when you want to run Relax-and-Recover with USB storage.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">BACKUP=BACULA
OUTPUT=USB
USB_DEVICE=/dev/disk/by-label/REAR-000</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_preparing_your_usb_storage_device">4.10.2. Preparing your USB storage device</h4>
<div class="paragraph">
<p>To prepare your USB device for use with Relax-and-Recover, do: rear format /dev/sdX</p>
</div>
<div class="paragraph">
<p>This will will destroy all existing data on that device,
create new partitions and filesystems,
make it bootable,
and label it REAR-000</p>
</div>
</div>
<div class="sect3">
<h4 id="_usb_storage_as_rescue_media">4.10.3. USB storage as rescue media</h4>
<div class="sect4">
<h5 id="_configuring_relax_and_recover_to_have_bacula_tools">Configuring Relax-and-Recover to have Bacula tools</h5>
<div class="paragraph">
<p>If the rescue environment needs additional tools and workflow, this can be
specified by using BACKUP=BACULA in the configuration file
<em>/etc/rear/local.conf</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">BACKUP=BACULA
OUTPUT=USB
USB_DEVICE=/dev/disk/by-label/REAR-000</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_making_the_rescue_usb_storage_device">Making the rescue USB storage device</h5>
<div class="paragraph">
<p>To create a rescue USB device, run rear -v mkrescue as shown below after
you have inserted a <strong>REAR-000</strong> labeled USB device.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[root@system ~]# rear -v mkrescue
Relax-and-Recover 1.12.0svn497 / 2011-07-11
Creating disk layout.
Creating root filesystem layout
Copying files and directories
Copying program files and libraries
Copying kernel modules
Creating initramfs
Finished in 72 seconds.</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="booting-from-usb">Booting from USB storage device</h5>
<div class="paragraph">
<p>Before you can recover our DR backup, it is important to configure the BIOS to
boot from the USB device. In some cases it is required to go into the BIOS setup
(F9 during boot) to change the boot-order of devices. (In BIOS setup select
Standard Boot Order (IPL))</p>
</div>
<div class="paragraph">
<p>Once booted from the USB device, select the system you like to recover from
the list. If you don&#8217;t press a key within 30 seconds, the system will try to
boot from the local disk.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>+---------------------------------------------+
|        "Relax-and-Recover v1.12.0svn497"    |
+---------------------------------------------+
|  "Recovery images"                          |
|    "system.localdomain"                   &gt; |
|    "other.localdomain"                    &gt; |
|---------------------------------------------|
|  "Other actions"                            |
|    "Help for Relax-and-Recover"             |
|    "Boot Local disk (hd1)"                  |
|    "Boot BIOS disk (0x81)"                  |
|    "Boot Next BIOS device"                  |
|    "Hardware Detection tool"                |
|    "Memory test"                            |
|    "Reboot system"                          |
|    "Power off system"                       |
+---------------------------------------------+

      "Press [Tab] to edit options or [F1] for help"

           "Automatic boot in 30 seconds..."</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Booting from a local disk may fail when booting from a USB device.
         This is caused by the fact that the GRUB bootloader on the local
         disk is configured as if it is being the first drive (hd0) but
         it is in fact the second disk (hd1).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then select the image you would like to recover.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>+---------------------------------------------+
|           "system.localdomain"              |
+---------------------------------------------+
|  "2011-03-26 02:16 backup"                  |
|  "2011-03-25 18:39 backup"                  |
|  "2011-03-05 16:12 rescue image"            |
|---------------------------------------------|
|  "Back"                                     |
|                                             |
|                                             |
|                                             |
|                                             |
|                                             |
|                                             |
|                                             |
|                                             |
+---------------------------------------------+

      "Press [Tab] to edit options or [F1] for help"


"Backup using kernel 2.6.32-122.el6.x86_64"
"BACKUP=NETFS OUTPUT=USB OUTPUT_URL=usb:///dev/disk/by-label/REAR-000"</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
When browsing through the images you get more information about the
     image at the bottom of the screen.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_restoring_from_usb_rescue_media">Restoring from USB rescue media</h5>
<div class="paragraph">
<p>Then wait for the system to boot until you get the prompt.</p>
</div>
<div class="paragraph">
<p>On the shell prompt, type rear recover.</p>
</div>
<div class="paragraph">
<p>You may need to answer a few questions depending on your hardware
configuration and whether you are restoring to a (slightly)
different system.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>RESCUE SYSTEM:/ # rear recover
Relax-and-Recover 1.12.0svn497 / 2011-07-11
NOTICE: Will do driver migration
To recreate HP SmartArray controller 3, type exactly YES: YES
To recreate HP SmartArray controller 0, type exactly YES: YES
Clearing HP SmartArray controller 3
Clearing HP SmartArray controller 0
Recreating HP SmartArray controller 3|A
Configuration restored successfully, reloading CCISS driver...  OK
Recreating HP SmartArray controller 0|A
Configuration restored successfully, reloading CCISS driver...  OK
Comparing disks.
Disk configuration is identical, proceeding with restore.
Type "Yes" if you want DRBD resource rBCK to become primary: Yes
Type "Yes" if you want DRBD resource rOPS to become primary: Yes
Start system layout restoration.
Creating partitions for disk /dev/cciss/c0d0 (msdos)
Creating partitions for disk /dev/cciss/c2d0 (msdos)
Creating software RAID /dev/md2
Creating software RAID /dev/md6
Creating software RAID /dev/md3
Creating software RAID /dev/md4
Creating software RAID /dev/md5
Creating software RAID /dev/md1
Creating software RAID /dev/md0
Creating LVM PV /dev/md6
Creating LVM PV /dev/md5
Creating LVM PV /dev/md2
Creating LVM VG vgrem
Creating LVM VG vgqry
Creating LVM VG vg00
Creating LVM volume vg00/lv00
Creating LVM volume vg00/lvdstpol
Creating LVM volume vg00/lvsys
Creating LVM volume vg00/lvusr
Creating LVM volume vg00/lvtmp
Creating LVM volume vg00/lvvar
Creating LVM volume vg00/lvopt
Creating ext3-filesystem / on /dev/mapper/vg00-lv00
Mounting filesystem /
Creating ext3-filesystem /dstpol on /dev/mapper/vg00-lvdstpol
Mounting filesystem /dstpol
Creating ext3-filesystem /dstpol/sys on /dev/mapper/vg00-lvsys
Mounting filesystem /dstpol/sys
Creating ext3-filesystem /usr on /dev/mapper/vg00-lvusr
Mounting filesystem /usr
Creating ext2-filesystem /tmp on /dev/mapper/vg00-lvtmp
Mounting filesystem /tmp
Creating ext3-filesystem /boot on /dev/md0
Mounting filesystem /boot
Creating ext3-filesystem /var on /dev/mapper/vg00-lvvar
Mounting filesystem /var
Creating ext3-filesystem /opt on /dev/mapper/vg00-lvopt
Mounting filesystem /opt
Creating swap on /dev/md1
Creating DRBD resource rBCK
Writing meta data...
initializing activity log
New drbd meta data block successfully created.
Creating LVM PV /dev/drbd2
Creating LVM VG vgbck
Creating LVM volume vgbck/lvetc
Creating LVM volume vgbck/lvvar
Creating LVM volume vgbck/lvmysql
Creating ext3-filesystem /etc/bacula/cluster on /dev/mapper/vgbck-lvetc
Mounting filesystem /etc/bacula/cluster
Creating ext3-filesystem /var/bacula on /dev/mapper/vgbck-lvvar
Mounting filesystem /var/bacula
Creating ext3-filesystem /var/lib/mysql/bacula on /dev/mapper/vgbck-lvmysql
Mounting filesystem /var/lib/mysql/bacula
Creating DRBD resource rOPS
Writing meta data...
initializing activity log
New drbd meta data block successfully created.
Creating LVM PV /dev/drbd1
Creating LVM VG vgops
Creating LVM volume vgops/lvcachemgr
Creating LVM volume vgops/lvbackup
Creating LVM volume vgops/lvdata
Creating LVM volume vgops/lvdb
Creating LVM volume vgops/lvswl
Creating LVM volume vgops/lvcluster
Creating ext3-filesystem /opt/cache on /dev/mapper/vgops-lvcachemgr
Mounting filesystem /opt/cache
Creating ext3-filesystem /dstpol/backup on /dev/mapper/vgops-lvbackup
Mounting filesystem /dstpol/backup
Creating ext3-filesystem /dstpol/data on /dev/mapper/vgops-lvdata
Mounting filesystem /dstpol/data
Creating ext3-filesystem /dstpol/databases on /dev/mapper/vgops-lvdb
Mounting filesystem /dstpol/databases
Creating ext3-filesystem /dstpol/swl on /dev/mapper/vgops-lvswl
Mounting filesystem /dstpol/swl
Creating ext3-filesystem /dstpol/sys/cluster on /dev/mapper/vgops-lvcluster
Mounting filesystem /dstpol/sys/cluster
Disk layout created.

The system is now ready to restore from Bacula. You can use the 'bls' command
to get information from your Volume, and 'bextract' to restore jobs from your
Volume. It is assumed that you know what is necessary to restore - typically
it will be a full backup.

You can find useful Bacula commands in the shell history. When finished, type
'exit' in the shell to continue recovery.

WARNING: The new root is mounted under '/mnt/local'.

rear&gt;</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="restoring-from-bacula-tape">Restoring from Bacula tape</h5>
<div class="paragraph">
<p>Now you need to continue with restoring the actual Bacula backup, for this you
have multiple options of which bextract is the most easy and
straightforward, but also the slowest and unsafest.</p>
</div>
<div class="sect5">
<h6 id="_using_a_bootstrap_file">Using a bootstrap file</h6>
<div class="paragraph">
<p>If you know the JobId of the latest successful full backup, and differential
backups the most efficient way to restore is by creating a bootstrap file with
this information and using it to restore from tape.</p>
</div>
<div class="paragraph">
<p>A bootstrap file looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Volume = VOL-1234
JobId = 914
Job = Bkp_Daily</pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Volume = VOL-1234
VolSessionId = 1
VolSessionTime = 108927638</pre>
</div>
</div>
<div class="paragraph">
<p>Using a bootstrap file with bextract is easy, simply do:
bextract -b bootstrap.txt Ultrium-1 /mnt/local</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
It helps to know exactly how many files you need to restore, and using
     the FileIndex and Count keywords so bextract does not require to
     read the whole tape. Use the commands in your shell history to access
     an example Bacula bootstrap file.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_using_bextract">Using bextract</h6>
<div class="paragraph">
<p>To use bextract to restore <strong>everything</strong> from a single tape, you can do:
bextract -V VOLUME-NAME Ultrium-1 /mnt/local</p>
</div>
<div class="listingblock">
<div class="content">
<pre>rear&gt; bextract -V VOL-1234 Ultrium-1 /mnt/local
bextract: match.c:249-0 add_fname_to_include prefix=0 gzip=0 fname=/
bextract: butil.c:282 Using device: "Ultrium-1" for reading.
30-Mar 16:00 bextract JobId 0: Ready to read from volume "VOL-1234" on device "Ultrium-1" (/dev/st0).
bextract JobId 0: -rw-r-----   1 252      bacula     3623795 2011-03-30 11:02:18  /mnt/local/var/lib/bacula/bacula.sql
bextract JobId 0: drwxr-xr-x   2 root     root          4096 2011-02-02 11:48:28  *none*
bextract JobId 0: drwxr-xr-x   4 root     root          1024 2011-02-23 13:09:53  *none*
bextract JobId 0: drwxr-xr-x  12 root     root          4096 2011-02-02 11:50:00  *none*
bextract JobId 0: -rwx------   1 root     root             0 2011-02-02 11:48:24  /mnt/local/.hpshm_keyfile
bextract JobId 0: -rw-r--r--   1 root     root             0 2011-02-22 12:38:03  /mnt/local/.autofsck
...
30-Mar 16:06 bextract JobId 0: End of Volume at file 7 on device "Ultrium-1" (/dev/st0), Volume "VOL-1234"
30-Mar 16:06 bextract JobId 0: End of all volumes.
30-Mar 16:07 bextract JobId 0: Alert: smartctl version 5.38 [x86_64-redhat-linux-gnu] Copyright (C) 2002-8 Bruce Allen
30-Mar 16:07 bextract JobId 0: Alert: Home page is http://smartmontools.sourceforge.net/
30-Mar 16:07 bextract JobId 0: Alert:
30-Mar 16:07 bextract JobId 0: Alert: TapeAlert: OK
30-Mar 16:07 bextract JobId 0: Alert:
30-Mar 16:07 bextract JobId 0: Alert: Error counter log:
30-Mar 16:07 bextract JobId 0: Alert:            Errors Corrected by           Total   Correction     Gigabytes    Total
30-Mar 16:07 bextract JobId 0: Alert:                ECC          rereads/    errors   algorithm      processed    uncorrected
30-Mar 16:07 bextract JobId 0: Alert:            fast | delayed   rewrites  corrected  invocations   [10^9 bytes]  errors
30-Mar 16:07 bextract JobId 0: Alert: read:       1546        0         0         0       1546          0.000           0
30-Mar 16:07 bextract JobId 0: Alert: write:         0        0         0         0          0          0.000           0
165719 files restored.</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
In this case bextract will restore all the Bacula jobs on the
         provided tapes, start from the oldest, down to the latest. As a
         consequence, deleted files may re-appear and the process may take
         a very long time.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_finish_recovery_process">Finish recovery process</h5>
<div class="paragraph">
<p>Once finished, continue Relax-and-Recover by typing exit.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>rear&gt; exit
Did you restore the backup to /mnt/local ? Ready to continue ? y
Installing GRUB boot loader

Finished recovering your system. You can explore it under '/mnt/local'.

Finished in 4424 seconds.</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
If you neglect to perform this last crucial step, your new system
           will not boot and you have to install a boot-loader yourself
           manually, or re-execute this procedure.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_usb_storage_as_backup_media">4.10.4. USB storage as backup media</h4>
<div class="sect4">
<h5 id="_configuring_relax_and_recover_for_backup_to_usb_storage_device">Configuring Relax-and-Recover for backup to USB storage device</h5>
<div class="paragraph">
<p>The below configuration (<em>/etc/rear/local.conf</em>) gives a list of possible
options when you want to run Relax-and-Recover with USB storage.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">BACKUP=NETFS
OUTPUT=USB
USB_DEVICE=/dev/disk/by-label/REAR-000

### Exclude certain items
ONLY_INCLUDE_VG=( vg00 )
EXCLUDE_MOUNTPOINTS=( /data )</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_making_the_dr_backup_to_usb_storage_device">Making the DR backup to USB storage device</h5>
<div class="paragraph">
<p>Creating a combined rescue device that integrates the backup on USB, it is
sufficient to run rear -v mkbackup as shown below after you have inserted
the USB device. Make sure the device name for the USB device is what is
configured.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[root@system ~]# rear -v mkbackup
Relax-and-Recover 1.12.0svn497 / 2011-07-11
Creating disk layout.
Creating root filesystem layout
Copying files and directories
Copying program files and libraries
Copying kernel modules
Creating initramfs
Creating archive 'usb:///dev/sda1/system.localdomain/20110326.0216/backup.tar.gz'
Total bytes written: 3644416000 (3.4GiB, 5.5MiB/s) in 637 seconds.
Writing MBR to /dev/sda
Modifying local GRUB configuration
Copying resulting files to usb location
Finished in 747 seconds.</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
It is advised to go into single user mode (init 1) before creating
           a backup to ensure all active data is consistent on disk (and no
           important processes are active in memory)
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_booting_from_usb_storage_device">Booting from USB storage device</h5>
<div class="paragraph">
<p>See the section <a href="#booting-from-usb">Booting from USB storage device</a> for more
information about how to enable your BIOS to boot from a USB storage device.</p>
</div>
</div>
<div class="sect4">
<h5 id="_restoring_a_backup_from_usb_storage_device">Restoring a backup from USB storage device</h5>
<div class="paragraph">
<p>Then wait for the system to boot until you get the prompt.</p>
</div>
<div class="paragraph">
<p>On the shell prompt, type rear recover.</p>
</div>
<div class="paragraph">
<p>You may need to answer a few questions depending on your hardware
configuration and whether you are restoring to a (slightly)
different system.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>RESCUE SYSTEM:/ # rear recover
Relax-and-Recover 1.12.0svn497 / 2011-07-11
Backup archive size is 1.2G (compressed)
To recreate HP SmartArray controller 1, type exactly YES: YES
To recreate HP SmartArray controller 7, type exactly YES: YES
Clearing HP SmartArray controller 1
Clearing HP SmartArray controller 7
Recreating HP SmartArray controller 1|A
Configuration restored successfully, reloading CCISS driver...  OK
Recreating HP SmartArray controller 7|A
Configuration restored successfully, reloading CCISS driver...  OK
Comparing disks.
Disk configuration is identical, proceeding with restore.
Start system layout restoration.
Creating partitions for disk /dev/cciss/c0d0 (msdos)
Creating partitions for disk /dev/cciss/c1d0 (msdos)
Creating software RAID /dev/md126
Creating software RAID /dev/md127
Creating LVM PV /dev/md127
Restoring LVM VG vg00
Creating ext3-filesystem / on /dev/mapper/vg00-lv00
Mounting filesystem /
Creating ext3-filesystem /boot on /dev/md126
Mounting filesystem /boot
Creating ext3-filesystem /data on /dev/mapper/vg00-lvdata
Mounting filesystem /data
Creating ext3-filesystem /opt on /dev/mapper/vg00-lvopt
Mounting filesystem /opt
Creating ext2-filesystem /tmp on /dev/mapper/vg00-lvtmp
Mounting filesystem /tmp
Creating ext3-filesystem /usr on /dev/mapper/vg00-lvusr
Mounting filesystem /usr
Creating ext3-filesystem /var on /dev/mapper/vg00-lvvar
Mounting filesystem /var
Creating swap on /dev/mapper/vg00-lvswap
Disk layout created.
Restoring from 'usb:///dev/sda1/system.localdomain/20110326.0216/backup.tar.gz'
Restored 3478 MiB in 134 seconds [avg 26584 KiB/sec]
Installing GRUB boot loader

Finished recovering your system. You can explore it under '/mnt/local'.

Finished in 278 seconds.</pre>
</div>
</div>
<div class="paragraph">
<p>If all is well, you can now remove the USB device, restore the BIOS boot order
and reboot the system into the recovered OS.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_relax_and_recover_with_obdr_tapes">4.11. Using Relax-and-Recover with OBDR tapes</h3>
<div class="paragraph">
<p>Using One-Button-Disaster-Recovery (OBDR) tapes has a few benefits.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Within large organisations tape media is already <strong>part of a workflow</strong>
for offsite storage and is a <strong>known and trusted technology</strong></p>
</li>
<li>
<p>Tapes can store large amounts of data reliably and restoring large
amounts of data is <strong>predictable</strong> in time and effort</p>
</li>
<li>
<p>OBDR offers <strong>booting from tapes</strong>, which is very convenient</p>
</li>
<li>
<p>A single tape can hold both the rescue image as well as a <strong>complete
snapshot</strong> of the system (up to 1.6TB with LTO4)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>However, you need one tape per system as an OBDR tape can only store one
single rescue environment.</p>
</div>
<div class="sect3">
<h4 id="_configuring_relax_and_recover_for_obdr_rescue_tapes">4.11.1. Configuring Relax-and-Recover for OBDR rescue tapes</h4>
<div class="paragraph">
<p>The below configuration (<em>/etc/rear/local.conf</em>) gives a list of possible
options when you want to run Relax-and-Recover with a tape drive. This
example shows how to use the tape <strong>only</strong> for storing the rescue image,
the backup is expected to be handled by Bacula and so the Bacula tools
are included in the rescue environment to enable a Bacula restore.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">OUTPUT=OBDR
TAPE_DEVICE=/dev/nst0</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_preparing_your_obdr_rescue_tape">4.11.2. Preparing your OBDR rescue tape</h4>
<div class="paragraph">
<p>To protect normal backup tapes (in case tape drives are also used by another
backup solution) Relax-and-Recover expects that the tape to use is labeled
<strong>REAR-000</strong>.  To achieve this is to insert a blank tape to use for
Relax-and-Recover and run the rear format /dev/stX command.</p>
</div>
</div>
<div class="sect3">
<h4 id="_obdr_tapes_as_rescue_media">4.11.3. OBDR tapes as rescue media</h4>
<div class="sect4">
<h5 id="_configuring_relax_and_recover_to_have_bacula_tools_2">Configuring Relax-and-Recover to have Bacula tools</h5>
<div class="paragraph">
<p>If the rescue environment needs additional tools and workflow, this can be
specified by using BACKUP=BACULA in the configuration file
<em>/etc/rear/local.conf</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">BACKUP=BACULA
OUTPUT=OBDR
BEXTRACT_DEVICE=Ultrium-1
BEXTRACT_VOLUME=VOL-*</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the BEXTRACT_DEVICE allows you to use the tape device that is
referenced from the Bacula configuration. This helps in those cases where the
discovery of the various tape drives has already been done and configured in
Bacula.</p>
</div>
<div class="paragraph">
<p>The BEXTRACT_VOLUME variable is optional and is only displayed in the
restore instructions on screen as an aid during recovery.</p>
</div>
</div>
<div class="sect4">
<h5 id="_making_the_obdr_rescue_tape">Making the OBDR rescue tape</h5>
<div class="paragraph">
<p>To create a rescue environment that can boot from an OBDR tape, simply run
rear -v mkrescue with a <strong>REAR-000</strong> -labeled tape inserted.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[root@system ~]# rear -v mkrescue
Relax-and-Recover 1.12.0svn497 / 2011-07-11
Rewinding tape
Writing OBDR header to tape in drive '/dev/nst0'
Creating disk layout.
Creating root filesystem layout
Copying files and directories
Copying program files and libraries
Copying kernel modules
Creating initramfs
Making ISO image
Wrote ISO image: /var/lib/rear/output/rear-dag-ops.iso (48M)
Writing ISO image to tape
Modifying local GRUB configuration
Finished in 119 seconds.</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
The message above about <em>/dev/cciss/c1d0</em> not being used makes sense
as this is not a real disk but simply an entry for manipulating the controller.
This is specific to CCISS controllers with only a tape device attached.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="booting-from-obdr">Booting from OBDR rescue tape</h5>
<div class="paragraph">
<p>The One Button Disaster Recovery (OBDR) functionality in HP LTO Ultrium drives
enables them to emulate CD-ROM devices in specific circumstances (also known
as being in ''Disaster Recovery'' mode). The drive can then act as a boot
device for PCs that support booting off CD-ROM.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
An OBDR capable drive can be switched into CD-ROM mode by <strong>powering on
     with the eject button held down</strong>. Make sure you keep it pressed when the
     tape drive regains power, and then release the button. If the drive is in
     OBDR mode, the light will blink regularly. This might be easier in some
     cases than the below procedure, hence the name One Button Disaster
     Recovery !
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="_using_a_hp_smart_array_controller">Using a HP Smart Array controller</h6>
<div class="paragraph">
<p>To boot from OBDR, boot your system with the Relax-and-Recover tape inserted.
During the boot sequence, interrupt the HP Smart Array controller with the
tape attached by pressing <strong>F8</strong> (or <strong>Escape-8</strong> on serial console).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>iLO 2 v1.78 Jun 10 2009 10.5.20.171

Slot 0 HP Smart Array P410i Controller       (512MB, v2.00)   1 Logical Drive
Slot 3 HP Smart Array P401 Controller        (512MB, v2.00)   1 Logical Drive
Slot 4 HP Smart Array P212 Controller          (0MB, v2.00)   0 Logical Drives
     Tape or CD-ROM Drive(s) Detected:
         Port 1I: Box 0: Bay 4
1785-Slot 4 Drive Array Not Configured
     No Drives Detected


  Press &lt;F8&gt; to run the Option ROM Configuration for Arrays Utility
  Press &lt;ESC&gt; to skip configuration and continue</pre>
</div>
</div>
<div class="paragraph">
<p>Then select <strong>Configure OBDR</strong> in the menu and select the Tape drive by marking
it with <strong>X</strong> (default is on) and press <strong>ENTER</strong> and <strong>F8</strong> to activate this change
so it displays ''Configuration saved''.</p>
</div>
<div class="paragraph">
<p>Then press <strong>ENTER</strong> and <strong>Escape</strong> to leave the Smart Array controller BIOS.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>**** System will boot from Tape/CD/OBDR device attached to Smart Array.</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_using_an_lsi_controller">Using an LSI controller</h6>
<div class="paragraph">
<p>To boot from OBDR when using an LSI controller, boot your system with the
Relax-and-Recover tape inserted. During the boot sequence, interrupt the
LSI controller BIOS that has the tape attached by pressing <strong>F8</strong> (or
<strong>Escape-8</strong> on serial console).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>LSI Logic Corp. MPT BIOS
Copyright 1995-2006 LSI Logic Corp.
MPTBIOS-5.05.21.00
HP Build

&lt;&lt;&lt;Press F8 for configuration options&gt;&gt;&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Then select the option 1. Tape-based One Button Disaster Recovery (OBDR).:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Select a configuration option:
1. Tape-based One Button Disaster Recovery (OBDR).
2. Multi Initiator Configuration.                                 &lt;F9 = Setup&gt;
3. Exit.</pre>
</div>
</div>
<div class="paragraph">
<p>And then select the correct tape drive to boot from:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>   compatible tape drives found       -&gt;
   NUM   HBA   SCSI ID   Drive information
    0     0       A       - HP       Ultrium 2-SCSI

   Please choose the NUM of the tape drive to place into OBDR mode.</pre>
</div>
</div>
<div class="paragraph">
<p>If all goes well, the system will reboot with OBDR-mode enabled:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    The PC will now reboot to begin Tape Recovery....</pre>
</div>
</div>
<div class="paragraph">
<p>During the next boot, OBDR-mode will be indicate by:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>*** Bootable media located, Using non-Emulation mode ***</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_booting_the_obdr_tape">Booting the OBDR tape</h6>
<div class="paragraph">
<p>Once booted from the OBDR tape, select the 'Relax-and-Recover' menu entry from
the menu. If you don&#8217;t press a key within 30 seconds, the system will try to
boot from the local disk.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>+---------------------------------------------+
|        "Relax-and-Recover v1.12.0svn497"    |
+---------------------------------------------+
|  "Relax-and-Recover"                        |
|---------------------------------------------|
|  "Other actions"                            |
|    "Help for Relax-and-Recover"             |
|    "Boot Local disk (hd1)"                  |
|    "Boot BIOS disk (0x81)"                  |
|    "Boot Next BIOS device"                  |
|    "Hardware Detection tool"                |
|    "Memory test"                            |
|    "Reboot system"                          |
|    "Power off system"                       |
|                                             |
|                                             |
+---------------------------------------------+

      "Press [Tab] to edit options or [F1] for help"

           "Automatic boot in 30 seconds..."</pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_restoring_the_obdr_rescue_tape">Restoring the OBDR rescue tape</h5>
<div class="paragraph">
<p>Then wait for the system to boot until you get the prompt.</p>
</div>
<div class="paragraph">
<p>On the shell prompt, type rear recover.</p>
</div>
<div class="paragraph">
<p>You may need to answer a few questions depending on your hardware
configuration and whether you are restoring to a (slightly)
different system.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>RESCUE SYSTEM:/ # rear recover
Relax-and-Recover 1.12.0svn497 / 2011-07-11
NOTICE: Will do driver migration
Rewinding tape
To recreate HP SmartArray controller 3, type exactly YES: YES
To recreate HP SmartArray controller 0, type exactly YES: YES
Clearing HP SmartArray controller 3
Clearing HP SmartArray controller 0
Recreating HP SmartArray controller 3|A
Configuration restored successfully, reloading CCISS driver...  OK
Recreating HP SmartArray controller 0|A
Configuration restored successfully, reloading CCISS driver...  OK
Comparing disks.
Disk configuration is identical, proceeding with restore.
Type "Yes" if you want DRBD resource rBCK to become primary: Yes
Type "Yes" if you want DRBD resource rOPS to become primary: Yes
Start system layout restoration.
Creating partitions for disk /dev/cciss/c0d0 (msdos)
Creating partitions for disk /dev/cciss/c2d0 (msdos)
Creating software RAID /dev/md2
Creating software RAID /dev/md6
Creating software RAID /dev/md3
Creating software RAID /dev/md4
Creating software RAID /dev/md5
Creating software RAID /dev/md1
Creating software RAID /dev/md0
Creating LVM PV /dev/md6
Creating LVM PV /dev/md5
Creating LVM PV /dev/md2
Creating LVM VG vgrem
Creating LVM VG vgqry
Creating LVM VG vg00
Creating LVM volume vg00/lv00
Creating LVM volume vg00/lvdstpol
Creating LVM volume vg00/lvsys
Creating LVM volume vg00/lvusr
Creating LVM volume vg00/lvtmp
Creating LVM volume vg00/lvvar
Creating LVM volume vg00/lvopt
Creating ext3-filesystem / on /dev/mapper/vg00-lv00
Mounting filesystem /
Creating ext3-filesystem /dstpol on /dev/mapper/vg00-lvdstpol
Mounting filesystem /dstpol
Creating ext3-filesystem /dstpol/sys on /dev/mapper/vg00-lvsys
Mounting filesystem /dstpol/sys
Creating ext3-filesystem /usr on /dev/mapper/vg00-lvusr
Mounting filesystem /usr
Creating ext2-filesystem /tmp on /dev/mapper/vg00-lvtmp
Mounting filesystem /tmp
Creating ext3-filesystem /boot on /dev/md0
Mounting filesystem /boot
Creating ext3-filesystem /var on /dev/mapper/vg00-lvvar
Mounting filesystem /var
Creating ext3-filesystem /opt on /dev/mapper/vg00-lvopt
Mounting filesystem /opt
Creating swap on /dev/md1
Creating DRBD resource rBCK
Writing meta data...
initializing activity log
New drbd meta data block successfully created.
Creating LVM PV /dev/drbd2
Creating LVM VG vgbck
Creating LVM volume vgbck/lvetc
Creating LVM volume vgbck/lvvar
Creating LVM volume vgbck/lvmysql
Creating ext3-filesystem /etc/bacula/cluster on /dev/mapper/vgbck-lvetc
Mounting filesystem /etc/bacula/cluster
Creating ext3-filesystem /var/bacula on /dev/mapper/vgbck-lvvar
Mounting filesystem /var/bacula
Creating ext3-filesystem /var/lib/mysql/bacula on /dev/mapper/vgbck-lvmysql
Mounting filesystem /var/lib/mysql/bacula
Creating DRBD resource rOPS
Writing meta data...
initializing activity log
New drbd meta data block successfully created.
Creating LVM PV /dev/drbd1
Creating LVM VG vgops
Creating LVM volume vgops/lvcachemgr
Creating LVM volume vgops/lvbackup
Creating LVM volume vgops/lvdata
Creating LVM volume vgops/lvdb
Creating LVM volume vgops/lvswl
Creating LVM volume vgops/lvcluster
Creating ext3-filesystem /opt/cache on /dev/mapper/vgops-lvcachemgr
Mounting filesystem /opt/cache
Creating ext3-filesystem /dstpol/backup on /dev/mapper/vgops-lvbackup
Mounting filesystem /dstpol/backup
Creating ext3-filesystem /dstpol/data on /dev/mapper/vgops-lvdata
Mounting filesystem /dstpol/data
Creating ext3-filesystem /dstpol/databases on /dev/mapper/vgops-lvdb
Mounting filesystem /dstpol/databases
Creating ext3-filesystem /dstpol/swl on /dev/mapper/vgops-lvswl
Mounting filesystem /dstpol/swl
Creating ext3-filesystem /dstpol/sys/cluster on /dev/mapper/vgops-lvcluster
Mounting filesystem /dstpol/sys/cluster
Disk layout created.

The system is now ready to restore from Bacula. You can use the 'bls' command
to get information from your Volume, and 'bextract' to restore jobs from your
Volume. It is assumed that you know what is necessary to restore - typically
it will be a full backup.

You can find useful Bacula commands in the shell history. When finished, type
'exit' in the shell to continue recovery.

WARNING: The new root is mounted under '/mnt/local'.

rear&gt;</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_restoring_from_bacula_tape">Restoring from Bacula tape</h5>
<div class="paragraph">
<p>See the section <a href="#restoring-from-bacula-tape">Restoring from Bacula tape</a>
for more information about how to restore a Bacula tape.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_obdr_tapes_as_backup_media">4.11.4. OBDR tapes as backup media</h4>
<div class="paragraph">
<p>An OBDR backup tape is similar to an OBDR rescue tape, but next to the rescue
environment, it also consists of a complete backup of the system. This is
very convenient in that a single tape can be use for disaster recovery, and
recovery is much more simple and completely automated.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
Please make sure that the system fits onto a single tape uncompressed.
         For an LTO4 Ultrium that would mean no more than 1.6TB.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_configuring_relax_and_recover_for_obdr_backup_tapes">Configuring Relax-and-Recover for OBDR backup tapes</h5>
<div class="paragraph">
<p>The below configuration (<em>/etc/rear/local.conf</em>) gives a list of possible
options when you want to run Relax-and-Recover with a tape drive. This example
shows how to use the tape for storing <strong>both</strong> the rescue image and the backup.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">BACKUP=NETFS
OUTPUT=OBDR
TAPE_DEVICE=/dev/nst0</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_making_the_obdr_backup_tape">Making the OBDR backup tape</h5>
<div class="paragraph">
<p>To create a bootable backup tape that can boot from OBDR, simply run
rear -v mkbackup with a <strong>REAR-000</strong> -labeled tape inserted.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[root@system ~]# rear -v mkbackup
Relax-and-Recover 1.12.0svn497 / 2011-07-11
Rewinding tape
Writing OBDR header to tape in drive '/dev/nst0'
Creating disk layout
Creating root filesystem layout
Copying files and directories
Copying program files and libraries
Copying kernel modules
Creating initramfs
Making ISO image
Wrote ISO image: /var/lib/rear/output/rear-system.iso (45M)
Writing ISO image to tape
Creating archive '/dev/nst0'
Total bytes written: 7834132480 (7.3GiB, 24MiB/s) in 317 seconds.
Rewinding tape
Modifying local GRUB configuration
Finished in 389 seconds.</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
It is advised to go into single user mode (init 1) before creating
           a backup to ensure all active data is consistent on disk (and no
           important processes are active in memory)
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_booting_from_obdr_backup_tape">Booting from OBDR backup tape</h5>
<div class="paragraph">
<p>See the section <a href="#booting-from-obdr">Booting from OBDR rescue tape</a> for more
information about how to enable OBDR and boot from OBDR tapes.</p>
</div>
</div>
<div class="sect4">
<h5 id="_restoring_from_obdr_backup_tape">Restoring from OBDR backup tape</h5>
<div class="listingblock">
<div class="content">
<pre>RESCUE SYSTEM:~ # rear recover
Relax-and-Recover 1.12.0svn497 / 2011-07-11
NOTICE: Will do driver migration
Rewinding tape
To recreate HP SmartArray controller 3, type exactly YES: YES
To recreate HP SmartArray controller 0, type exactly YES: YES
Clearing HP SmartArray controller 3
Clearing HP SmartArray controller 0
Recreating HP SmartArray controller 3|A
Configuration restored successfully, reloading CCISS driver...  OK
Recreating HP SmartArray controller 0|A
Configuration restored successfully, reloading CCISS driver...  OK
Comparing disks.
Disk configuration is identical, proceeding with restore.
Type "Yes" if you want DRBD resource rBCK to become primary: Yes
Type "Yes" if you want DRBD resource rOPS to become primary: Yes
Start system layout restoration.
Creating partitions for disk /dev/cciss/c0d0 (msdos)
Creating partitions for disk /dev/cciss/c2d0 (msdos)
Creating software RAID /dev/md2
Creating software RAID /dev/md6
Creating software RAID /dev/md3
Creating software RAID /dev/md4
Creating software RAID /dev/md5
Creating software RAID /dev/md1
Creating software RAID /dev/md0
Creating LVM PV /dev/md6
Creating LVM PV /dev/md5
Creating LVM PV /dev/md2
Restoring LVM VG vgrem
Restoring LVM VG vgqry
Restoring LVM VG vg00
Creating ext3-filesystem / on /dev/mapper/vg00-lv00
Mounting filesystem /
Creating ext3-filesystem /dstpol on /dev/mapper/vg00-lvdstpol
Mounting filesystem /dstpol
Creating ext3-filesystem /dstpol/sys on /dev/mapper/vg00-lvsys
Mounting filesystem /dstpol/sys
Creating ext3-filesystem /usr on /dev/mapper/vg00-lvusr
Mounting filesystem /usr
Creating ext2-filesystem /tmp on /dev/mapper/vg00-lvtmp
Mounting filesystem /tmp
Creating ext3-filesystem /boot on /dev/md0
Mounting filesystem /boot
Creating ext3-filesystem /var on /dev/mapper/vg00-lvvar
Mounting filesystem /var
Creating ext3-filesystem /opt on /dev/mapper/vg00-lvopt
Mounting filesystem /opt
Creating swap on /dev/md1
Creating DRBD resource rBCK
Writing meta data...
initializing activity log
New drbd meta data block successfully created.
Creating LVM PV /dev/drbd2
Restoring LVM VG vgbck
Creating ext3-filesystem /etc/bacula/cluster on /dev/mapper/vgbck-lvetc
Mounting filesystem /etc/bacula/cluster
Creating ext3-filesystem /var/bacula on /dev/mapper/vgbck-lvvar
Mounting filesystem /var/bacula
Creating ext3-filesystem /var/lib/mysql/bacula on /dev/mapper/vgbck-lvmysql
Mounting filesystem /var/lib/mysql/bacula
Creating DRBD resource rOPS
Writing meta data...
initializing activity log
New drbd meta data block successfully created.
Creating LVM PV /dev/drbd1
Restoring LVM VG vgops
Creating ext3-filesystem /opt/cache on /dev/mapper/vgops-lvcachemgr
Mounting filesystem /opt/cache
Creating ext3-filesystem /dstpol/backup on /dev/mapper/vgops-lvbackup
Mounting filesystem /dstpol/backup
Creating ext3-filesystem /dstpol/data on /dev/mapper/vgops-lvdata
Mounting filesystem /dstpol/data
Creating ext3-filesystem /dstpol/databases on /dev/mapper/vgops-lvdb
Mounting filesystem /dstpol/databases
Creating ext3-filesystem /dstpol/swl on /dev/mapper/vgops-lvswl
Mounting filesystem /dstpol/swl
Creating ext3-filesystem /dstpol/sys/cluster on /dev/mapper/vgops-lvcluster
Mounting filesystem /dstpol/sys/cluster
Disk layout created.
Restoring from 'tape:///dev/nst0/system/backup.tar'
Restored 7460 MiB in 180 seconds [avg 42444 KiB/sec]
Installing GRUB boot loader

Finished recovering your system. You can explore it under '/mnt/local'.

Finished in 361 seconds.</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_rear_to_mount_and_repair_your_system">4.12. Using ReaR to mount and repair your system</h3>
<div class="paragraph">
<p>Instead of using your ReaR image to completely recover your system from bare
metal (as illustrated in most of the above scenarios), you can also use it
as a live media to boot a broken but hopefully repairable system.</p>
</div>
<div class="paragraph">
<p>Once booted on your recovery image, the <code>mountonly</code> workflow will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>activate all Volume Groups</p>
</li>
<li>
<p>offer to decrypt any LUKS-encrypted filesystem that may be present</p>
</li>
<li>
<p>mount all the target filesystems (including the most important virtual
ones) below <code>/mnt/local</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>thereby making it possible for you to explore your system at will,
correcting any configuration mistake that may have prevented its startup,
or allowing you to simply <code>chroot</code> into it and further repair it using its
own administrative tools.</p>
</div>
<div class="paragraph">
<p>One important point to remember is that the <code>mountonly</code> workflow on its own
won&#8217;t modify the target system in any way. Of course, once the target
filesystems are mounted you, as the administrator, may decide to do so
manually.</p>
</div>
<div class="paragraph">
<p><strong>Beware:</strong> The <code>mountonly</code> workflow can only be used on the system where
the rescue image was generated, as it bases its logic on the filesystem
layout description file generated during the run of the <code>mkrescue</code> or
<code>mkbackup</code> workflows.</p>
</div>
<div class="paragraph">
<p>Here are the steps you would typically follow:</p>
</div>
<div class="sect3">
<h4 id="_create_your_recovery_image">4.12.1. Create your recovery image</h4>
<div class="paragraph">
<p>Using any of the techniques described in the other scenarios, create a
ReaR recovery image for your system (through <code>rear mkrescue</code> or <code>rear
mkbackup</code>). If you only take the <code>mountonly</code> workflow into consideration, it
doesn&#8217;t matter whether you also make a backup of your system or not
(obviously, you&#8217;d better cover all your bases and make sure you&#8217;d be able to
perform a full <code>recover</code> as well should the need occur).</p>
</div>
<div class="paragraph">
<p>Please note, that by default ReaR only includes in the recovery image the
tools it will need to recover the system. If you anticipate the need for
some extra tools in the context of a repair operation (e.g. tools that you
might need in the event <code>chroot`ing into the target system doesn&#8217;t work), you
should make sure to include them in your recovery image by adding to the
`PROGS</code> or <code>REQUIRED_PROGS</code> configuration variables (please refer to the
comments in <code>default.conf</code> for the exact meaning of each).</p>
</div>
</div>
<div class="sect3">
<h4 id="_booting_on_the_recovery_image">4.12.2. Booting on the recovery image</h4>
<div class="paragraph">
<p>Arrange for the target system to boot on your recovery image as you would in
any of the other scenarios.</p>
</div>
</div>
<div class="sect3">
<h4 id="_launching_the_mount_only_workflow">4.12.3. Launching the "mount only" workflow</h4>
<div class="paragraph">
<p>Issue the <code>rear mountonly</code> command to launch the workflow (that one is always
verbose):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>RESCUE pc-pan:~ # rear mountonly
Relax-and-Recover 2.5 / Git
Running rear mountonly (PID 625)
Using log file: /var/log/rear/rear-pc-pan.log
Running workflow mountonly within the ReaR rescue/recovery system
Comparing disks
Device sda has expected (same) size 34359738368 (will be used for 'mountonly')
Disk configuration looks identical
Proceed with 'mountonly' (yes) otherwise manual disk layout configuration is enforced
(default 'yes' timeout 30 seconds)
yes
User confirmed to proceed with 'mountonly'
Start target system mount.
Mounting filesystem /
Mounting filesystem /home
Mounting filesystem /boot/efi
Please enter the password for LUKS device cr_vg00-lvol4 (/dev/mapper/vg00-lvol4):
Enter passphrase for /dev/mapper/vg00-lvol4:
Mounting filesystem /products
Disk layout processed.
Finished 'mountonly'. The target system is mounted at '/mnt/local'.
Exiting rear mountonly (PID 625) and its descendant processes ...
Running exit tasks</pre>
</div>
</div>
<div class="paragraph">
<p>As you can see in the output above, you will first be asked to confirm
running the workflow (<code>Proceed with 'mountonly'</code>)&#8201;&#8212;&#8201;simply press return.
All the target filesystems should now be mounted below <code>/mnt/local</code> (including
LUKS-encrypted ones if present and all needed virtual ones). In case any of
them fails to mount, you will be offered to review the mount script and to
re-execute it if needed.</p>
</div>
<div class="paragraph">
<p>Once the system is in the desired state, you can start exploring it, correcting
any configuration mistake or filesystem corruption that prevented it from
booting properly. In this state, the only tools at your disposal are those
included by default in ReaR recovery image, or those you saw fit to add
yourself (see above).</p>
</div>
<div class="paragraph">
<p>If this is not enough and you need to run the native administrative tools
hosted inside your target system (such as YaST in the case of SUSE
distributions), you are now in a position where you can <code>chroot</code> inside
your system to reach them (<code>chroot /mnt/local</code>).</p>
</div>
</div>
<div class="sect3">
<h4 id="_closing_the_session">4.12.4. Closing the session</h4>
<div class="paragraph">
<p>Once done, don&#8217;t forget to leave the <code>chroot</code> environment if applicable
(Ctrl-D), then issue the <code>shutdown</code> command. This will ensure that all the
target filesystems will be cleanly unmounted before the system is restarted.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_integration">5. Integration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_monitoring_your_disk_layout_with_relax_and_recover_rear">5.1. Monitoring your disk layout with Relax-and-Recover (ReaR)</h3>
<div class="paragraph">
<p>A crucial part to properly recreate the system is the disk layout,
i.e. the disk partitioning with filesystems and mount points.</p>
</div>
<div class="paragraph">
<p>When you use "rear mkbackup" to create the ReaR rescue/recovery system
together with a backup of all files and directories of your system
at the same time, you have both parts (recovery system and backup) in sync
which is a prerequirement to properly recreate the system with "rear recover".</p>
</div>
<div class="paragraph">
<p>But when you use "rear mkrescue" to create the ReaR rescue/recovery system
and call "rear mkbackuponly" separately to create the backup
or you call a third party backup tool separately,
you may not have both parts (recovery system and backup) in sync
so "rear recover" may not properly recreate the system
or it may even completely fail to do it.</p>
</div>
<div class="paragraph">
<p>In particular when the disk layout had changed the ReaR rescue/recovery system
must be created anew.</p>
</div>
<div class="paragraph">
<p>Caution:
There are zillions of other ways how the latest created ReaR rescue/recovery system
could become outdated or even invalid/useless in general.
Each change of the basic system setup (like disk layout, network environment,&#8230;&#8203;) and
each change of a software that is used by ReaR (like 'parted', 'mkfs', 'tar',&#8230;&#8203;) and
of course also each ReaR version upgrade requires that the ReaR rescue/recovery system
gets created anew together with a matching up-to-date backup as prerequirement
so that "rear recover" is able to properly recreate the current system.
Furthermore after such changes you must carefully and completely re-validate
that "rear recover" still works in your particular case/environment.</p>
</div>
<div class="paragraph">
<p>The disk layout information is stored in var/lib/rear/layout/disklayout.conf</p>
</div>
<div class="paragraph">
<p>ReaR provides two specific workflows regarding the disk layout:</p>
</div>
<div class="sect3">
<h4 id="_saving_the_current_disk_layout_of_the_system">5.1.1. Saving the current disk layout of the system</h4>
<div class="paragraph">
<p>ReaR automatically saves the current disk layout of the system
when it creates a new ReaR rescue/recovery system.
However if you want to only save the current disk layout manually,
use "rear savelayout" (this does not update the recovery system).</p>
</div>
</div>
<div class="sect3">
<h4 id="_checking_if_the_disk_layout_has_changed">5.1.2. Checking if the disk layout has changed</h4>
<div class="paragraph">
<p>When you want to know if the current disk layout of the system
has changed compared to the latest saved disk layout,
use "rear checklayout".
If the disk layout has changed, "rear checklayout" results a non-zero return code
so you could use something like</p>
</div>
<div class="listingblock">
<div class="content">
<pre># rear checklayout || rear mkrescue</pre>
</div>
</div>
<div class="paragraph">
<p>to create a new ReaR recovery system when the disk layout has changed.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_integration_with_nagios_and_opsview">5.2. Integration with Nagios and Opsview</h3>
<div class="paragraph">
<p>If having current DR rescue images is important to your organization, but they
cannot be automated (eg. a tape or USB device needs inserting), we provide a
Nagios plugin that can send out a notification whenever there is a critical
change to the system that requires updating your rescue environment.</p>
</div>
<div class="paragraph">
<p>Changes to the system requiring an update are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Changes to hardware RAID</p>
</li>
<li>
<p>Changes to software RAID</p>
</li>
<li>
<p>Changes to partitioning</p>
</li>
<li>
<p>Changes to DRBD configuration</p>
</li>
<li>
<p>Changes to LVM</p>
</li>
<li>
<p>Changes to filesystems</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The integration is done using our own <em>check_rear</em> plugin for Nagios.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">#!/bin/bash
#
# Purpose: Checks if disaster recovery usb stick is up to date

# Check if ReaR is installed
if [[ ! -x /usr/sbin/rear ]]; then
    echo "REAR IS NOT INSTALLED"
    exit 2
fi

# ReaR disk layout status can be identical or changed
# returncode: 0 = ok
if ! /usr/sbin/rear checklayout; then
    echo "Disk layout has changed. Please insert Disaster Recovery USB stick into system !"
    exit 2
fi</code></pre>
</div>
</div>
<div class="paragraph">
<p>We also monitor the <em>/var/log/rear/rear-system.log</em> file for ERROR: and BUG
strings, so that in case of problems the operator is notified immediately.</p>
</div>
<div class="paragraph">
<p>Note that error messages may not come from ReaR itself but from programs that are called by ReaR
because stdout and stderr are redirected into ReaR&#8217;s log file (see the section
"What to do with stdin, stdout, and stderr" in <a href="https://github.com/rear/rear/wiki/Coding-Style" class="bare">https://github.com/rear/rear/wiki/Coding-Style</a>)
so in case of error messages one must check if that is actually an error or only false alarm.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_layout_configuration">6. Layout configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Jeroen Hoekx &lt;<a href="mailto:jeroen.hoekx@hamok.be">jeroen.hoekx@hamok.be</a>&gt;
2011-09-10</p>
</div>
<div class="sect2">
<h3 id="_general_overview">6.1. General overview</h3>
<div class="paragraph">
<p>The disk layout generation code in Relax-and-Recover is responsible for the
faithful recreation of the disk layout of the original system. It gathers
information about any component in the system layout. Components supported in
Relax-and-Recover include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Partitions</p>
</li>
<li>
<p>Logical volume management (LVM)</p>
</li>
<li>
<p>Software RAID (MD)</p>
</li>
<li>
<p>Encrypted volumes (LUKS)</p>
</li>
<li>
<p>Multipath disks</p>
</li>
<li>
<p>Swap</p>
</li>
<li>
<p>Filesystems</p>
</li>
<li>
<p>Btrfs Volumes</p>
</li>
<li>
<p>DRBD</p>
</li>
<li>
<p>HP SmartArray controllers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Relax-and-Recover detects dependencies between these components.</p>
</div>
<div class="paragraph">
<p>During the rescue media creation phase, Relax-and-Recover centralizes all
information in one file. During recovery, that file is used to generate the
actual commands to recreate the components. Relax-and-Recover allows
customizations and manual editing in all these phases.</p>
</div>
</div>
<div class="sect2">
<h3 id="_layout_information_gathered_during_rescue_image_creation">6.2. Layout information gathered during rescue image creation</h3>
<div class="paragraph">
<p>Layout information is stored in /var/lib/rear/layout/disklayout.conf. The term 'layout file' in this document refers to this particular file.</p>
</div>
<div class="paragraph">
<p>Consider the information from the following system as an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>disk /dev/sda 160041885696 msdos
#disk /dev/sdb 320072933376 msdos
#disk /dev/sdc 1999696297984 msdos
part /dev/sda 209682432 32768 primary boot /dev/sda1
part /dev/sda 128639303680 209719296 primary lvm /dev/sda2
part /dev/sda 31192862720 128849022976 primary none /dev/sda3
#part /dev/sdb 162144912384 32256 primary none /dev/sdb1
#part /dev/sdb 152556666880 162144944640 primary none /dev/sdb2
#part /dev/sdb 5371321856 314701611520 primary boot /dev/sdb3
#part /dev/sdc 1073741824000 1048576 primary boot /dev/sdc1
#part /dev/sdc 925953425408 1073742872576 primary lvm /dev/sdc2
#lvmdev /dev/backup /dev/sdc2 cJp4Mt-Vkgv-hVlr-wTMb-0qeA-FX7j-3C60p5 1808502784
lvmdev /dev/system /dev/mapper/disk N4Hpdc-DkBP-Hdm6-Z6FH-VixZ-7tTb-LiRt0w 251244544
#lvmgrp /dev/backup 4096 220764 904249344
lvmgrp /dev/system 4096 30669 125620224
#lvmvol /dev/backup backup 12800 104857600
#lvmvol /dev/backup externaltemp 38400 314572800
lvmvol /dev/system root 2560 20971520
lvmvol /dev/system home 5120 41943040
lvmvol /dev/system var 2560 20971520
lvmvol /dev/system swap 512 4194304
lvmvol /dev/system vmxfs 7680 62914560
lvmvol /dev/system kvm 5000 40960000
fs /dev/mapper/system-root / ext4 uuid=dbb0c0d4-7b9a-40e2-be83-daafa14eff6b label= blocksize=4096 reserved_blocks=131072 max_mounts=21 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-home /home ext4 uuid=e9310015-6043-48cd-a37d-78dbfdba1e3b label= blocksize=4096 reserved_blocks=262144 max_mounts=38 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-var /var ext4 uuid=a12bb95f-99f2-42c6-854f-1cb3f144d662 label= blocksize=4096 reserved_blocks=131072 max_mounts=23 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-vmxfs /vmware xfs uuid=7457d2ab-8252-4f41-bab6-607316259975 label=  options=rw,noatime
fs /dev/mapper/system-kvm /kvm ext4 uuid=173ab1f7-8450-4176-8cf7-c09b47f5e3cc label= blocksize=4096 reserved_blocks=256000 max_mounts=21 check_interval=180d options=rw,noatime,commit=0
fs /dev/sda1 /boot ext3 uuid=f6b08566-ea5e-46f9-8f73-5e8ffdaa7be6 label= blocksize=1024 reserved_blocks=10238 max_mounts=35 check_interval=180d options=rw,commit=0
swap /dev/mapper/system-swap uuid=9f347fc7-1605-4788-98fd-fca828beedf1 label=
crypt /dev/mapper/disk /dev/sda2 cipher=aes-xts-plain hash=sha1 uuid=beafe67c-d9a4-4992-80f1-e87791a543bb</pre>
</div>
</div>
<div class="paragraph">
<p>This document will continue to use this example to explore the various options
available in Relax-and-Recover. The exact syntax of the layout file is
described in a later section. It is already clear that this file is human
readable and thus human editable. It is also machine readable and all
information necessary to restore a system is listed.</p>
</div>
<div class="paragraph">
<p>It&#8217;s easy to see that there are 3 disks attached to the system. /dev/sda is the internal disk of the system. Its filesystems are normally mounted. The other devices are external disks. One of them has just normal partitions. The other one has a physical volume on one of the partitions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_excluding_components">6.3. Excluding components</h3>
<div class="sect3">
<h4 id="_autoexcludes">6.3.1. Autoexcludes</h4>
<div class="paragraph">
<p>Relax-and-Recover has reasonable defaults when creating the recovery
information. It has commented out the two external disks and any
component that&#8217;s part of it. The reason is that no mounted filesystem
uses these two disks.</p>
</div>
<div class="paragraph">
<p>This behavior is controlled by the AUTOEXCLUDE_DISKS=y parameter in
default.conf. If we unset it in the local configuration, Relax-and-Recover
will no longer exclude it automatically.</p>
</div>
<div class="paragraph">
<p>A similar mechanism exists for multipath disks. The AUTOEXCLUDE_MULTIPATH=y
variable in default.conf prevents Relax-and-Recover from overwriting
multipath disks. Typically, they are part of the SAN disaster recovery
strategy. However, there can be cases where you want to recover them. The
information is retained in disklayout.conf.</p>
</div>
<div class="paragraph">
<p>Some filesystems are excluded from the layout file by default if their
mountpoints are located under certain directories. This behavior is
controlled by the AUTOEXCLUDE_PATH variable. It is an array of
paths. If a mountpoint of a filesystem is under one of the paths, the
filesystem is excluded. The default value includes /media, /mnt
and /tmp. See default.conf for the full list. Note that if one of
the paths is itself a mountpoint, the filesystem is not excluded. So,
if /media is a mounted filesystem, it will not be excluded, but if
we mount the /dev/mapper/backup-backup filesystem on
/media/backup, it will get excluded, as the mountpoint is under
/media.</p>
</div>
<div class="paragraph">
<p>If we mount the filesystem on /dev/mapper/backup-backup on /backup,
Relax-and-Recover will think that it&#8217;s necessary to recreate the filesystem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>disk /dev/sdc 1999696297984 msdos
...
part /dev/sdc 1073741824000 1048576 primary boot /dev/sdc1
part /dev/sdc 925953425408 1073742872576 primary lvm /dev/sdc2
lvmdev /dev/backup /dev/sdc2 cJp4Mt-Vkgv-hVlr-wTMb-0qeA-FX7j-3C60p5 1808502784
...
lvmgrp /dev/backup 4096 220764 904249344
...
lvmvol /dev/backup backup 12800 104857600
lvmvol /dev/backup externaltemp 38400 314572800
...
fs /dev/mapper/backup-backup /backup ext4 uuid=da20354a-dc4c-4bef-817c-1c92894bb002 label= blocksize=4096 reserved_blocks=655360 max_mounts=24 check_interval=180d options=rw</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_manual_excludes">6.3.2. Manual excludes</h4>
<div class="paragraph">
<p>In this example, the external drive /dev/sdc contains a volume group
used for backups outside Relax-and-Recover. It is assumed that one
does not want to overwrite and recreate the content of the backup disk
when recovering the system, but one expects the backup disk to survive
the recovery unchanged, and that one also does not want
Relax-and-Recover to make a backup of its content. (Note that
excluding a filesystem from the layout file also excludes the files in
the filesystem from the backup when using a supported backup method,
which is what we want in this case.) One thus needs to
exclude the components on the disk from the layout file.
A generic mechanism for doing this is the EXCLUDE_RECREATE
variable. It can contain a list of storage components that will be
excluded from the layout (will be present in the layout file, but
commented out) recursively together with their descendants (components
that depend on the excluded component, like a filesystem on the
underlying logical volume). Each component in the list corresponds to
a component in the layout file, but the syntax is different. To
specify a mounted filesystem, use the fs: prefix:
fs:&lt;mountpoint&gt;. To specify swap, use the swap: prefix. The syntax
to specify a volume group to exclude (together with all its logical
volumes and filesystems on them) is /dev/&lt;volume group name&gt;. Consult
the /var/lib/rear/layout/disktodo.conf file created together with
the layout file for the full list of components in a compatible
syntax.</p>
</div>
<div class="paragraph">
<p>To prevent the mounted backup filesystem from being added to
the layout file and recreated, one may add the filesystem to the EXCLUDE_RECREATE array.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>EXCLUDE_RECREATE+=( "fs:/backup" )</pre>
</div>
</div>
<div class="paragraph">
<p>The layout file is as expected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>#disk /dev/sdc 1999696297984 msdos
...
#part /dev/sdc 1073741824000 1048576 primary boot /dev/sdc1
#part /dev/sdc 925953425408 1073742872576 primary lvm /dev/sdc2
#lvmdev /dev/backup /dev/sdc2 cJp4Mt-Vkgv-hVlr-wTMb-0qeA-FX7j-3C60p5 1808502784
...
#lvmgrp /dev/backup 4096 220764 904249344
...
#lvmvol /dev/backup backup 12800 104857600
#lvmvol /dev/backup externaltemp 38400 314572800
...
#fs /dev/mapper/backup-backup /backup ext4 uuid=da20354a-dc4c-4bef-817c-1c92894bb002 label= blocksize=4096 reserved_blocks=655360 max_mounts=24 check_interval=180d options=rw</pre>
</div>
</div>
<div class="paragraph">
<p>Another approach would be to exclude the backup volume group. This is achieved by adding this line to the local configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>EXCLUDE_RECREATE+=( "/dev/backup" )</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_restore_to_the_same_hardware">6.4. Restore to the same hardware</h3>
<div class="paragraph">
<p>Restoring the system to the same hardware is simple. Type rear recover in
the rescue system prompt. Relax-and-Recover will detect that it&#8217;s restoring to
the same system and will make sure things like UUIDs match. It also asks for
your LUKS encryption password.</p>
</div>
<div class="paragraph">
<p>Once the restore of the backup has completed, Relax-and-Recover will install
the bootloader and the system is back in working order.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>RESCUE firefly:~ # rear recover
Relax-and-Recover 0.0.0 / $Date$
NOTICE: Will do driver migration
Comparing disks.
Disk configuration is identical, proceeding with restore.
Start system layout restoration.
Creating partitions for disk /dev/sda (msdos)
Please enter the password for disk(/dev/sda2):
Enter LUKS passphrase:
Please re-enter the password for disk(/dev/sda2):
Enter passphrase for /dev/sda2:
Creating LVM PV /dev/mapper/disk
Restoring LVM VG system
Creating ext4-filesystem / on /dev/mapper/system-root
Mounting filesystem /
Creating ext4-filesystem /home on /dev/mapper/system-home
Mounting filesystem /home
Creating ext4-filesystem /var on /dev/mapper/system-var
Mounting filesystem /var
Creating xfs-filesystem /vmware on /dev/mapper/system-vmxfs
meta-data=/dev/mapper/system-vmxfs isize=256    agcount=4, agsize=1966080 blks
         =                       sectsz=512   attr=2, projid32bit=0
data     =                       bsize=4096   blocks=7864320, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0
log      =internal log           bsize=4096   blocks=3840, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
Mounting filesystem /vmware
Creating ext4-filesystem /kvm on /dev/mapper/system-kvm
Mounting filesystem /kvm
Creating ext3-filesystem /boot on /dev/sda1
Mounting filesystem /boot
Creating swap on /dev/mapper/system-swap
Disk layout created.
Please start the restore process on your backup host.

Make sure that you restore the data into '/mnt/local' instead of '/' because the
hard disks of the recovered system are mounted there.

Please restore your backup in the provided shell and, when finished, type exit
in the shell to continue recovery.

Welcome to Relax-and-Recover. Run "rear recover" to restore your system !

rear&gt;</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_restore_to_different_hardware">6.5. Restore to different hardware</h3>
<div class="paragraph">
<p>There are two ways to deal with different hardware. One is being lazy and dealing with problems when you encounter them. The second option is to plan in advance. Both are valid approaches. The lazy approach works fine when you are in control of the restore and you have good knowledge of the components in your system. The second approach is preferable in disaster recovery situations or migrations where you know the target hardware in advance and the actual restore can be carried out by less knowledgeable people.</p>
</div>
<div class="sect3">
<h4 id="_the_ad_hoc_way">6.5.1. The Ad-Hoc Way</h4>
<div class="paragraph">
<p>Relax-and-Recover will assist you somewhat in case it notices different disk
sizes. It will ask you to map each differently sized disk to a disk in the
target system. Partitions will be resized. Relax-and-Recover is careful not to
resize your boot partition, since this is often the one with the most
stringent sizing constraints. In fact, it only resizes LVM and RAID
partitions.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s try to restore our system to a different system. Instead of one 160G
disk, there is now one 5G and one 10G disk. That&#8217;s not enough space to restore
the complete system, but for purposes of this demonstration, we do not care
about that. We&#8217;re also not going to use the first disk, but we just want to
show that Relax-and-Recover handles the renaming automatically.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>RESCUE firefly:~ # rear recover
Relax-and-Recover 0.0.0 / $Date$
NOTICE: Will do driver migration
Comparing disks.
Device sda has size 5242880000, 160041885696 expected
Switching to manual disk layout configuration.
Disk sda does not exist in the target system. Please choose the appropriate replacement.
1) sda
2) sdb
3) Do not map disk.
#? 2
2011-09-10 16:17:10 Disk sdb chosen as replacement for sda.
Disk sdb chosen as replacement for sda.
This is the disk mapping table:
    /dev/sda /dev/sdb
Please confirm that '/var/lib/rear/layout/disklayout.conf' is as you expect.

1) View disk layout (disklayout.conf)  4) Go to Relax-and-Recover shell
2) Edit disk layout (disklayout.conf)  5) Continue recovery
3) View original disk space usage      6) Abort Relax-and-Recover</pre>
</div>
</div>
<div class="paragraph">
<p>Ok, mapping the disks was not that hard. If Relax-and-Recover insists on us
checking the disklayout file, we&#8217;d better do that.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>#? 1
disk /dev/sdb 160041885696 msdos
#disk _REAR1_ 320072933376 msdos
#disk /dev/sdc 1999696297984 msdos
part /dev/sdb 209682432 32768 primary boot /dev/sdb1
part /dev/sdb -20916822016 209719296 primary lvm /dev/sdb2
part /dev/sdb 31192862720 128849022976 primary none /dev/sdb3
#part _REAR1_ 162144912384 32256 primary none _REAR1_1
#part _REAR1_ 152556666880 162144944640 primary none _REAR1_2
#part _REAR1_ 5371321856 314701611520 primary boot _REAR1_3
#part /dev/sdc 1073741824000 1048576 primary boot /dev/sdc1
#part /dev/sdc 925953425408 1073742872576 primary lvm /dev/sdc2
#lvmdev /dev/backup /dev/sdc2 cJp4Mt-Vkgv-hVlr-wTMb-0qeA-FX7j-3C60p5 1808502784
lvmdev /dev/system /dev/mapper/disk N4Hpdc-DkBP-Hdm6-Z6FH-VixZ-7tTb-LiRt0w 251244544
#lvmgrp /dev/backup 4096 220764 904249344
lvmgrp /dev/system 4096 30669 125620224
#lvmvol /dev/backup backup 12800 104857600
#lvmvol /dev/backup externaltemp 38400 314572800
lvmvol /dev/system root 2560 20971520
lvmvol /dev/system home 5120 41943040
lvmvol /dev/system var 2560 20971520
lvmvol /dev/system swap 512 4194304
lvmvol /dev/system vmxfs 7680 62914560
lvmvol /dev/system kvm 5000 40960000
fs /dev/mapper/system-root / ext4 uuid=dbb0c0d4-7b9a-40e2-be83-daafa14eff6b label= blocksize=4096 reserved_blocks=131072 max_mounts=21 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-home /home ext4 uuid=e9310015-6043-48cd-a37d-78dbfdba1e3b label= blocksize=4096 reserved_blocks=262144 max_mounts=38 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-var /var ext4 uuid=a12bb95f-99f2-42c6-854f-1cb3f144d662 label= blocksize=4096 reserved_blocks=131072 max_mounts=23 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-vmxfs /vmware xfs uuid=7457d2ab-8252-4f41-bab6-607316259975 label=  options=rw,noatime
fs /dev/mapper/system-kvm /kvm ext4 uuid=173ab1f7-8450-4176-8cf7-c09b47f5e3cc label= blocksize=4096 reserved_blocks=256000 max_mounts=21 check_interval=180d options=rw,noatime,commit=0
fs /dev/sdb1 /boot ext3 uuid=f6b08566-ea5e-46f9-8f73-5e8ffdaa7be6 label= blocksize=1024 reserved_blocks=10238 max_mounts=35 check_interval=180d options=rw,commit=0
#fs /dev/mapper/backup-backup /backup ext4 uuid=da20354a-dc4c-4bef-817c-1c92894bb002 label= blocksize=4096 reserved_blocks=655360 max_mounts=24 check_interval=180d options=rw
swap /dev/mapper/system-swap uuid=9f347fc7-1605-4788-98fd-fca828beedf1 label=
crypt /dev/mapper/disk /dev/sdb2 cipher=aes-xts-plain hash=sha1 uuid=beafe67c-d9a4-4992-80f1-e87791a543bb

1) View disk layout (disklayout.conf)
2) Edit disk layout (disklayout.conf)
3) View original disk space usage
4) Go to Relax-and-Recover shell
5) Continue recovery
6) Abort Relax-and-Recover
#?</pre>
</div>
</div>
<div class="paragraph">
<p>The renaming operation was successful.</p>
</div>
<div class="paragraph">
<p>On the other hand, we can already see quite a few problems. A partition with negative sizes. I do not think any tool would like to create that. Still, we don&#8217;t care at this moment. Do you like entering partition sizes in bytes? Neither do I. There has to be a better way to handle it. We will show it during the next step.</p>
</div>
<div class="paragraph">
<p>The /kvm and /vmware filesystems are quite big. We don&#8217;t care about them, so just put some nice comments on them and their logical volumes.</p>
</div>
<div class="paragraph">
<p>The resulting layout file looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>disk /dev/sdb 160041885696 msdos
#disk _REAR1_ 320072933376 msdos
#disk /dev/sdc 1999696297984 msdos
part /dev/sdb 209682432 32768 primary boot /dev/sdb1
part /dev/sdb -20916822016 209719296 primary lvm /dev/sdb2
part /dev/sdb 31192862720 128849022976 primary none /dev/sdb3
#part _REAR1_ 162144912384 32256 primary none _REAR1_1
#part _REAR1_ 152556666880 162144944640 primary none _REAR1_2
#part _REAR1_ 5371321856 314701611520 primary boot _REAR1_3
#part /dev/sdc 1073741824000 1048576 primary boot /dev/sdc1
#part /dev/sdc 925953425408 1073742872576 primary lvm /dev/sdc2
#lvmdev /dev/backup /dev/sdc2 cJp4Mt-Vkgv-hVlr-wTMb-0qeA-FX7j-3C60p5 1808502784
lvmdev /dev/system /dev/mapper/disk N4Hpdc-DkBP-Hdm6-Z6FH-VixZ-7tTb-LiRt0w 251244544
#lvmgrp /dev/backup 4096 220764 904249344
lvmgrp /dev/system 4096 30669 125620224
#lvmvol /dev/backup backup 12800 104857600
#lvmvol /dev/backup externaltemp 38400 314572800
lvmvol /dev/system root 2560 20971520
lvmvol /dev/system home 5120 41943040
lvmvol /dev/system var 2560 20971520
lvmvol /dev/system swap 512 4194304
#lvmvol /dev/system vmxfs 7680 62914560
#lvmvol /dev/system kvm 5000 40960000
fs /dev/mapper/system-root / ext4 uuid=dbb0c0d4-7b9a-40e2-be83-daafa14eff6b label= blocksize=4096 reserved_blocks=131072 max_mounts=21 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-home /home ext4 uuid=e9310015-6043-48cd-a37d-78dbfdba1e3b label= blocksize=4096 reserved_blocks=262144 max_mounts=38 check_interval=180d options=rw,commit=0
fs /dev/mapper/system-var /var ext4 uuid=a12bb95f-99f2-42c6-854f-1cb3f144d662 label= blocksize=4096 reserved_blocks=131072 max_mounts=23 check_interval=180d options=rw,commit=0
#fs /dev/mapper/system-vmxfs /vmware xfs uuid=7457d2ab-8252-4f41-bab6-607316259975 label=  options=rw,noatime
#fs /dev/mapper/system-kvm /kvm ext4 uuid=173ab1f7-8450-4176-8cf7-c09b47f5e3cc label= blocksize=4096 reserved_blocks=256000 max_mounts=21 check_interval=180d options=rw,noatime,commit=0
fs /dev/sdb1 /boot ext3 uuid=f6b08566-ea5e-46f9-8f73-5e8ffdaa7be6 label= blocksize=1024 reserved_blocks=10238 max_mounts=35 check_interval=180d options=rw,commit=0
#fs /dev/mapper/backup-backup /backup ext4 uuid=da20354a-dc4c-4bef-817c-1c92894bb002 label= blocksize=4096 reserved_blocks=655360 max_mounts=24 check_interval=180d options=rw
swap /dev/mapper/system-swap uuid=9f347fc7-1605-4788-98fd-fca828beedf1 label=
crypt /dev/mapper/disk /dev/sdb2 cipher=aes-xts-plain hash=sha1 uuid=beafe67c-d9a4-4992-80f1-e87791a543bb</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s continue recovery.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1) View disk layout (disklayout.conf)
2) Edit disk layout (disklayout.conf)
3) View original disk space usage
4) Go to Relax-and-Recover shell
5) Continue recovery
6) Abort Relax-and-Recover
#? 5
Partition /dev/sdb3 size reduced to fit on disk.
Please confirm that '/var/lib/rear/layout/diskrestore.sh' is as you expect.

1) View restore script (diskrestore.sh)
2) Edit restore script (diskrestore.sh)
3) View original disk space usage
4) Go to Relax-and-Recover shell
5) Continue recovery
6) Abort Relax-and-Recover
#?</pre>
</div>
</div>
<div class="paragraph">
<p>Now, this is where human friendly resizes are possible. Edit the file. Find the partition creation code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>if create_component "/dev/sdb" "disk" ; then
# Create /dev/sdb (disk)
LogPrint "Creating partitions for disk /dev/sdb (msdos)"
parted -s /dev/sdb mklabel msdos &gt;&amp;2
parted -s /dev/sdb mkpart primary 32768B 209715199B &gt;&amp;2
parted -s /dev/sdb set 1 boot on &gt;&amp;2
parted -s /dev/sdb mkpart primary 209719296B -20707102721B &gt;&amp;2
parted -s /dev/sdb set 2 lvm on &gt;&amp;2
parted -s /dev/sdb mkpart primary 18446744053002452992B 10485759999B &gt;&amp;2
# Wait some time before advancing
sleep 10</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s simple bash code. Change it to use better values. Parted is happy to accept partitions in Megabytes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>if create_component "/dev/sdb" "disk" ; then
# Create /dev/sdb (disk)
LogPrint "Creating partitions for disk /dev/sdb (msdos)"
parted -s /dev/sdb mklabel msdos &gt;&amp;2
parted -s /dev/sdb mkpart primary 1M 200M &gt;&amp;2
parted -s /dev/sdb set 1 boot on &gt;&amp;2
parted -s /dev/sdb mkpart primary 200M 10485759999B &gt;&amp;2
parted -s /dev/sdb set 2 lvm on &gt;&amp;2
# Wait some time before advancing
sleep 10</pre>
</div>
</div>
<div class="paragraph">
<p>The same action should be done for the remaining logical volumes. We would like them to fit on the disk.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>if create_component "/dev/mapper/system-root" "lvmvol" ; then
# Create /dev/mapper/system-root (lvmvol)
LogPrint "Creating LVM volume system/root"
lvm lvcreate -l 2560 -n root system &gt;&amp;2
component_created "/dev/mapper/system-root" "lvmvol"
else
    LogPrint "Skipping /dev/mapper/system-root (lvmvol) as it has already been created."
fi</pre>
</div>
</div>
<div class="paragraph">
<p>No-one but a computer likes to think in extents, so we size it a comfortable 5G.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>if create_component "/dev/mapper/system-root" "lvmvol" ; then
# Create /dev/mapper/system-root (lvmvol)
LogPrint "Creating LVM volume system/root"
lvm lvcreate -L 5G -n root system &gt;&amp;2
component_created "/dev/mapper/system-root" "lvmvol"
else
    LogPrint "Skipping /dev/mapper/system-root (lvmvol) as it has already been created."
fi</pre>
</div>
</div>
<div class="paragraph">
<p>Do the same thing for the other logical volumes and choose number 5, continue.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1) View restore script (diskrestore.sh)
2) Edit restore script (diskrestore.sh)
3) View original disk space usage
4) Go to Relax-and-Recover shell
5) Continue recovery
6) Abort Relax-and-Recover
#? 5
Start system layout restoration.
Creating partitions for disk /dev/sdb (msdos)
Please enter the password for disk(/dev/sdb2):
Enter LUKS passphrase:
Please re-enter the password for disk(/dev/sdb2):
Enter passphrase for /dev/sdb2:
Creating LVM PV /dev/mapper/disk
Creating LVM VG system
Creating LVM volume system/root
Creating LVM volume system/home
Creating LVM volume system/var
Creating LVM volume system/swap
Creating ext4-filesystem / on /dev/mapper/system-root
Mounting filesystem /
Creating ext4-filesystem /home on /dev/mapper/system-home
An error occurred during layout recreation.

1) View Relax-and-Recover log
2) View original disk space usage
3) Go to Relax-and-Recover shell
4) Edit restore script (diskrestore.sh)
5) Continue restore script
6) Abort Relax-and-Recover
#?</pre>
</div>
</div>
<div class="paragraph">
<p>An error&#8230;&#8203; Did you expect it? I didn&#8217;t.</p>
</div>
<div class="paragraph">
<p>Relax-and-Recover produces exceptionally good logs. Let&#8217;s check them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>+++ tune2fs -r 262144 -c 38 -i 180d /dev/mapper/system-home
tune2fs: reserved blocks count is too big (262144)
tune2fs 1.41.14 (22-Dec-2010)
Setting maximal mount count to 38
Setting interval between checks to 15552000 seconds
2011-09-10 16:27:35 An error occurred during layout recreation.</pre>
</div>
</div>
<div class="paragraph">
<p>Yes, we resized the home partition from 20GB to 2G in the previous step. The root user wants more reserved blocks than the total number of available blocks.</p>
</div>
<div class="paragraph">
<p>Fixing it is simple. Edit the restore script, option 4. Find the code responsible for filesystem creation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>if create_component "fs:/home" "fs" ; then
# Create fs:/home (fs)
LogPrint "Creating ext4-filesystem /home on /dev/mapper/system-home"
mkfs -t ext4 -b 4096 /dev/mapper/system-home &gt;&amp;2
tune2fs -U e9310015-6043-48cd-a37d-78dbfdba1e3b /dev/mapper/system-home &gt;&amp;2
tune2fs -r 262144 -c 38 -i 180d /dev/mapper/system-home &gt;&amp;2
LogPrint "Mounting filesystem /home"
mkdir -p /mnt/local/home
mount /dev/mapper/system-home /mnt/local/home
component_created "fs:/home" "fs"
else
    LogPrint "Skipping fs:/home (fs) as it has already been created."
fi</pre>
</div>
</div>
<div class="paragraph">
<p>The -r parameter is causing the error. We just remove it and do the same for the other filesystems.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>if create_component "fs:/home" "fs" ; then
# Create fs:/home (fs)
LogPrint "Creating ext4-filesystem /home on /dev/mapper/system-home"
mkfs -t ext4 -b 4096 /dev/mapper/system-home &gt;&amp;2
tune2fs -U e9310015-6043-48cd-a37d-78dbfdba1e3b /dev/mapper/system-home &gt;&amp;2
tune2fs -c 38 -i 180d /dev/mapper/system-home &gt;&amp;2
LogPrint "Mounting filesystem /home"
mkdir -p /mnt/local/home
mount /dev/mapper/system-home /mnt/local/home
component_created "fs:/home" "fs"
else
    LogPrint "Skipping fs:/home (fs) as it has already been created."
fi</pre>
</div>
</div>
<div class="paragraph">
<p>Continue the restore script.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1) View Relax-and-Recover log
2) View original disk space usage
3) Go to Relax-and-Recover shell
4) Edit restore script (diskrestore.sh)
5) Continue restore script
6) Abort Relax-and-Recover
#? 5
Start system layout restoration.
Skipping /dev/sdb (disk) as it has already been created.
Skipping /dev/sdb1 (part) as it has already been created.
Skipping /dev/sdb2 (part) as it has already been created.
Skipping /dev/sdb3 (part) as it has already been created.
Skipping /dev/mapper/disk (crypt) as it has already been created.
Skipping pv:/dev/mapper/disk (lvmdev) as it has already been created.
Skipping /dev/system (lvmgrp) as it has already been created.
Skipping /dev/mapper/system-root (lvmvol) as it has already been created.
Skipping /dev/mapper/system-home (lvmvol) as it has already been created.
Skipping /dev/mapper/system-var (lvmvol) as it has already been created.
Skipping /dev/mapper/system-swap (lvmvol) as it has already been created.
Skipping fs:/ (fs) as it has already been created.
Creating ext4-filesystem /home on /dev/mapper/system-home
Mounting filesystem /home
Creating ext4-filesystem /var on /dev/mapper/system-var
Mounting filesystem /var
Creating ext3-filesystem /boot on /dev/sdb1
Mounting filesystem /boot
Creating swap on /dev/mapper/system-swap
Disk layout created.</pre>
</div>
</div>
<div class="paragraph">
<p>That looks the way we want it. Notice how Relax-and-Recover detected that it
had already created quite a few components and did not try to recreate them
anymore.</p>
</div>
</div>
<div class="sect3">
<h4 id="_planning_in_advance">6.5.2. Planning In Advance</h4>
<div class="paragraph">
<p>Relax-and-Recover makes it possible to define the layout on the target system
even before the backup is taken. All one has to do is to move the
/var/lib/rear/layout/disklayout.conf file to /etc/rear/disklayout.conf and
edit it. This won&#8217;t be overwritten on future backup runs. During recovery,
Relax-and-Recover will use that file instead of the snapshot of the original
system.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_disk_layout_file_syntax">6.6. Disk layout file syntax</h3>
<div class="paragraph">
<p>This section describes the syntax of all components in the Relax-and-Recover
layout file /var/lib/rear/layout/disklayout.conf</p>
</div>
<div class="paragraph">
<p>One cannot rely on backward compatibility between ReaR versions.
Normally the layout file /var/lib/rear/layout/disklayout.conf is created from scratch
for each run of "rear mkrescue/mkbackup" so a newer ReaR version creates it anew
with the right syntax for this ReaR version which is the exact same ReaR
that gets included in the ReaR recovery system together with this layout file
to recreate the disk layout during "rear recover".
Only when a selfmade /etc/rear/disklayout.conf is used then it must be adapted
by the user when he upgrades to a newer ReaR version.</p>
</div>
<div class="paragraph">
<p>The syntax is of the form</p>
</div>
<div class="listingblock">
<div class="content">
<pre>keyword value1 value2 value3 ...</pre>
</div>
</div>
<div class="paragraph">
<p>where keyword denotes one kind of component (disk, partition, filesystem, &#8230;&#8203;)
and keyword and all the values are separated by single space characters
(which means spaces in values are forbidden - there is neither quoting nor escaping)
so that one can get the lines that belong to a particular component
with particular value1 and value2 via simple commands like</p>
</div>
<div class="listingblock">
<div class="content">
<pre>grep "^keyword value1 value2 " /var/lib/rear/layout/disklayout.conf</pre>
</div>
</div>
<div class="paragraph">
<p>(provided there is a value3 after value2 so there is a space after value2).</p>
</div>
<div class="paragraph">
<p>No whitespace is allowed at the beginning of lines in the disklayout.conf file.
Lines that start with a # (number sign, hash, or pound sign) are comments.
All other lines start with a component keyword.</p>
</div>
<div class="paragraph">
<p>None of the component keywords is a leading substring of another component keyword
(e.g. disk is not a leading substring of raiddisk) so that one could even get
only those lines that belong to a particular component via sloppy commands like</p>
</div>
<div class="listingblock">
<div class="content">
<pre>grep ^keyword /var/lib/rear/layout/disklayout.conf</pre>
</div>
</div>
<div class="paragraph">
<p>regardless that the proper command (in particular for scripts) is</p>
</div>
<div class="listingblock">
<div class="content">
<pre>grep "^keyword " /var/lib/rear/layout/disklayout.conf</pre>
</div>
</div>
<div class="paragraph">
<p>with a single space after the keyword as delimiter.</p>
</div>
<div class="paragraph">
<p>For most component keywords the values are positional parameters
(if there is no value a dummy value like 'none' must be used)
so empty values in between are invalid syntax
which can result arbitrarily bad failures during "rear recover".</p>
</div>
<div class="paragraph">
<p>For some component keywords the parameters have a form like</p>
</div>
<div class="listingblock">
<div class="content">
<pre>keyword value1 value2 optionA=valueA optionB=valueB ...</pre>
</div>
</div>
<div class="paragraph">
<p>where the first ones are positional parameters but not the option=value parameters
so empty option=value parameters are allowed, for example see the 'raidarray' keyword.</p>
</div>
<div class="paragraph">
<p>For details the matching scripts need to be inspected how things actually work
for a particular component keyword (i.e. what is implemented in the code).</p>
</div>
<div class="paragraph">
<p>Syntax of the individual component keyword descriptions below:</p>
</div>
<div class="paragraph">
<p>Normal text has to be present verbatim.
Angle brackets "&lt;" and "&gt;" delimit a value that can be edited.
Quotes " inside the angle brackets indicate a verbatim option,
often used together with a / to indicate multiple options.
Parenthesis "(" ")" inside explain the expected unit.
No unit suffix should be present, unless specifically indicated.
Square brackets "[" and "]" indicate an optional parameter.
They can be excluded when hand-crafting a layout file line.</p>
</div>
<div class="sect3">
<h4 id="_disks">6.6.1. Disks</h4>
<div class="listingblock">
<div class="content">
<pre>disk &lt;name&gt; &lt;size(B)&gt; &lt;partition label&gt;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_partitions">6.6.2. Partitions</h4>
<div class="listingblock">
<div class="content">
<pre>part &lt;disk name&gt; &lt;size(B)&gt; &lt;start(B)&gt; &lt;partition name/type&gt; &lt;flags/"none"&gt; &lt;partition name&gt;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_software_raid_arrays">6.6.3. Software RAID arrays</h4>
<div class="listingblock">
<div class="content">
<pre>raidarray /dev/&lt;kernel RAID device&gt; level=&lt;RAID level&gt; raid-devices=&lt;nr of active devices&gt; devices=&lt;component device1,component device2,...&gt; [name=&lt;array name&gt;] [metadata=&lt;metadata style&gt;] [uuid=&lt;UUID&gt;] [layout=&lt;data layout&gt;] [chunk=&lt;chunk size&gt;] [spare-devices=&lt;nr of spare devices&gt;] [size=&lt;container size&gt;]</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_software_raid_disks">6.6.4. Software RAID disks</h4>
<div class="listingblock">
<div class="content">
<pre>raiddisk &lt;devname&gt; &lt;size(bytes)&gt; &lt;partition label type&gt;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_multipath">6.6.5. Multipath</h4>
<div class="listingblock">
<div class="content">
<pre>multipath /dev/&lt;name&gt; &lt;size(B)&gt; &lt;partition label&gt; &lt;slave1,slave2,...&gt;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_physical_volumes">6.6.6. Physical Volumes</h4>
<div class="listingblock">
<div class="content">
<pre>lvmdev /dev/&lt;volume_group&gt; &lt;device&gt; [&lt;uuid&gt;] [&lt;size(bytes)&gt;]</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_volume_groups">6.6.7. Volume Groups</h4>
<div class="listingblock">
<div class="content">
<pre>lvmgrp &lt;volume_group&gt; &lt;extentsize&gt; [&lt;size(extents)&gt;] [&lt;size(bytes)&gt;]</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_logical_volumes">6.6.8. Logical Volumes</h4>
<div class="listingblock">
<div class="content">
<pre>lvmvol &lt;volume_group&gt; &lt;name&gt; &lt;size(bytes)&gt; &lt;layout&gt; [key:value ...]</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_luks_devices">6.6.9. LUKS Devices</h4>
<div class="listingblock">
<div class="content">
<pre>crypt /dev/mapper/&lt;name&gt; &lt;device&gt; [type=&lt;type&gt;] [cipher=&lt;cipher&gt;] [key_size=&lt;key size&gt;] [hash=&lt;hash function&gt;] [uuid=&lt;uuid&gt;] [keyfile=&lt;keyfile&gt;] [password=&lt;password&gt;]</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_drbd">6.6.10. DRBD</h4>
<div class="listingblock">
<div class="content">
<pre>drbd /dev/drbd&lt;nr&gt; &lt;drbd resource name&gt; &lt;device&gt;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_filesystems">6.6.11. Filesystems</h4>
<div class="listingblock">
<div class="content">
<pre>fs &lt;device&gt; &lt;mountpoint&gt; &lt;filesystem type&gt; [uuid=&lt;uuid&gt;] [label=&lt;label&gt;] [blocksize=&lt;block size(B)&gt;] [&lt;reserved_blocks=&lt;nr of reserved blocks&gt;] [max_mounts=&lt;nr&gt;] [check_interval=&lt;number of days&gt;d] [options=&lt;filesystem options&gt;]</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_btrfs_default_subvolumes">6.6.12. Btrfs Default SubVolumes</h4>
<div class="listingblock">
<div class="content">
<pre>btrfsdefaultsubvol &lt;device&gt; &lt;mountpoint&gt; &lt;btrfs_subvolume_ID&gt; &lt;btrfs_subvolume_path&gt;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_btrfs_normal_subvolumes">6.6.13. Btrfs Normal SubVolumes</h4>
<div class="listingblock">
<div class="content">
<pre>btrfsnormalsubvol &lt;device&gt; &lt;mountpoint&gt; &lt;btrfs_subvolume_ID&gt; &lt;btrfs_subvolume_path&gt;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_btrfs_mounted_subvolumes">6.6.14. Btrfs Mounted SubVolumes</h4>
<div class="listingblock">
<div class="content">
<pre>btrfsmountedsubvol &lt;device&gt; &lt;subvolume_mountpoint&gt; &lt;mount_options&gt; &lt;btrfs_subvolume_path&gt;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_swap">6.6.15. Swap</h4>
<div class="listingblock">
<div class="content">
<pre>swap &lt;device&gt; [uuid=&lt;uuid&gt;] [label=&lt;label&gt;]</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_hp_smartarray_controllers">6.6.16. HP SmartArray Controllers</h4>
<div class="listingblock">
<div class="content">
<pre>smartarray &lt;slot number&gt;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_hp_smartarray_logical_drives">6.6.17. HP SmartArray Logical Drives</h4>
<div class="listingblock">
<div class="content">
<pre>logicaldrive &lt;device&gt; &lt;slot nr&gt;|&lt;array name&gt;|&lt;logical drive name&gt; raid=&lt;raid level&gt; drives=&lt;drive1,drive2&gt; [spares=&lt;spare1,spare2&gt;] [sectors=&lt;sectors&gt;] [stripesize=&lt;stripe size&gt;]</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_tcg_opal_2_compliant_self_encrypting_disks">6.6.18. TCG Opal 2-compliant Self-Encrypting Disks</h4>
<div class="listingblock">
<div class="content">
<pre>opaldisk &lt;device&gt; [boot=&lt;[yn]&gt;] [password=&lt;password&gt;]</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_disk_restore_script_recover_mode">6.7. Disk Restore Script (recover mode)</h3>
<div class="paragraph">
<p>The /var/lib/rear/layout/disklayout.conf file is being used as input
during rear recover to create on-the-fly a script called /var/lib/rear/layout/diskrestore.sh.</p>
</div>
<div class="paragraph">
<p>When something goes wrong during the recreation of partitions, volume groups, &#8230;&#8203;
you will be thrown in edit mode and you can make the modification needed.
However, it is desirable to have a preview mode before doing the recovery
so you can review the diskrestore.sh script before doing any recovery.
It is better to find mistakes, obsolete arguments and so on before then later, right?</p>
</div>
<div class="paragraph">
<p>Gratien wrote a script to accomplish this (script is not part of ReaR)
and is meant for debugging reasons only.
For more details see <a href="http://www.it3.be/2016/06/08/rear-diskrestore/" class="bare">http://www.it3.be/2016/06/08/rear-diskrestore/</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tips_and_tricks_using_relax_and_recover">7. Tips and Tricks using Relax-and-Recover</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Recovering a system should not be a struggle against time with poor
tools weighing against you. Relax-and-Recover emphasizes on a relaxing
recovery, and for this it follows three distinct rules:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Do what is generally expected, if possible</p>
</li>
<li>
<p>In doubt, ask the operator or allow intervention</p>
</li>
<li>
<p>Provide an environment that is as convenient as possible</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This results in the following useful tips and tricks:</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Relax-and-Recover can add its own GRUB menu entry to your local system&#8217;s
GRUB, which is convenient to restore a system without the need for an
additional boot media. This only works if your system can (still)
boot from the local disk and the disaster didn&#8217;t destroy that disk.</p>
</li>
<li>
<p>Relax-and-Recover automatically detects and enables serial console support.
This is extremely useful if the only way to access the console during
disaster is a Java-based console riddled with keyboard bugs and slow screen
refreshes.</p>
</li>
<li>
<p>Relax-and-Recover conveniently ships with a set of useful commands in its
shell history. This makes it possible to quickly look for a command to help
troubleshoot, or modify an important file during recovery.</p>
</li>
<li>
<p>If you have keyboard problems using a HP iLO 2 Remote Console, type the
following command loadkeys -d (or simply use the up arrow key to get
this command from your shell history).</p>
</li>
<li>
<p>If the original system was configured to log on remotely through the use
of SSH keys, Relax-and-Recover preserved those keys on the rescue
environment and you can access the rescue environment from the network
as you were used to before.</p>
</li>
<li>
<p>During recovery at any stage you can re-run Relax-and-Recover, modify
the layout file for recreating the structure and intervene when restoring
the backup.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_troubleshooting_relax_and_recover">8. Troubleshooting Relax-and-Recover</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you encounter a problem, you may find more information in the log file
which is located at <em>/var/log/rear/rear-system.log</em>. During recovery the backup
log file is also available from <em>/var/log/rear/</em>, for your convenience the
history in rescue mode comes with useful commands for debugging, use the up
arrow key in the shell to find those commands.</p>
</div>
<div class="paragraph">
<p>There are a few options in Relax-and-Recover to help you debug the situation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>use the -v option to show progress output during execution</p>
</li>
<li>
<p>use the -d option to have debug information in your log file</p>
</li>
<li>
<p>use the -s option to see what scripts Relax-and-Recover would be using;
this is useful to understand how Relax-and-Recover is working internally</p>
</li>
<li>
<p>use the -S option to step through each individual script when
troubleshooting</p>
</li>
<li>
<p>use the -D option to dump every function call to log file; this is very
convenient during development or when troubleshooting Relax-and-Recover</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_during_backup">8.1. During backup</h3>
<div class="paragraph">
<p>During backup Relax-and-Recover creates a description of your system layout
in one file (<em>disklayout.conf</em>) and stores this as part of its rescue image.
This file describes the configuration of SmartArray RAID, partitions,
software RAID, DRBD, logical volumes, filesystems, and possibly more.</p>
</div>
<div class="paragraph">
<p>Here is a list of known issues during backup:</p>
</div>
<div class="qlist qanda">
<ol>
<li>
<p><em>One or more HP SmartArray controllers have errors</em></p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Relax-and-Recover had detected that one of your HP SmartArray controllers is
in ERROR state and as a result it can not trust the information returned from
that controller. This can be dangerous because we cannot guarantee that the
disk layout is valid when recovering the system.</p>
</div>
<div class="paragraph">
<p>We discovered that this problem can be caused by a controller that still
has information in its cache that has not been flushed and the only way to
solve it was to reboot the system and pressing F2 during the controller
initialization when it reports this problem.</p>
</div>
</div>
</div>
</li>
<li>
<p><em>USB sticks disappear and re-appear with difference device name</em></p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>We have had issues before with a specific batch of JetFlash USB sticks
which, during write operations, reset the USB controller because of a bug
in the Linux kernel. The behavior is that the device disappears (during
write operations!) and reappears with a different device name. The result
is that the filesystem becomes corrupt and the stick cannot be used.</p>
</div>
<div class="paragraph">
<p>To verify if the USB stick has any issues like this, we recommend using
the f3 tool on Linux or the h2testw tool on Windows. If this tool
succeeds in a write and verify test, the USB stick is reliable.</p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_during_recovery">8.2. During recovery</h3>
<div class="paragraph">
<p>During restore Relax-and-Recover uses the saved system layout as the basis for
recreating a workable layout on your new system. If your new hardware is very
different, it&#8217;s advised to copy the layout file
<em>/var/lib/rear/layout/disklayout.conf</em> to <em>/etc/rear</em> and modify it according
to what is required.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cp /var/lib/rear/layout/disklayout.conf /etc/rear/
vi /etc/rear/disklayout.conf</pre>
</div>
</div>
<div class="paragraph">
<p>Then restart the recovery process: rear recover</p>
</div>
<div class="paragraph">
<p>During the recovery process, Relax-and-Recover translates this layout file
into a shell procedure (<em>/var/lib/rear/layout/diskrestore.sh</em>) that contains
all the needed instructions for recreating your desired layout.</p>
</div>
<div class="paragraph">
<p>If Relax-and-Recover comes across irreconcilable differences, it provides you
with a small menu of options you have. In any case you can Abort the menu, and
retry after cleaning up everything Relax-and-Recover may already have done, incl.
mdadm --stop --scan or vgchange -a n.</p>
</div>
<div class="paragraph">
<p>In any case, you will have to look into the issue, see what goes wrong and
either fix the layout file (<em>disklayout.conf</em>) and restart the recovery
process (rear recover) or instead fix the shell procedure (<em>diskrestore.sh</em>)
and choose Retry.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Customizations to the shell procedure (<em>diskrestore.sh</em>) get
         lost when restarting rear recover.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is a list of known issues during recovery:</p>
</div>
<div class="qlist qanda">
<ol>
<li>
<p><em>Failed to clear HP SmartArray controller 1</em></p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>This error may be caused by trying to clear an HP SmartArray controller
that does not have a configuration or does not exist. Since we have no
means to know whether this is a fatal condition or not we simply try to
recreate the logical drive(s) and see what happens.</p>
</div>
<div class="paragraph">
<p>This message is harmless, but may help troubleshoot the subsequent error
message.</p>
</div>
</div>
</div>
</li>
<li>
<p><em>An error has been detected during restore</em></p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>The (generated) layout restore script <em>/var/lib/rear/layout/diskrestore.sh</em>
was not able to perform all necessary steps without error. The system will
provide you with a menu allowing you to fix the <em>diskrestore.sh</em> script
manually and continue from where it left off.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Cannot create array. Cannot add physical drive 2I:1:5
Could not configure the HP SmartArray controllers</pre>
</div>
</div>
<div class="paragraph">
<p>When the number of physical or logical disks are different, or when other
important system characteristics that matter to recovery are incompatible,
this will be indicated by a multitude of possible error-messages.
Relax-and-Recover makes it possible to recover also in these cases by hand.</p>
</div>
<div class="paragraph">
<p>You can find more information about your HP SmartArray setup by running one of
the following commands:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># hpacucli ctrl all show detail
# hpacucli ctrl all show config
# hpacucli ctrl all show config detail</pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
You can find these commands as part of the history of the
Relax-and-Recover shell.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_design_concepts_2">9. Design concepts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Schlomo Schapiro, Gratien D&#8217;haese, Dag Wieers</p>
</div>
<div class="sect2">
<h3 id="_the_workflow_system">9.1. The Workflow System</h3>
<div class="paragraph">
<p>Relax-and-Recover is built as a modular framework. A call of rear &lt;command&gt;
will invoke the following general workflow:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Configuration:</strong> Collect system information to assemble a correct
configuration (default, arch, OS, OS_ARCH, OS_VER, site, local).
See the output of rear dump for an example.
+
Read config files for the combination of system attributes. Always
read 'default.conf' first and 'site.conf', 'local.conf' last.</p>
</li>
<li>
<p>Create work area in '/tmp/rear.$$/' and start logging to
'/var/log/rear/rear-hostname.log'</p>
</li>
<li>
<p>Run the workflow script for the specified command:
'/usr/share/rear/lib/&lt;command&gt;-workflow.sh'</p>
</li>
<li>
<p>Cleanup work area</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_workflow_make_rescue_media">9.2. Workflow - Make Rescue Media</h3>
<div class="paragraph">
<p>The application will have the following general workflow which is represented
by appropriately named scripts in various subdirectories:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Prep:</strong> Prepare the build area by copying a skeleton filesystem layout.
This can also come from various sources (FS layout for arch, OS, OS_VER,
Backup-SW, Output, &#8230;&#8203;)</p>
</li>
<li>
<p><strong>Analyse disklayout</strong>: Analyse the system disklayout to create the '/var/lib/rear/layout/' data</p>
</li>
<li>
<p><strong>Analyse (Rescue):</strong> Analyse the system to create the rescue system
(network, binary dependencies, &#8230;&#8203;)</p>
</li>
<li>
<p><strong>Build:</strong> Build the rescue image by copying together everything required</p>
</li>
<li>
<p><strong>Pack:</strong> Package the kernel and initrd image together</p>
</li>
<li>
<p><strong>Backup:</strong> (Optionally) run the backup software to create a current backup</p>
</li>
<li>
<p><strong>Output:</strong> Copy / Install the rescue system (kernel+initrd+(optionally)
backups) into the target environment (e.g. PXE boot, write on tape,
write on CD/DVD)</p>
</li>
<li>
<p><strong>Cleanup:</strong> Cleanup the build area from temporary files</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The configuration must define the BACKUP and OUTPUT methods. Valid choices are:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NAME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement in Phase</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AVA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dell EMC Avamar / EMC Avamar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACULA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bacula</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BAREOS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bareos</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BLOCKCLONE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Block device cloning via dd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BORG</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Borg Backup</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CDM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rubrik Cloud Data Management</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OpenText Data Protector</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DUPLICITY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duplicity / Duply</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXTERNAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">External custom restore method</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FDRUPSTREAM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FDR/Upstream</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GALAXY11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Commvault Galaxy 11 / Commvault Simpana</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NBKDC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NovaStor DataCenter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NBU</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Veritas NetBackup / Symantec NetBackup</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NETFS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ReaR built-in backup and restore via rsync or tar to a network file system or to a locally attached backup disk (USB, eSATA, &#8230;&#8203;)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NFS4SERVER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NFS4 server to push data to the rescue system</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NSR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dell EMC NetWorker / EMC NetWorker / Legato NetWorker</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OBDR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One Button Disaster Recovery via tape</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PPDM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dell PowerProtect Data Manager</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RBME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rsync Backup Made Easy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REQUESTRESTORE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request restore from a human operator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RSYNC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ReaR built-in backup using rsync via rsync or ssh protocol</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SESAM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SEP Sesam</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TSM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IBM Storage Protect / Tivoli Storage Manager / IBM Spectrum Protect</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VEEAM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BACKUP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Veeam Backup</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ISO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OUTPUT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write result to ISO9660 image</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OBDR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OUTPUT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create OBDR Tape</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PXE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OUTPUT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create PXE bootable files on TFTP server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">USB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OUTPUT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create bootable USB device</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">done</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_workflow_recovery">9.3. Workflow - Recovery</h3>
<div class="paragraph">
<p>The result of the analysis is written into configuration files under
'/etc/rear/recovery/'. This directory is copied together with the other
Relax-and-Recover directories onto the rescue system where the same
framework runs a different workflow - the recovery workflow.</p>
</div>
<div class="paragraph">
<p>The recovery workflow consists of these parts (identically named modules
are indeed the same):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Config:</strong> By utilizing the same configuration module, the same
configuration variable are available for the recovery, too.
This makes writing pairs of backup/restore modules much easier.</p>
</li>
<li>
<p><strong>Verify:</strong> Verify the integrity and sanity of the recovery data and
check the hardware found to determine, whether a recovery will be
likely to succeed. If not, then we abort the workflow so as not to
touch the hard disks if we don&#8217;t believe that we would manage to
successfully recover the system on this hardware.</p>
</li>
<li>
<p><strong>Recreate:</strong> Recreate the FS layout (partitioning, LVM, raid,
filesystems, &#8230;&#8203;) and mount it under /mnt/local</p>
</li>
<li>
<p><strong>Restore:</strong> Restore files and directories from the backup to '/mnt/local/'.
This module is the analog to the Backup module</p>
</li>
<li>
<p><strong>Finalize:</strong> Install boot loader, finalize system, dump recovery log
onto '/var/log/rear/' in the recovered system.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_fs_layout">9.4. FS layout</h3>
<div class="paragraph">
<p>Relax-and-Recover tries to be as much LSB compliant as possible. Therefore ReaR will be
installed into the usual locations:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">/etc/rear/</dt>
<dd>
<p>Configurations</p>
</dd>
<dt class="hdlist1">/usr/sbin/rear</dt>
<dd>
<p>Main program</p>
</dd>
<dt class="hdlist1">/usr/share/rear/</dt>
<dd>
<p>Internal scripts</p>
</dd>
<dt class="hdlist1">/tmp/rear.$$/</dt>
<dd>
<p>Build area</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="_layout_of_etcrear">9.4.1. Layout of /etc/rear</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">default.conf</dt>
<dd>
<p>Default configuration - will define EVERY variable with a sane default
setting. Serves also as a reference for the available variables 'site.conf'
site wide configuration (optional)</p>
</dd>
<dt class="hdlist1">local.conf</dt>
<dd>
<p>local machine configuration (optional)</p>
</dd>
<dt class="hdlist1">$(uname -s)-$(uname -i).conf</dt>
<dd>
<p>architecture specific configuration (optional)</p>
</dd>
<dt class="hdlist1">$(uname -o).conf</dt>
<dd>
<p>OS system (e.g. GNU/Linux.conf) (optional)</p>
</dd>
<dt class="hdlist1">$OS/$OS_VER.conf</dt>
<dd>
<p>OS and OS Version specific configuration (optional)</p>
</dd>
<dt class="hdlist1">templates/</dt>
<dd>
<p>Directory to keep user-changeable templates for various files used
or generated</p>
</dd>
<dt class="hdlist1">templates/PXE_per_node_config</dt>
<dd>
<p>template for pxelinux.cfg per-node configurations</p>
</dd>
<dt class="hdlist1">templates/CDROM_isolinux.cfg</dt>
<dd>
<p>isolinux.cfg template</p>
</dd>
<dt class="hdlist1">templates/&#8230;&#8203;</dt>
<dd>
<p>other templates as the need arises</p>
</dd>
<dt class="hdlist1">recovery/&#8230;&#8203;</dt>
<dd>
<p>Recovery information</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_layout_of_usrsharerear">9.4.2. Layout of /usr/share/rear</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">skel/default/</dt>
<dd>
<p>default rescue FS skeleton</p>
</dd>
<dt class="hdlist1">skel/$(uname -i)/</dt>
<dd>
<p>arch specific rescue FS skeleton (optional)</p>
</dd>
<dt class="hdlist1">skel/$OS_$OS_VER/</dt>
<dd>
<p>OS-specific rescue FS skeleton (optional)</p>
</dd>
<dt class="hdlist1">skel/$BACKUP/</dt>
<dd>
<p>Backup-SW specific rescue FS skeleton (optional)</p>
</dd>
<dt class="hdlist1">skel/$OUTPUT/</dt>
<dd>
<p>Output-Method specific rescue FS skeleton (optional)</p>
</dd>
<dt class="hdlist1">lib/*.sh</dt>
<dd>
<p>function definitions, split into files by their topic</p>
</dd>
<dt class="hdlist1">prep/default/*.sh</dt>
<dt class="hdlist1">prep/$(uname -i)/*.sh</dt>
<dt class="hdlist1">prep/$OS_$OS_VER/*.sh</dt>
<dt class="hdlist1">prep/$BACKUP/*.sh</dt>
<dt class="hdlist1">prep/$OUTPUT/*.sh</dt>
<dd>
<p>Prep scripts. The scripts get merged from the applicable directories
and executed in their alphabetical order. Naming conventions are:
+
<mark>_name.sh
+
where 00 &lt; </mark> &lt; 99</p>
</dd>
<dt class="hdlist1">layout/compare/default/</dt>
<dt class="hdlist1">layout/compare/$OS_$OS_VER/</dt>
<dd>
<p>Scripts to compare the saved layout (under /var/lib/rear/layout/) with the actual situation. This is used by workflow <strong>rear checklayout</strong> and may trigger a new run of <strong>rear mkrescue</strong> or <strong>rear mkbackup</strong></p>
</dd>
<dt class="hdlist1">layout/precompare/default/</dt>
<dt class="hdlist1">layout/precompare/$OS_$OS_VER/</dt>
<dt class="hdlist1">layout/prepare/default/</dt>
<dt class="hdlist1">layout/prepare/$OS_$OS_VER/</dt>
<dt class="hdlist1">layout/recreate/default/</dt>
<dt class="hdlist1">layout/recreate/$OS_$OS_VER/</dt>
<dt class="hdlist1">layout/save/default/</dt>
<dt class="hdlist1">layout/save/$OS_$OS_VER/</dt>
<dd>
<p>Scripts to capture the disk layout and write it into /var/lib/rear/layout/ directory</p>
</dd>
<dt class="hdlist1">rescue/&#8230;&#8203;</dt>
<dd>
<p>Analyse-Rescue scripts: &#8230;&#8203;</p>
</dd>
<dt class="hdlist1">build/&#8230;&#8203;</dt>
<dd>
<p>Build scripts: &#8230;&#8203;</p>
</dd>
<dt class="hdlist1">pack/&#8230;&#8203;</dt>
<dd>
<p>Pack scripts: &#8230;&#8203;</p>
</dd>
<dt class="hdlist1">backup/$BACKUP/*.sh</dt>
<dd>
<p>Backup scripts: &#8230;&#8203;</p>
</dd>
<dt class="hdlist1">output/$OUTPUT/*.sh</dt>
<dd>
<p>Output scripts: &#8230;&#8203;</p>
</dd>
<dt class="hdlist1">verify/&#8230;&#8203;</dt>
<dd>
<p>Verify the recovery data against the hardware found, whether we can
successfully recover the system</p>
</dd>
<dt class="hdlist1">recreate/&#8230;&#8203;</dt>
<dd>
<p>Recreate file systems and their dependencies</p>
</dd>
<dt class="hdlist1">restore/$BACKUP/&#8230;&#8203;</dt>
<dd>
<p>Restore data from backup media</p>
</dd>
<dt class="hdlist1">finalize/&#8230;&#8203;</dt>
<dd>
<p>Finalization scripts</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_inter_module_communication">9.5. Inter-module communication</h3>
<div class="paragraph">
<p>The various stages and modules communicate via standardized environment variables:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NAME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Descriptions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Example</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CONFIG_DIR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">STRING (RO)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration dir</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">'/etc/rear/'</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SHARE_DIR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">STRING (RO)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shared data dir</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">'/usr/share/rear/'</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BUILD_DIR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">STRING (RO)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Build directory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">'/tmp/rear.$$/'</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ROOTFS_DIR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">STRING (RO)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Root FS directory for rescue system</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">'/tmp/rear.$$/initrd/'</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TARGET_FS_ROOT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">STRING (RO)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Directory for restore</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">'/mnt/local'</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PROGS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LIST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Program files to copy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bash ip route grep ls &#8230;&#8203;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MODULES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LIST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Modules to copy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">af_unix e1000 ide-cd &#8230;&#8203;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">COPY_AS_IS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LIST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Files (with path) to copy as-is</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">'/etc/localtime' &#8230;&#8203;</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>RO means that the framework manages this variable and modules and methods shouldn&#8217;t change it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_major_changes_compared_with_mkcdrec">9.6. Major changes compared with mkCDrec</h3>
<div class="ulist">
<ul>
<li>
<p>No Makefiles</p>
</li>
<li>
<p>Major script called xxx that arranges all</p>
</li>
<li>
<p>Simplify the testing and configuration</p>
</li>
<li>
<p>Being less verbose</p>
</li>
<li>
<p>Better control over echo to screen, log file or debugging</p>
</li>
<li>
<p>Less color</p>
</li>
<li>
<p>Easier integration with third party software (GPL or commercial)</p>
</li>
<li>
<p>Modular and plug-ins should be easy for end-users</p>
</li>
<li>
<p>Better documentation for developers</p>
</li>
<li>
<p>Cut the overhead - less is better</p>
</li>
<li>
<p>Less choices (&#8658; less errors)</p>
</li>
<li>
<p><strong>mkCDrec project is obsolete</strong></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_integrating_external_backup_programs_into_rear">10. Integrating external backup programs into ReaR</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Relax-and-Recover can be used only to restore the disk layout of your system and boot loader. However, that means you are responsible for taking backups. And, more important, to restore these before you reboot recovered system.</p>
</div>
<div class="paragraph">
<p>However, we have successfully already integrated external backup programs within ReaR, such as Netbackup, EMC NetWorker, Tivoli Storage Manager, Data Protetctor to name a few commercial backup programs. Furthermore, open source external backup programs which are also working with ReaR are Bacula, Bareos, Duplicity and Borg to name the most known ones.</p>
</div>
<div class="paragraph">
<p>Ah, my backup program which is the best of course, is not yet integrated within ReaR. How shall we proceed to make your backup program working with ReaR? This is a step by step approach.</p>
</div>
<div class="paragraph">
<p>The work-flow <code>mkrescue</code> is the only needed as <code>mkbackup</code> will not create any backup as it is done outside ReaR anyhow. Very important to know.</p>
</div>
<div class="sect2">
<h3 id="_think_before_coding">10.1. Think before coding</h3>
<div class="paragraph">
<p>Well, what does this mean? Is my backup program capable of making full backups of my root disks, including ACLs? And, as usual, did we test a restore of a complete system already? Can we do a restore via the command line, or do we need a graphical user interface to make this happen?
If the CLI approach is working then this would be the preferred manor for ReaR. If on the other hand only GUI approach is possible, then can you initiate a push from the media server instead of the pull method (which we could program within ReaR)?</p>
</div>
<div class="paragraph">
<p>So, most imprtant things to remember here are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CLI - preferred method (and far the easiest one to integrate within ReaR) - pull method</p>
</li>
<li>
<p>GUI - as ReaR has no X Windows available (only command line) we cannot use the GUI within ReaR, however, GUI is still possible from another system (media server or backup server) and push out the restore to the recovered system. This method is similar to the REQUESTRESTORE BACKUP method.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>What does ReaR need to have on board before we can initiate a restore from your backup program?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the executables (and libraries) from your backup program (only client related)</p>
</li>
<li>
<p>configuration files required by above executables?</p>
</li>
<li>
<p>most likely you need the manuals a bit to gather some background information of your backup program around its minimum requirements</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_steal_code_from_previous_backup_integrations">10.2. Steal code from previous backup integrations</h3>
<div class="paragraph">
<p>Do not make your life too difficult by re-invented the wheel. Have a look at existing integrations. How?</p>
</div>
<div class="paragraph">
<p>Start with the default configuration file of ReaR:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cd /usr/share/rear/conf
$ grep -r NBU *
default.conf:# BACKUP=NBU stuff (Symantec/Veritas NetBackup)
default.conf:COPY_AS_IS_NBU=( /usr/openv/bin/vnetd /usr/openv/bin/vopied /usr/openv/lib /usr/openv/netbackup /usr/openv/var/auth/[mn]*.txt )
default.conf:COPY_AS_IS_EXCLUDE_NBU=( "/usr/openv/netbackup/logs/*" "/usr/openv/netbackup/bin/bpjava*" "/usr/openv/netbackup/bin/xbp" )
default.conf:PROGS_NBU=( )</pre>
</div>
</div>
<div class="paragraph">
<p>What does this learn you?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>you need to define a backup method name, e.g. <code>BACKUP=NBU</code> (must be unique within ReaR!)</p>
</li>
<li>
<p>define some new variables to automatically copy executables into the ReaR rescue image, and one to exclude stuff which is not required by the recovery (this means you have to play with it and fine-tune it)</p>
</li>
<li>
<p>finally, define a place holder array for your backup programs (is empty to start with).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now, you have defined a new BACKUP scheme name, right? As an example take the name BURP (<a href="http://burp.grke.org/" class="bare">http://burp.grke.org/</a>).</p>
</div>
<div class="paragraph">
<p>Define in /usr/share/rear/conf/default:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># BACKUP=BURP section (Burp program stuff)
COPY_AS_IS_BURP=( )
COPY_AS_IS_EXCLUDE_BURP=( )
PROGS_BURP=( )</pre>
</div>
</div>
<div class="paragraph">
<p>Of course, the tricky part is what should above arrays contain? That you should already know as that was part of the first task (<strong>Think before coding</strong>).</p>
</div>
<div class="paragraph">
<p>This is only the start of learning what others have done before:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cd /usr/share/rear
$ find . -name NBU
./finalize/NBU
./prep/NBU
./rescue/NBU
./restore/NBU
./skel/NBU
./verify/NBU</pre>
</div>
</div>
<div class="paragraph">
<p>What does this mean? Well, these are directories created for Netbackup and beneath these directories are scripts that will be included during the <code>mkrescue</code> and <code>recover</code> work-flows.</p>
</div>
<div class="paragraph">
<p>Again, think burp, and you probably also need these directories to be created:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ mkdir --mode=755 /usr/share/rear/{finalize,prep,rescue,restore,verify}/BURP</pre>
</div>
</div>
<div class="paragraph">
<p>Another easy trick is to look at the existing scripts of NBU (as a starter):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sudo rear -s mkrescue | grep NBU
Source prep/NBU/default/400_prep_nbu.sh
Source prep/NBU/default/450_check_nbu_client_configured.sh
Source rescue/NBU/default/450_prepare_netbackup.sh
Source rescue/NBU/default/450_prepare_xinetd.sh</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sudo rear -s recover | grep NBU
Source verify/NBU/default/380_request_client_destination.sh
Source verify/NBU/default/390_request_point_in_time_restore_parameters.sh
Source verify/NBU/default/400_verify_nbu.sh
Source restore/NBU/default/300_create_nbu_restore_fs_list.sh
Source restore/NBU/default/400_restore_with_nbu.sh
Source finalize/NBU/default/990_copy_bplogrestorelog.sh</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_multiple_backups_for_relax_and_recover">11. Using Multiple Backups for Relax-and-Recover</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_basics">11.1. Basics</h3>
<div class="paragraph">
<p>Currently multiple backups are only supported for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the internal BACKUP=NETFS method with BACKUP_TYPE=""</p>
</li>
<li>
<p>the internal BACKUP=BLOCKCLONE method</p>
</li>
<li>
<p>the external BACKUP=BORG method</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In general multiple backups are not supported for
BACKUP_TYPE=incremental or BACKUP_TYPE=differential
because those require special backup archive file names.</p>
</div>
<div class="sect3">
<h4 id="_the_basic_idea_behind">11.1.1. The basic idea behind</h4>
<div class="paragraph">
<p>A "rear mkbackup" run can be split into
a "rear mkrescue" run plus a "rear mkbackuponly" run
and the result is still the same.</p>
</div>
<div class="paragraph">
<p>Accordingly "rear mkbackup" can be split into
a single "rear mkrescue" plus multiple "rear mkbackuponly"
where each particular "rear mkbackuponly" backups only a
particular part of the files of the system, for example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a backup of the files of the basic system</p>
</li>
<li>
<p>a backup of the files in the /home directories</p>
</li>
<li>
<p>a backup of the files in the /opt directory</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Multiple "rear mkbackuponly" require that each particular
"rear mkbackuponly" uses a specific ReaR configuration file
that specifies how that particular "rear mkbackuponly" must be done.</p>
</div>
<div class="paragraph">
<p>Therefore the '-C' command line parameter is needed where
an additional ReaR configuration file can be specified.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_basic_way_how_to_create_multiple_backups">11.1.2. The basic way how to create multiple backups</h4>
<div class="paragraph">
<p>Have common settings in /etc/rear/local.conf</p>
</div>
<div class="paragraph">
<p>For each particular backup specify its parameters in
separated additional configuration files like</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/etc/rear/basic_system.conf
/etc/rear/home_backup.conf
/etc/rear/opt_backup.conf</pre>
</div>
</div>
<div class="paragraph">
<p>First create the ReaR recovery/rescue system ISO image
together with a backup of the files of the basic system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>rear -C basic_system mkbackup</pre>
</div>
</div>
<div class="paragraph">
<p>Then backup the files in the /home directories:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>rear -C home_backup mkbackuponly</pre>
</div>
</div>
<div class="paragraph">
<p>Afterwards backup the files in the /opt directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>rear -C opt_backup mkbackuponly</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_basic_way_how_to_recover_with_multiple_backups">11.1.3. The basic way how to recover with multiple backups</h4>
<div class="paragraph">
<p>The basic idea how to recover with multiple backups is
to split the "rear recover" into an initial recovery
of the basic system followed by several backup restore
operations as follows:</p>
</div>
<div class="paragraph">
<p>Boot the ReaR recovery/rescue system.</p>
</div>
<div class="paragraph">
<p>In the ReaR recovery/rescue system do the following:</p>
</div>
<div class="paragraph">
<p>First recover the basic system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>rear -C basic_system recover</pre>
</div>
</div>
<div class="paragraph">
<p>Then restore the files in the /home directories:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>rear -C home_backup restoreonly</pre>
</div>
</div>
<div class="paragraph">
<p>Afterwards restore the files in the /opt directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>rear -C opt_backup restoreonly</pre>
</div>
</div>
<div class="paragraph">
<p>Finally reboot the recreated system.</p>
</div>
<div class="paragraph">
<p>For more internal details and some background information see
<a href="https://github.com/rear/rear/issues/1088" class="bare">https://github.com/rear/rear/issues/1088</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_relax_and_recover_setup_for_multiple_backups">11.2. Relax-and-Recover Setup for Multiple Backups</h3>
<div class="paragraph">
<p>Assume for example multiple backups should be done
using the NETFS backup method with 'tar' as backup program
to get separated backups for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the files of the basic system</p>
</li>
<li>
<p>the files in the /home directories</p>
</li>
<li>
<p>the files in the /opt directory</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Those four configuration files could be used:</p>
</div>
<div class="listingblock">
<div class="title">/etc/rear/local.conf</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">OUTPUT=ISO
BACKUP=NETFS
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://your.NFS.server.IP/path/to/your/rear/backup</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/etc/rear/basic_system.conf</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">this_file_name=$( basename ${BASH_SOURCE[0]} )
LOGFILE="$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-${this_file_name%.*}.log"
BACKUP_PROG_EXCLUDE+=( '/home/*' '/opt/*' )
BACKUP_PROG_ARCHIVE="backup-${this_file_name%.*}"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/etc/rear/home_backup.conf</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">this_file_name=$( basename ${BASH_SOURCE[0]} )
LOGFILE="$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-${this_file_name%.*}.log"
BACKUP_ONLY_INCLUDE="yes"
BACKUP_PROG_INCLUDE=( '/home/*' )
BACKUP_PROG_ARCHIVE="backup-${this_file_name%.*}"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/etc/rear/opt_backup.conf</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">this_file_name=$( basename ${BASH_SOURCE[0]} )
LOGFILE="$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-${this_file_name%.*}.log"
BACKUP_ONLY_INCLUDE="yes"
BACKUP_PROG_INCLUDE=( '/opt/*' )
BACKUP_PROG_ARCHIVE="backup-${this_file_name%.*}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The BACKUP_ONLY_INCLUDE setting is described in conf/default.conf.</p>
</div>
<div class="paragraph">
<p>With those config files creating the ReaR recovery/rescue system ISO image
and subsequently backup the files of the system could be done like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>rear mkrescue
rear -C basic_system mkbackuponly
rear -C home_backup mkbackuponly
rear -C opt_backup mkbackuponly</pre>
</div>
</div>
<div class="paragraph">
<p>Recovery of that system could be done by calling in the
ReaR recovery/rescue system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>rear -C basic_system recover
rear -C home_backup restoreonly
rear -C opt_backup restoreonly</pre>
</div>
</div>
<div class="paragraph">
<p>Note that system recovery with multiple backups requires that
first and foremost the basic system is recovered where all files
must be restored that are needed to install the bootloader and
to boot the basic system into a normal usable state.</p>
</div>
<div class="paragraph">
<p>Nowadays systemd usually needs files in the /usr directory
so that in practice in particular all files in the /usr directory
must be restored during the initial basic system recovery
plus whatever else is needed to boot and run the basic system.</p>
</div>
<div class="paragraph">
<p>Multiple backups cannot be used to split the files of the basic system
into several backups. The files of the basic system must be in one
single backup and that backup must be restored during the initial
recovery of the basic system.</p>
</div>
</div>
<div class="sect2">
<h3 id="_relax_and_recover_setup_for_different_backup_methods">11.3. Relax-and-Recover Setup for Different Backup Methods</h3>
<div class="paragraph">
<p>Because multiple backups are used via separated additional
configuration files, different backup methods can be used.</p>
</div>
<div class="paragraph">
<p>Assume for example multiple backups should be used to get
separated backups for the files of the basic system
using the NETFS backup method with 'tar' as backup program
and to backup the files in the /home directory
using the BORG backup method.</p>
</div>
<div class="paragraph">
<p>The configuration files could be like the following:</p>
</div>
<div class="listingblock">
<div class="title">/etc/rear/local.conf</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">OUTPUT=ISO
REQUIRED_PROGS+=( borg locale )
COPY_AS_IS+=( "/borg/keys" )</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/etc/rear/basic_system.conf</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">this_file_name=$( basename ${BASH_SOURCE[0]} )
LOGFILE="$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-${this_file_name%.*}.log"
BACKUP_PROG_EXCLUDE+=( '/home/*' )
BACKUP_PROG_ARCHIVE="backup-${this_file_name%.*}"
BACKUP=NETFS
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://your.NFS.server.IP/path/to/your/rear/backup</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/etc/rear/home_backup.conf</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">this_file_name=$( basename ${BASH_SOURCE[0]} )
LOGFILE="$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-${this_file_name%.*}.log"
BACKUP=BORG
BACKUP_ONLY_INCLUDE="yes"
BACKUP_PROG_INCLUDE=( '/home/*' )
BORGBACKUP_ARCHIVE_PREFIX="rear"
BORGBACKUP_HOST="borg.server.name"
BORGBACKUP_USERNAME="borg_server_username"
BORGBACKUP_REPO="/path/to/borg/repository/on/borg/server"
BORGBACKUP_PRUNE_KEEP_HOURLY=5
BORGBACKUP_PRUNE_KEEP_WEEKLY=2
BORGBACKUP_COMPRESSION="zlib,9"
BORGBACKUP_ENC_TYPE="keyfile"
export BORG_KEYS_DIR="/borg/keys"
export BORG_CACHE_DIR="/borg/cache"
export BORG_PASSPHRASE='a1b2c3_d4e5f6'
export BORG_RELOCATED_REPO_ACCESS_IS_OK="yes"
export BORG_UNKNOWN_UNENCRYPTED_REPO_ACCESS_IS_OK="yes"
export BORG_REMOTE_PATH="/usr/local/bin/borg"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using different backup methods requires to get all the binaries
and all other needed files of all used backup methods into the
ReaR recovery/rescue system during "rear mkbackup/mkrescue".</p>
</div>
<div class="paragraph">
<p>Those binaries and other needed files must be manually specified
via REQUIRED_PROGS and COPY_AS_IS in /etc/rear/local.conf
(regarding REQUIRED_PROGS and COPY_AS_IS see conf/default.conf).</p>
</div>
<div class="paragraph">
<p>With those config files creating the ReaR recovery/rescue system ISO image
together with a 'tar' backup of the files of the basic system and
a separated Borg backup of the files in /home could be done like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>rear -C home_backup mkbackuponly
rear -C basic_system mkbackup</pre>
</div>
</div>
<div class="paragraph">
<p>In contrast to the other examples above the Borg backup is run first
because Borg creates encryption keys during repository initialization.
This ensures the right /borg/keys is created before it will be copied into
the ReaR recovery/rescue system by the subsequent "rear mkbackup/mkrescue".
Alternatively the ReaR recovery/rescue system could be created again
after the Borg backup is done like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>rear -C basic_system mkbackup
rear -C home_backup mkbackuponly
rear -C basic_system mkrescue</pre>
</div>
</div>
<div class="paragraph">
<p>Recovery of that system could be done by calling in the
ReaR recovery/rescue system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>rear -C basic_system recover
rear -C home_backup restoreonly</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_running_multiple_backups_and_restores_in_parallel">11.4. Running Multiple Backups and Restores in Parallel</h3>
<div class="paragraph">
<p>When the files in multiple backups are separated from each other
it should work to run multiple backups or multiple restores in parallel.</p>
</div>
<div class="paragraph">
<p>Whether or not that actually works in your particular case
depends on how you made the backups in your particular case.</p>
</div>
<div class="paragraph">
<p>For sufficiently well separated backups it should work
to run multiple different</p>
</div>
<div class="listingblock">
<div class="content">
<pre>rear -C backup_config mkbackuponly</pre>
</div>
</div>
<div class="paragraph">
<p>or multiple different</p>
</div>
<div class="listingblock">
<div class="content">
<pre>rear -C backup_config restoreonly</pre>
</div>
</div>
<div class="paragraph">
<p>in parallel.</p>
</div>
<div class="paragraph">
<p>Running in parallel is only supported for mkbackuponly and restoreonly.</p>
</div>
<div class="paragraph">
<p>For example like</p>
</div>
<div class="listingblock">
<div class="content">
<pre>rear -C backup1 mkbackuponly &amp; rear -C backup2 mkbackuponly &amp; wait</pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre>rear -C backup1 restoreonly &amp; rear -C backup2 restoreonly &amp; wait</pre>
</div>
</div>
<div class="paragraph">
<p>ReaR&#8217;s default logging is not prepared for multiple simultaneous runs
and also ReaR&#8217;s current progress subsystem is not prepared for that.
On the terminal the messages from different simultaneous runs are
indistinguishable and the current progress subsystem additionally
outputs subsequent messages on one same line which results
illegible and meaningless output on the terminal.</p>
</div>
<div class="paragraph">
<p>Therefore additional parameters must be set to make ReaR&#8217;s messages
and the progress subsystem output appropriate for parallel runs.</p>
</div>
<div class="paragraph">
<p>Simultaneously running ReaR workflows require unique messages and
unique logfile names.</p>
</div>
<div class="paragraph">
<p>Therefore the PID ('$$') is specified to be used as message prefix
for all ReaR messages and it is also added to the LOGFILE value.</p>
</div>
<div class="paragraph">
<p>The parameters MESSAGE_PREFIX PROGRESS_MODE and PROGRESS_WAIT_SECONDS
are described in conf/default.conf.</p>
</div>
<div class="paragraph">
<p>For example a setup for parallel runs of mkbackuponly and restoreonly
could look like the following:</p>
</div>
<div class="listingblock">
<div class="title">/etc/rear/local.conf</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">OUTPUT=ISO
BACKUP=NETFS
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://your.NFS.server.IP/path/to/your/rear/backup
MESSAGE_PREFIX="$$: "
PROGRESS_MODE="plain"
PROGRESS_WAIT_SECONDS="3"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/etc/rear/basic_system.conf</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">this_file_name=$( basename ${BASH_SOURCE[0]} )
LOGFILE="$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-${this_file_name%.*}-$$.log"
BACKUP_PROG_EXCLUDE+=( '/home/*' '/opt/*' )
BACKUP_PROG_ARCHIVE="backup-${this_file_name%.*}"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/etc/rear/home_backup.conf</div>
<div class="content">
<pre>this_file_name=$( basename ${BASH_SOURCE[0]} )
LOGFILE="$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-${this_file_name%.*}-$$.log"
BACKUP_ONLY_INCLUDE="yes"
BACKUP_PROG_INCLUDE=( '/home/*' )
BACKUP_PROG_ARCHIVE="backup-${this_file_name%.*}"</pre>
</div>
</div>
<div class="listingblock">
<div class="title">/etc/rear/opt_backup.conf</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">this_file_name=$( basename ${BASH_SOURCE[0]} )
LOGFILE="$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-${this_file_name%.*}-$$.log"
BACKUP_ONLY_INCLUDE="yes"
BACKUP_PROG_INCLUDE=( '/opt/*' )
BACKUP_PROG_ARCHIVE="backup-${this_file_name%.*}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>With those config files creating the ReaR recovery/rescue system ISO image
together with a backup of the files of the basic system and then
backup the files in /home and /opt in parallel could be done like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>rear -C basic_system mkbackup
rear -C home_backup mkbackuponly &amp; rear -C opt_backup mkbackuponly &amp; wait</pre>
</div>
</div>
<div class="paragraph">
<p>Recovery of that system could be done by calling in the
ReaR recovery/rescue system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>rear -C basic_system recover
rear -C home_backup restoreonly &amp; rear -C opt_backup restoreonly &amp; wait</pre>
</div>
</div>
<div class="paragraph">
<p>Even on a relatively small system with a single CPU
running multiple backups and restores in parallel
can be somewhat faster compared to sequential processing.</p>
</div>
<div class="paragraph">
<p>On powerful systems with multiple CPUs, much main memory, fast storage access,
and fast access to the backups it is in practice mandatory to split
a single huge backup of the whole system into separated parts and
run at least the restores in parallel to utilize powerful hardware
and be as fast as possible in case of emergency and time pressure
during a real disaster recovery.</p>
</div>
<div class="paragraph">
<p>Remember that system recovery with multiple backups requires that
first and foremost the basic system is recovered where all files
must be restored that are needed to install the bootloader and
to boot the basic system into a normal usable state so that
'rear recover' cannot run in parallel with 'rear restoreonly'.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_blockclone_as_backup_method">12. BLOCKCLONE as backup method</h2>
<div class="sectionbody">
<div class="paragraph">
<p>BLOCKCLONE backup method is a bit distinct type of backup, which works directly
 with block devices. It allows running backups of any kind of block device that
 can be read/write by Linux drivers and save them to e.g. NFS share or USB
 drive for later restore. It currently integrates Disk Dump (dd) and ntfsclone
 (from ntfs-3g package). With BLOCKCLONE, user is also able to make full backup
 and restore of dual boot (Linux / Windows) environments.<br>
Another potential use-case for the BLOCKCLONE method is to copy an encrypted
 filesystem including the encryption layer by imaging the underlying block device.
 This means that all existing encryption keys will be preserved and that the
 resulting backup file (the image generated by <code>dd</code>) will itself remain encrypted.</p>
</div>
<div class="sect2">
<h3 id="_limitations">12.1. Limitations</h3>
<div class="ulist">
<ul>
<li>
<p>Works only directly with disk partitions (or Logical Volumes using <code>dd</code>)</p>
</li>
<li>
<p>GPT not supported (work in progress)</p>
</li>
<li>
<p>No UEFI support (work in progress)</p>
</li>
<li>
<p>Linux family boot loader must be used as primary
(Windows bootloader was not tested)</p>
</li>
<li>
<p>Restore should be done to same sized or larger disks</p>
</li>
<li>
<p>Tests were made with Windows 7/10 with NFS and USB as destinations.
Other ReaR backup destinations like SMB or FTP might however work as well.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_warning">12.2. Warning!</h3>
<div class="paragraph">
<p>ReaR with BLOCKCLONE is capable of doing backup of Linux/Windows dual boot
 environments. There is however a need for some basic knowledge on how the
 source OS is set up. Things like boot loader device location, Linux/Windows
 partitioning and file system layout are essential for backup setup.<br>
<strong>Always test before relying on this approach!</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="_examples">12.3. Examples</h3>
<div class="sect3">
<h4 id="_1_backuprestore_of_arbitrary_block_device_with_blockclone_and_dd_on_nfs_server">12.3.1. 1. Backup/restore of arbitrary block device with BLOCKCLONE and dd on NFS server</h4>
<div class="sect4">
<h5 id="_configuration_3">Configuration</h5>
<div class="paragraph">
<p>This is very basic and most simple scenario where we will do backup
 of single partition (<em>/dev/sdc1</em>) located on separate disk (<em>/dev/sdc</em>).<br>
First we need to set some global options in <em>local.conf</em>,
 like target for backups.
In our small example backups will be stored in <em>/mnt/rear</em> directory
 on BACKUP_URL NFS server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># cat local.conf
OUTPUT=ISO
BACKUP=NETFS
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://&lt;hostname&gt;/mnt/rear</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we will define variables that will apply only for targeted block device</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># cat alien.conf
BACKUP=BLOCKCLONE                                        # Define BLOCKCLONE as backup method
BACKUP_PROG_ARCHIVE="alien"                              # Name of image file
BACKUP_PROG_SUFFIX=".dd.img"                             # Suffix of image file
BACKUP_PROG_COMPRESS_SUFFIX=""                           # Don't use additional suffixes

BLOCKCLONE_PROG=dd                                       # Use dd for image creation
BLOCKCLONE_PROG_OPTS="bs=4k"                             # Additional options that will be passed to dd
BLOCKCLONE_SOURCE_DEV="/dev/sdc1"                        # Device that should be backed up

BLOCKCLONE_SAVE_MBR_DEV="/dev/sdc"                       # Device where partitioning information is stored (optional)
BLOCKCLONE_MBR_FILE="alien_boot_strap.img"               # Output filename for boot strap code
BLOCKCLONE_PARTITIONS_CONF_FILE="alien_partitions.conf"  # Output filename for partition configuration

BLOCKCLONE_ALLOW_MOUNTED="yes"                           # Device can be mounted during backup (default NO)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_running_backup_2">Running backup</h5>
<div class="paragraph">
<p>Save partitions configuration, bootstrap code and create actual backup of /dev/sdc1</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -C alien mkbackuponly</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_running_restore_from_rear_restorerecovery_system">Running restore from ReaR restore/recovery system</h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -C alien restoreonly
Restore alien.dd.img to device: [/dev/sdc1]                 # User is always prompted for restore destination
Device /dev/sdc1 was not found.                             # If destination does not exist ReaR will try to create it (or fail if BLOCKCLONE_SAVE_MBR_DEV was not set during backup)
Restore partition layout to (^c to abort): [/dev/sdc]       # Prompt user for device where partition configuration should be restored
Checking that no-one is using this disk right now ... OK

Disk /dev/sdc: 5 GiB, 5368709120 bytes, 10485760 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes

&gt;&gt;&gt; Script header accepted.
&gt;&gt;&gt; Script header accepted.
&gt;&gt;&gt; Script header accepted.
&gt;&gt;&gt; Script header accepted.
&gt;&gt;&gt; Created a new DOS disklabel with disk identifier 0x10efb7a9.
Created a new partition 1 of type 'HPFS/NTFS/exFAT' and of size 120 MiB.
/dev/sdc2:
New situation:

Device     Boot Start    End Sectors  Size Id Type
/dev/sdc1        4096 249855  245760  120M  7 HPFS/NTFS/exFAT

The partition table has been altered.
Calling ioctl() to re-read partition table.
Syncing disks.</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_summary">Summary</h5>
<div class="paragraph">
<p>In first example we have run backup of /dev/sdc1 partition and stored it on NFS
 server. Saved image was later restored from ReaR rescue/recovery system.
ReaRs BLOCKCLONE will always ask user for restore destination, so it is users
 responsibility to identify right target disk/partition prior restore.
 Unlike NETFS backup method, no guesses about target devices will be made!</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
One of easiest ways how to identify right disk could be its size.<br>
Running <code>fdisk -l &lt;device_file&gt;</code> could be helpful.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>During restore phase ReaR recognized that target partition does not exist and
 asked if it should be created. If restore destination does not exist and
 BLOCKCLONE_SAVE_MBR_DEV was set during backup, ReaR will try to deploy
 partition setup from saved configuration files (BLOCKCLONE_MBR_FILE and
 BLOCKCLONE_PARTITIONS_CONF_FILE) and continue with restore.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_2_backuprestore_of_linux_windows_10_dual_boot_setup_with_each_os_on_separate_disk">12.3.2. 2. Backup/restore of Linux / Windows 10 dual boot setup with each OS on separate disk</h4>
<div class="sect4">
<h5 id="_configuration_4">Configuration</h5>
<div class="paragraph">
<p>In next example we will do backup/restore using BLOCKCLONE and <code>ntfsclone</code>
 of Linux (installed on /dev/sda) and Windows 10 (installed on /dev/sdb).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
You can locate right disk devices using <code>df</code> and <code>os-prober</code>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># df -h /boot
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda1        10G  4.9G  5.2G  49% /           # Linux is most probably installed on /dev/sda

# os-prober
/dev/sdb1:Windows 10 (loader):Windows:chain       # Windows 10 is most probably installed on /dev/sdb</code></pre>
</div>
</div>
<div class="paragraph">
<p>First we will configure some ReaR backup global options
 (similar to <a href="12-BLOCKCLONE.adoc#1-backuprestore-of-arbitrary-block-device-with-blockclone-and-dd-on-nfs-server">first example</a>
 we will do backup/restore with help of NFS server).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># cat local.conf
OUTPUT=ISO
BACKUP=NETFS
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://&lt;hostname&gt;/mnt/rear
REQUIRED_PROGS+=( ntfsclone )</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we will define backup parameters for Linux.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># cat base_os.conf
this_file_name=$( basename ${BASH_SOURCE[0]} )
LOGFILE="$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-${this_file_name%.*}.log"
BACKUP_PROG_ARCHIVE="backup-${this_file_name%.*}"
BACKUP_PROG_EXCLUDE+=( '/media/*' )</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our Windows 10 is by default installed on two separate partitions
 (partition 1 for boot data and partition 2 for disk C:),
 so we will create two separate configuration files for each partition.</p>
</div>
<div class="paragraph">
<p>Windows boot partition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># cat windows_boot.conf
BACKUP=BLOCKCLONE
BACKUP_PROG_ARCHIVE="windows_boot"
BACKUP_PROG_SUFFIX=".img"
BACKUP_PROG_COMPRESS_SUFFIX=""

BLOCKCLONE_PROG=ntfsclone
BLOCKCLONE_SOURCE_DEV="/dev/sdb1"
BLOCKCLONE_PROG_OPTS="--quiet"

BLOCKCLONE_SAVE_MBR_DEV="/dev/sdb"
BLOCKCLONE_MBR_FILE="windows_boot_strap.img"
BLOCKCLONE_PARTITIONS_CONF_FILE="windows_partitions.conf"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Windows data partition (disk C:\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># cat windows_data.conf
BACKUP=BLOCKCLONE
BACKUP_PROG_ARCHIVE="windows_data"
BACKUP_PROG_SUFFIX=".img"
BACKUP_PROG_COMPRESS_SUFFIX=""

BLOCKCLONE_PROG=ntfsclone
BLOCKCLONE_SOURCE_DEV="/dev/sdb2"
BLOCKCLONE_PROG_OPTS="--quiet"

BLOCKCLONE_SAVE_MBR_DEV="/dev/sdb"
BLOCKCLONE_MBR_FILE="windows_boot_strap.img"
BLOCKCLONE_PARTITIONS_CONF_FILE="windows_partitions.conf"</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_running_backup_3">Running backup</h5>
<div class="paragraph">
<p>First we will create backup of Linux. <code>mkbackup</code> command will create bootable
 ISO image with ReaR rescue/recovery system that will be later used for
 booting broken system and consecutive recovery.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -C base_os mkbackup</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we create backup of Windows 10 boot partition. Command <code>mkbackuponly</code>
 will ensure that only partition data and partition layout will be saved
 (ReaR rescue/recovery system will not be created which is exactly what we want).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -C windows_boot mkbackuponly</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, we create backup of Windows 10 data partition (disk C:\)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -C windows_data mkbackuponly</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_running_restore_from_rear_restorerecovery_system_2">Running restore from ReaR restore/recovery system</h5>
<div class="paragraph">
<p>As a first step after ReaR rescue/recovery system booted,
we will recover Linux. This step will recover all Linux file systems,
OS data and bootloader. Windows disk will remain untouched.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -C base_os recover</code></pre>
</div>
</div>
<div class="paragraph">
<p>In second step will recover Windows 10 boot partition. During this step ReaR
 will detect that destination partition is not present and ask us for device
 file where partition(s) should be created. It doesn&#8217;t really matter whether
 we decide to recover Windows 10 boot or data partition first.
 <code>restoreonly</code> command ensures that previously restored Linux data and
 partition(s) configuration (currently mounted under <em>/mnt/local</em>) will
 remain untouched. Before starting Windows 10 recovery we should identify
 right disk for recovery, as mentioned earlier disk size could be a good start.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># fdisk -l /dev/sdb
Disk /dev/sdb: 50 GiB, 53687091200 bytes, 104857600 sectors</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>/dev/sdb</em> looks to be right destination, so we can proceed with restore.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -C windows_boot restoreonly
Restore windows_boot.img to device: [/dev/sdb1]
Device /dev/sdb1 was not found.
Restore partition layout to (^c to abort): [/dev/sdb]
Checking that no-one is using this disk right now ... OK
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Last step is to recover Windows 10 OS data (C:\).
Partitions on <em>/dev/sdb</em> were already created in previous step,
hence ReaR will skip prompt for restoring partition layout.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -C windows_data restoreonly
Restore windows_data.img to device: [/dev/sdb2]
Ntfsclone image version: 10.1
Cluster size           : 4096 bytes
Image volume size      : 33833349120 bytes (33834 MB)
Image device size      : 33833353216 bytes
Space in use           : 9396 MB (27.8%)
Offset to image data   : 56 (0x38) bytes
Restoring NTFS from image ...
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this stage Linux together with Windows 10 is successfully restored.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
As Linux part is still mounted under <em>/mnt/local</em>, you can do some
 final configuration changes. e.g. adapt GRUB configuration, /etc/fstab,
 reinstall boot loader &#8230;&#8203;
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
ReaR will by default not include tools for mounting NTFS file systems. You
 can do it manually by adding
 <code>REQUIRED_PROGS+=( ntfsclone mount.ntfs-3g )</code>
 to your <em>local.conf</em>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_3_backuprestore_of_linux_windows_10_dual_boot_setup_sharing_same_disk">12.3.3. 3. Backup/restore of Linux / Windows 10 dual boot setup sharing same disk</h4>
<div class="sect4">
<h5 id="_configuration_5">Configuration</h5>
<div class="paragraph">
<p>In this example we will do backup/restore using BLOCKCLONE and <code>ntfsclone</code>
 of Linux and Windows 10 installed on same disk (<em>/dev/sda</em>).
 Linux is installed on partition <em>/dev/sda3</em>. Windows 10 is again divided into
 boot partition located on <em>/dev/sda1</em> and OS data (C:/) located on <em>/dev/sda2</em>.
 Backups will be stored on NFS server.</p>
</div>
<div class="paragraph">
<p>First we set global ReaR options</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># cat local.conf
OUTPUT=ISO
BACKUP=NETFS
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://&lt;hostname&gt;/mnt/rear
REQUIRED_PROGS+=( ntfsclone )

BLOCKCLONE_STRICT_PARTITIONING="yes"
BLOCKCLONE_SAVE_MBR_DEV="/dev/sda"

BLOCKCLONE_MBR_FILE="boot_strap.img"
BLOCKCLONE_PARTITIONS_CONF_FILE="partitions.conf"</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
BLOCKCLONE_STRICT_PARTITIONING is mandatory if backing up
 Linux / Windows that shares one disk. Not using this option might result to
 unbootable Windows 10 installation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Linux configuration</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># cat base_os.conf
this_file_name=$( basename ${BASH_SOURCE[0]} )
LOGFILE="$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-${this_file_name%.*}.log"
BACKUP_PROG_ARCHIVE="backup-${this_file_name%.*}"
BACKUP_PROG_EXCLUDE+=( '/media/*' )</code></pre>
</div>
</div>
<div class="paragraph">
<p>Windows 10 boot partition configuration</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># cat windows_boot.conf
BACKUP=BLOCKCLONE

BACKUP_PROG_ARCHIVE="windows_boot"
BACKUP_PROG_SUFFIX=".nc.img"
BACKUP_PROG_COMPRESS_SUFFIX=""

BLOCKCLONE_PROG=ntfsclone
BLOCKCLONE_PROG_OPTS="--quiet"

BLOCKCLONE_SOURCE_DEV="/dev/sda1"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Windows 10 data partition configuration</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># cat windows_data.conf
BACKUP=BLOCKCLONE
BACKUP_PROG_ARCHIVE="windows_data"
BACKUP_PROG_SUFFIX=".nc.img"
BACKUP_PROG_COMPRESS_SUFFIX=""

BLOCKCLONE_PROG=ntfsclone
BLOCKCLONE_PROG_OPTS="--quiet"

BLOCKCLONE_SOURCE_DEV="/dev/sda2"</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_running_backup_4">Running backup</h5>
<div class="paragraph">
<p>Backup of Linux</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -C base_os mkbackup</code></pre>
</div>
</div>
<div class="paragraph">
<p>Backup of Windows 10 boot partition</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -C windows_boot mkbackuponly</code></pre>
</div>
</div>
<div class="paragraph">
<p>Backup of Windows 10 data partition</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -C windows_data mkbackuponly</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_running_restore_from_rear_restorerecovery_system_3">Running restore from ReaR restore/recovery system</h5>
<div class="paragraph">
<p>Restore Linux</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -C base_os recover</code></pre>
</div>
</div>
<div class="paragraph">
<p>During this step ReaR will also create both Windows 10 partitions</p>
</div>
<div class="paragraph">
<p>Restore Windows 10 data partition</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -C windows_data restoreonly</code></pre>
</div>
</div>
<div class="paragraph">
<p>Restore Windows 10 boot partition</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -C windows_boot restoreonly</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_4_backuprestore_of_linux_windows_10_dual_boot_setup_sharing_same_disk_with_usb_as_destination">12.3.4. 4. Backup/restore of Linux / Windows 10 dual boot setup sharing same disk with USB as destination</h4>
<div class="sect4">
<h5 id="_configuration_6">Configuration</h5>
<div class="paragraph">
<p>In this example we will do backup/restore using BLOCKCLONE and <code>ntfsclone</code>
 of Linux and Windows 10 installed on same disk (<em>/dev/sda</em>).
 Linux is installed on partition <em>/dev/sda3</em>. Windows 10 is again divided into
 boot partition located on <em>/dev/sda1</em> and OS data (C:/) located on <em>/dev/sda2</em>.
 Backups will be stored on USB disk drive (<em>/dev/sdb</em> in this example).</p>
</div>
<div class="paragraph">
<p>Global options</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># cat local.conf
OUTPUT=USB
BACKUP=NETFS

USB_DEVICE=/dev/disk/by-label/REAR-000
BACKUP_URL=usb:///dev/disk/by-label/REAR-000

USB_SUFFIX="USB_backups"

GRUB_RESCUE=n
REQUIRED_PROGS+=( ntfsclone )

BLOCKCLONE_STRICT_PARTITIONING="yes"
BLOCKCLONE_SAVE_MBR_DEV="/dev/sda"

BLOCKCLONE_MBR_FILE="boot_strap.img"
BLOCKCLONE_PARTITIONS_CONF_FILE="partitions.conf"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Options used during Linux backup/restore.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># cat local.conf
OUTPUT=USB
BACKUP=NETFS

USB_DEVICE=/dev/disk/by-label/REAR-000
BACKUP_URL=usb:///dev/disk/by-label/REAR-000

USB_SUFFIX="USB_backups"

GRUB_RESCUE=n
REQUIRED_PROGS+=( ntfsclone )

BLOCKCLONE_STRICT_PARTITIONING="yes"
BLOCKCLONE_SAVE_MBR_DEV="/dev/sda"

BLOCKCLONE_MBR_FILE="boot_strap.img"
BLOCKCLONE_PARTITIONS_CONF_FILE="partitions.conf"</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
USB_SUFFIX option is mandatory as it avoids ReaR to hold every
 backup in separate directory, this behavior is essential for BLOCKCLONE
 backup method to work correctly.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Windows boot partition options</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># cat windows_boot.conf
BACKUP=BLOCKCLONE

BACKUP_PROG_ARCHIVE="windows_boot"
BACKUP_PROG_SUFFIX=".nc.img"
BACKUP_PROG_COMPRESS_SUFFIX=""

BLOCKCLONE_PROG=ntfsclone
BLOCKCLONE_PROG_OPTS="--quiet"

BLOCKCLONE_SOURCE_DEV="/dev/sda1"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Windows data partition options</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># cat windows_data.conf
BACKUP=BLOCKCLONE
BACKUP_PROG_ARCHIVE="windows_data"
BACKUP_PROG_SUFFIX=".nc.img"
BACKUP_PROG_COMPRESS_SUFFIX=""

BLOCKCLONE_PROG=ntfsclone
BLOCKCLONE_PROG_OPTS="--quiet"

BLOCKCLONE_SOURCE_DEV="/dev/sda2"</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_running_backup_5">Running backup</h5>
<div class="paragraph">
<p>First we need to format target USB device, with <code>rear format</code> command</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -v format /dev/sdb
Relax-and-Recover 2.00 / Git
Using log file: /var/log/rear/rear-centosd.log
USB device /dev/sdb is not formatted with ext2/3/4 or btrfs filesystem
Type exactly 'Yes' to format /dev/sdb with ext3 filesystem: Yes
Repartitioning '/dev/sdb'
Creating partition table of type 'msdos' on '/dev/sdb'
Creating ReaR data partition up to 100% of '/dev/sdb'
Setting 'boot' flag on /dev/sdb
Creating ext3 filesystem with label 'REAR-000' on '/dev/sdb1'
Adjusting filesystem parameters on '/dev/sdb1'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Backup of Linux</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -C base_os mkbackup</code></pre>
</div>
</div>
<div class="paragraph">
<p>Backup of Windows 10 boot partition</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -C windows_boot mkbackuponly
NTFS volume version: 3.1
Cluster size       : 4096 bytes
Current volume size: 524283904 bytes (525 MB)
Current device size: 524288000 bytes (525 MB)
Scanning volume ...
Accounting clusters ...
Space in use       : 338 MB (64.4%)
Saving NTFS to image ...
Syncing ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Backup of Windows 10 data partition</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -C windows_data mkbackuponly
NTFS volume version: 3.1
Cluster size       : 4096 bytes
Current volume size: 18104709120 bytes (18105 MB)
Current device size: 18104713216 bytes (18105 MB)
Scanning volume ...
Accounting clusters ...
Space in use       : 9833 MB (54.3%)
Saving NTFS to image ...
Syncing ...</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_running_restore_from_rear_restorerecovery_system_4">Running restore from ReaR restore/recovery system</h5>
<div class="paragraph">
<p>For sake of this demonstration I&#8217;ve purposely used ReaR&#8217;s rescue/recovery media
 (USB disk that holds our backed up Linux and Windows 10) as <em>/dev/sda</em> and
 disk that will be used as restore destination as <em>/dev/sdb</em>. This will
 demonstrate possibility of ReaR to recover backup to arbitrary disk.<br>
As first step Linux will be restored, this will create all the partitions
 needed, even those used by Windows 10.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>RESCUE centosd:~ # rear -C base_os recover
Relax-and-Recover 2.00 / Git
Using log file: /var/log/rear/rear-centosd.log
Sourcing additional configuration file '/etc/rear/base_os.conf'
Running workflow recover within the ReaR rescue/recovery system
Starting required daemons for NFS: RPC portmapper (portmap or rpcbind) and rpc.statd if available.
Started RPC portmapper 'rpcbind'.
RPC portmapper 'rpcbind' available.
Started rpc.statd.
RPC status rpc.statd available.
Using backup archive '/tmp/rear.70zIHqCYsIbtlr6/outputfs/centosd/backup-base_os.tar.gz'
Calculating backup archive size
Backup archive size is 1001M	/tmp/rear.70zIHqCYsIbtlr6/outputfs/centosd/backup-base_os.tar.gz (compressed)
Comparing disks.
Device sda has size 15733161984, 37580963840 expected
Switching to manual disk layout configuration.
Original disk /dev/sda does not exist in the target system. Please choose an appropriate replacement.
1) /dev/sda
2) /dev/sdb
3) Do not map disk.
#?</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now ReaR recover command stops as it detected that disk layout is not identical.
 As our desired restore target is <em>/dev/sdb</em> we choose right disk and continue
 recovery. ReaR will ask to check created restore scripts, but this is not
 needed in our scenario.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>#? 2
2017-01-25 20:54:01 Disk /dev/sdb chosen as replacement for /dev/sda.
Disk /dev/sdb chosen as replacement for /dev/sda.
This is the disk mapping table:
    /dev/sda /dev/sdb
Please confirm that '/var/lib/rear/layout/disklayout.conf' is as you expect.

1) View disk layout (disklayout.conf)  4) Go to Relax-and-Recover shell
2) Edit disk layout (disklayout.conf)  5) Continue recovery
3) View original disk space usage      6) Abort Relax-and-Recover
#? 5
Partition primary on /dev/sdb: size reduced to fit on disk.
Please confirm that '/var/lib/rear/layout/diskrestore.sh' is as you expect.

1) View restore script (diskrestore.sh)
2) Edit restore script (diskrestore.sh)
3) View original disk space usage
4) Go to Relax-and-Recover shell
5) Continue recovery
6) Abort Relax-and-Recover
#? 5
Start system layout restoration.
Creating partitions for disk /dev/sdb (msdos)

Disk /dev/sdb: 6527 cylinders, 255 heads, 63 sectors/track
Old situation:
Units: cylinders of 8225280 bytes, blocks of 1024 bytes, counting from 0

   Device Boot Start     End   #cyls    #blocks   Id  System
/dev/sdb1   *      0+     91-     92-    731449   83  Linux
/dev/sdb2         91+   3235-   3145-  25258396+  83  Linux
/dev/sdb3       3235+   6527-   3292-  26436900   83  Linux
/dev/sdb4          0       -       0          0    0  Empty
New situation:
Units: sectors of 512 bytes, counting from 0

   Device Boot    Start       End   #sectors  Id  System
/dev/sdb1   *      2048   1026047    1024000   7  HPFS/NTFS/exFAT
/dev/sdb2       1026048  36386815   35360768   7  HPFS/NTFS/exFAT
/dev/sdb3      36386816  73400319   37013504  83  Linux
/dev/sdb4             0         -          0   0  Empty
Successfully wrote the new partition table

Re-reading the partition table ...

Creating filesystem of type xfs with mount point / on /dev/sdb3.
Mounting filesystem /
Disk layout created.
Restoring from '/tmp/rear.70zIHqCYsIbtlr6/outputfs/centosd/backup-base_os.tar.gz'...
Restoring usr/lib/modules/3.10.0-514.2.2.el7.x86_64/kernel/drivers/net/wireless/realtek/rtlwifi/rtl8723be/rtl8723be.koRestoring var/log/rear/rear-centosd.log OK
Restored 2110 MiB in 103 seconds [avg. 20977 KiB/sec]
Restoring finished.
Restore the Mountpoints (with permissions) from /var/lib/rear/recovery/mountpoint_permissions
Patching '/etc/default/grub' instead of 'etc/sysconfig/grub'
Patching '/proc/1909/mounts' instead of 'etc/mtab'
Skip installing GRUB Legacy boot loader because GRUB 2 is installed (grub-probe or grub2-probe exist).
Installing GRUB2 boot loader
Finished recovering your system. You can explore it under '/mnt/local'.
Saving /var/log/rear/rear-centosd.log as /var/log/rear/rear-centosd-recover-base_os.log</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we have Linux part restored, GRUB installed and partitions created, hence
 we can continue with Windows 10 boot partition recovery.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>RESCUE centosd:~ # rear -C windows_boot restoreonly
Restore windows_boot.nc.img to device: [/dev/sda1] /dev/sdb1
Ntfsclone image version: 10.1
Cluster size           : 4096 bytes
Image volume size      : 524283904 bytes (525 MB)
Image device size      : 524288000 bytes
Space in use           : 338 MB (64.4%)
Offset to image data   : 56 (0x38) bytes
Restoring NTFS from image ...
Syncing ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly to Linux restore, we were prompted for restore destination, which
 is /dev/sdb1 in our case.<br>
As the last step we will recover Windows 10 data partition</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>RESCUE centosd:~ # rear -C windows_data restoreonly
Restore windows_data.nc.img to device: [/dev/sda2] /dev/sdb2
Ntfsclone image version: 10.1
Cluster size           : 4096 bytes
Image volume size      : 18104709120 bytes (18105 MB)
Image device size      : 18104713216 bytes
Space in use           : 9867 MB (54.5%)
Offset to image data   : 56 (0x38) bytes
Restoring NTFS from image ...
Syncing ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again after restoreonly command is launched, ReaR prompts for restore
 destination.<br>
Now both operating systems are restored and we can reboot.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_5_backuprestore_of_linux_to_an_nfs_share_with_an_encrypted_device_imaged_using_dd">12.3.5. 5. Backup/restore of Linux to an NFS share with an encrypted device imaged using <code>dd</code></h4>
<div class="sect4">
<h5 id="_configuration_7">Configuration</h5>
<div class="paragraph">
<p>In this example we will split the backup of a Linux-only machine into two parts. First,
 we&#8217;ll deal with the base OS the usual way (ignoring the encrypted filesystem), and
 then we&#8217;ll process that special filesystem (<em>/dev/vg00/lvol4</em>, mounted as
 <em>/products</em>) using BLOCKCLONE and <code>dd</code>.<br>
As you will see, during the base OS restore phase, the encrypted filesystem will be
 recreated with new encryption keys (although empty, as <em>/products</em> was ignored during
 the backup phase), but it will then be completely overwritten when we use <code>dd</code> to
 restore the image in the last phase.<br>
The <em>BLOCKCLONE_TRY_UNMOUNT</em> is important here: it will attempt to unmount the
 encrypted filesystem before creating its image and before restoring it. If
 unmounting is impossible, do not despair, the recovery should still work but
 you may need to manually repair the filesystem before you can mount it, and you
 run the risk that the data may be inconsistent.</p>
</div>
<div class="paragraph">
<p>Global options</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># cat site.conf
OUTPUT=ISO
KEEP_OLD_OUTPUT_COPY=1
BACKUP_URL="nfs://&lt;hostname&gt;/Stations_bkup/rear/"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Options used for the base OS backup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># cat base_system.conf
this_file_name=$( basename ${BASH_SOURCE[0]} )
LOGFILE="$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-${this_file_name%.*}.log"
BACKUP_PROG_EXCLUDE+=( '/products/*' )
BACKUP_PROG_ARCHIVE="backup-${this_file_name%.*}"
BACKUP=NETFS</code></pre>
</div>
</div>
<div class="paragraph">
<p>Options used to take the encrypted filesystem image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>this_file_name=$( basename ${BASH_SOURCE[0]} )
LOGFILE="$LOG_DIR/rear-$HOSTNAME-$WORKFLOW-${this_file_name%.*}.log"
BACKUP=BLOCKCLONE
BACKUP_PROG_ARCHIVE="backup-${this_file_name%.*}"
BACKUP_PROG_SUFFIX=".dd.img"
BACKUP_PROG_COMPRESS_SUFFIX=""

BLOCKCLONE_PROG=dd
BLOCKCLONE_PROG_OPTS="bs=4k"
BLOCKCLONE_SOURCE_DEV="/dev/vg00/lvol4"

BLOCKCLONE_ALLOW_MOUNTED="yes"
BLOCKCLONE_TRY_UNMOUNT="yes"</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_running_backup_6">Running backup</h5>
<div class="paragraph">
<p>Base OS backup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -C base_system mkbackup</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create image of encrypted filesystem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># rear -C products_backup mkbackuponly</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_running_restore_from_rear_restorerecovery_system_5">Running restore from ReaR restore/recovery system</h5>
<div class="paragraph">
<p>First recover the base OS. This will create all the partitions needed, including
 the encrypted one (but it won&#8217;t restore any data for the latter).<br>
As illustrated below, you will be prompted to chose a new encryption passphrase.
 Please provide one, but you need not care about its value as it will get overwritten
 during the next phase:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>RESCUE pc-pan:~ # rear -C base_system.conf recover
[...]
Please enter the password for LUKS device cr_vg00-lvol4 (/dev/mapper/vg00-lvol4):
Enter passphrase for /dev/mapper/vg00-lvol4:
Please re-enter the password for LUKS device cr_vg00-lvol4 (/dev/mapper/vg00-lvol4):
Enter passphrase for /dev/mapper/vg00-lvol4:
Creating filesystem of type xfs with mount point /products on /dev/mapper/cr_vg00-lvol4.
Mounting filesystem /products
Disk layout created.
[...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can proceed and restore the encrypted filesystem image. The target filesystem
 will have been mounted by ReaR during the previous phase, but this will be
 correctly handled by the restore script provided you set <em>BLOCKCLONE_TRY_UNMOUNT</em>
 to "yes".<br>
As illustrated below, you will be prompted for the target block device to use.
 Confirm by pressing Enter or type in another value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>RESCUE pc-pan:~ # rear -C products_backup.conf restoreonly
[...]
Restore backup-products_backup.dd.img to device: [/dev/vg00/lvol4]
[...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note that the target device will not be re-mounted by the script at the end
 of the restore phase. If needed, this should be done manually.<br>
The recovered machine can now be rebooted. When prompted for the passphrase to
 decrypt your filesystem, you should now provide the original one (the one you used
 at the time the backup was made), and NOT the new one you typed during the recover
 phase.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_support_for_tcg_opal_2_compliant_self_encrypting_disks">13. Support for TCG Opal 2-compliant Self-Encrypting Disks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Beginning with version 2.4, Relax-and-Recover supports self-encrypting disks
(SEDs) compliant with the TCG Opal 2 specification.</p>
</div>
<div class="paragraph">
<p>The term "SED" refers to any kind of self-encrypting disk.
A "TCG Opal 2-compliant disk" or short "Opal disk" is a variant of an SED which implements the Opal 2 standard.
There are/were other SED variants on the market using proprietary protocols.</p>
</div>
<div class="paragraph">
<p>In general, these disks all provide full disk encryption in hardware, similar to what LUKS does in software.</p>
</div>
<div class="paragraph">
<p>Self-encrypting disk support includes</p>
</div>
<div class="ulist">
<ul>
<li>
<p>recovery (saving and restoring the system&#8217;s SED configuration),</p>
</li>
<li>
<p>setting up SEDs, including assigning a disk password,</p>
</li>
<li>
<p>providing a pre-boot authentication (PBA) system to unlock SEDs at boot time.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_prerequisites">13.1. Prerequisites</h3>
<div class="paragraph">
<p>To enable Relax-and-Recover&#8217;s TCG Opal 2 support, install the <code>sedutil-cli</code>
(version 1.15.1) executable into a directory within root&#8217;s search
path. <code>sedutil-cli</code> is available for
<a href="https://github.com/Drive-Trust-Alliance/exec/blob/master/sedutil_LINUX.tgz?raw=true">download from Drive Trust Alliance</a>
(check version compatibility), or see
<a href="#_how_to_build_sedutil_cli_version_1_15_1">How to Build sedutil-cli Version 1.15.1</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_quick_start_setting_up_self_encrypting_disks">13.2. Quick Start: Setting up Self-Encrypting Disks</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This section assumes that ReaR was installed from a package repository. If you are using ReaR locally from GitHub: <code>cd</code> into the project&#8217;s base directory, use the configuration file <code>etc/rear/local.conf</code>, invoke <code>usr/sbin/rear</code>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_step_1_install_prerequisites">13.2.1. Step 1: Install Prerequisites</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download the low-level utility <code>sedutil-cli</code> (version 1.15.1) from <a href="https://github.com/Drive-Trust-Alliance/exec/blob/master/sedutil_LINUX.tgz?raw=true">Drive-Trust-Alliance on GitHub</a>.</p>
</li>
<li>
<p>Install it into a directory within root&#8217;s search path (e.g. <code>/usr/local/sbin</code>).</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_step_2_create_disk_images_for_pba_and_rescue_system">13.2.2. Step 2: Create Disk Images for PBA and Rescue System</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In <code>/etc/rear/local.conf</code> add these two lines:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">OUTPUT=RAWDISK
OUTPUT_URL="file:///var/lib/rear/output"</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>To support secure boot, add another line specifying your secure boot loader, e.g. on Ubuntu:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">SECURE_BOOT_BOOTLOADER="/boot/efi/EFI/ubuntu/shimx64.efi"</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Run <code>sudo rear mkopalpba</code> (ignore messages about keyboard mappings)</p>
</li>
<li>
<p>Run <code>sudo rear mkrescue</code> (ignore messages about keyboard mappings)</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_step_3_create_a_bootable_usb_stick_with_the_rescue_system">13.2.3. Step 3: Create a Bootable USB Stick with the Rescue System</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Plug in the USB stick to use.</p>
</li>
<li>
<p>Use <code>lsblk -o +MODEL</code> to find the correct disk device path for your USB stick (typically <code>/dev/sdX</code>).</p>
</li>
<li>
<p><strong>RE-CHECK. The following command will overwrite the entire USB stick.</strong></p>
</li>
<li>
<p>Use the following command, replacing <code>USB-DEVICE</code> with the USB stick&#8217;s device name.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">sudo zcat "/var/lib/rear/output/$(hostname)/rear-$(hostname).raw.gz" | sudo dd bs=1M of=/dev/USB-DEVICE</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_step_4_set_up_opal_2_disk_drives">13.2.4. Step 4: Set up Opal 2 Disk Drives</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Setting up an SED normally <strong>ERASES ALL DATA ON THE DISK</strong>, as a new data
encryption key (DEK) will be generated. While <code>rear opaladmin</code> includes safety
measures to avoid accidentally erasing a partitioned disk, do not rely on this
solely. <strong>Always back up your data and have a current rescue system available.</strong>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Boot the rescue system just created.</p>
</li>
<li>
<p><strong>RE-CHECK. The following command will erase selected disks.</strong></p>
</li>
<li>
<p>Run <code>rear opaladmin setupERASE <em>DEVICE</em> &#8230;&#8203;</code></p>
<div class="ulist">
<ul>
<li>
<p><code><em>DEVICE</em></code> is the disk device path like <code>/dev/sda</code>, or <code>ALL</code> for all available
devices.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Verify that disk unlocking works:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Turn off power.</p>
</li>
<li>
<p>Remove the rescue USB stick.</p>
</li>
<li>
<p>Turn on power.</p>
</li>
<li>
<p>Check the PBA boots and unlocks disks.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
After unlocking, there is no OS. This is expected.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_step_5_install_the_operating_system">13.2.5. Step 5: Install the Operating System</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Boot the rescue system.</p>
</li>
<li>
<p>Deactivate locking:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">rear opaladmin deactivate</code></pre>
</div>
</div>
</li>
<li>
<p>Install the Operating System.</p>
</li>
<li>
<p>Boot the rescue system.</p>
</li>
<li>
<p>Reactivate locking:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">rear opaladmin reactivate</code></pre>
</div>
</div>
</li>
<li>
<p>Remove the rescue USB stick and shutdown the system.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tcg_opal_2_compliant_self_encrypting_disks_2">13.3. TCG Opal 2-compliant Self-Encrypting Disks</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This is a simplified explanation to help understand self-encrypting disks
in the context of Relax-and-Recover support.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An Opal 2-compliant self-encrypting disk (SED) encrypts disk contents in
hardware. The SED can be configured to store a user-assigned password and to
lock itself when powered off. Unlocking the disk after powering up requires the
user to supply the password.</p>
</div>
<div class="sect3">
<h4 id="_booting_from_a_self_encrypting_disk">13.3.1. Booting From a Self-Encrypting Disk</h4>
<div class="paragraph">
<p>How can a system boot from a disk which is locked? The Opal solution is
metamorphosis. An Opal disk hides or presents different contents depending on
whether it is locked or not:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In addition to its regular contents, an Opal disk contains a special area for
additional boot code, the (unfortunately named) <em>shadow MBR</em>. It is small (the
spec guarantees just 128 MB), write-protected, and normally hidden.</p>
</li>
<li>
<p>When <strong>unlocked</strong>, an Opal disk shows its regular contents like any other disk.
In this state, the system firmware would boot the regular operating system.</p>
</li>
<li>
<p>When <strong>locked</strong>, an Opal boot disk exposes its <em>shadow MBR</em> at the start,
followed by zeroed blocks. In this state, the system firmware would boot the
code residing in the shadow MBR.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The shadow MBR, when enabled, can be prepared with a <em>pre-boot authentication</em>
(PBA) system. The PBA system is a purpose-built operating system which</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>is booted by the firmware like any other operating system,</p>
</li>
<li>
<p>asks the user for the disk password,</p>
</li>
<li>
<p>unlocks the boot disk (and possibly other Opal 2-compliant SEDs as well), and</p>
</li>
<li>
<p>continues to boot the regular operating system.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_administering_self_encrypting_disks">13.4. Administering Self-Encrypting Disks</h3>
<div class="sect3">
<h4 id="_creating_a_pre_boot_authentication_pba_system">13.4.1. Creating a Pre-Boot Authentication (PBA) System</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This is only required if an SED is to be used as boot disk.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To create a pre-boot authentication (PBA) system image:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run <code>sudo rear mkopalpba</code></p>
<div class="ulist">
<ul>
<li>
<p>The PBA image will appear below the <code>OPAL_PBA_OUTPUT_URL</code> directory (see
<code>default.conf</code>) as <code>$HOSTNAME/TCG-Opal-PBA-$HOSTNAME.raw</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If you want to test the PBA system image,</p>
<div class="ulist">
<ul>
<li>
<p>copy it onto a disk boot medium (a USB stick will do) with <code>dd
if="$image_file" bs=1MB of="$usb_device"</code> (use the entire disk device, not a
partition),</p>
</li>
<li>
<p>boot from the medium just created.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>To create a rescue system with an integrated PBA system image:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Verify that the <code>OPAL_PBA_OUTPUT_URL</code> configuration variable points to a local
directory (which is the default), or set <code>OPAL_PBA_IMAGE_FILE</code> to the image
file&#8217;s full path.</p>
</li>
<li>
<p>Run <code>sudo rear mkrescue</code></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_setting_up_self_encrypting_disks">13.4.2. Setting Up Self-Encrypting Disks</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Setting up an SED normally <strong>ERASES ALL DATA ON THE DISK</strong>, as a new data
encryption key (DEK) will be generated. While <code>rear opaladmin</code> includes safety
measures to avoid accidentally erasing a partitioned disk, do not rely on this
solely. <strong>Always back up your data and have a current rescue system available.</strong>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To set up SEDs:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Boot the Relax-and-Recover rescue system.</p>
<div class="ulist">
<ul>
<li>
<p>If SED boot support is required, ensure that the rescue system was built with
an integrated PBA system image.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Run <code>rear opaladmin setupERASE <em>DEVICE</em> &#8230;&#8203;</code></p>
<div class="ulist">
<ul>
<li>
<p><code><em>DEVICE</em></code> is the disk device path like <code>/dev/sda</code>, or <code>ALL</code> for all available
devices</p>
</li>
<li>
<p>This will set up Opal 2-compliant disks specified by the <code><em>DEVICE</em></code> arguments.</p>
</li>
<li>
<p>You will be asked for a new disk password. The same password will be used for
all disks being set up.</p>
</li>
<li>
<p>If a PBA is available on the rescue system, you will be asked for each disk
whether it should act as a boot device for disk unlocking (in which case the PBA
will be installed).</p>
</li>
<li>
<p><strong>DISK CONTENTS WILL BE ERASED</strong>, with the following exceptions:</p>
<div class="ulist">
<ul>
<li>
<p>If the disk has mounted partitions, the disk&#8217;s contents will be left
untouched.</p>
</li>
<li>
<p>If unmounted disk partitions are detected, you will be asked whether the
disk&#8217;s contents shall be erased.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>On UEFI systems, see
<a href="#_setting_up_uefi_firmware_to_boot_from_a_self_encrypting_disk">Setting up UEFI Firmware to Boot From a Self-Encrypting Disk</a>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_verifying_disk_setup">13.4.3. Verifying Disk Setup</h4>
<div class="paragraph">
<p>If you want to ensure that disks have been set up correctly:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Power off, then power on the system.</p>
</li>
<li>
<p>Boot directly into the Relax-and-Recover rescue system.</p>
</li>
<li>
<p>Run <code>rear opaladmin info</code> and verify that output looks like this:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">DEVICE         MODEL                          I/F    FIRMWARE     SETUP  ENCRYPTED  LOCKED  SHADOW MBR
/dev/sda       Samsung SSD 850 PRO 256GB      ATA    EXM04B6Q     y      y          y       visible</pre>
</div>
</div>
<div class="paragraph">
<p>The device should appear with <em>SETUP</em>=<code>y</code>, <em>ENCRYPTED</em>=<code>y</code> and <em>LOCKED</em>=<code>y</code>,
<em>SHADOW MBR</em> on boot disks should be <code>visible</code>, otherwise <code>disabled</code>.</p>
</div>
</li>
<li>
<p>Run <code>rear opaladmin unlock</code>, supplying the correct disk password.</p>
</li>
<li>
<p>Run <code>rear opaladmin info</code> and verify that output looks like this:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">DEVICE         MODEL                          I/F    FIRMWARE     SETUP  ENCRYPTED  LOCKED  SHADOW MBR
/dev/sda       Samsung SSD 850 PRO 256GB      ATA    EXM04B6Q     y      y          n       hidden</pre>
</div>
</div>
<div class="paragraph">
<p>The device should appear with <em>SETUP</em>=<code>y</code>, <em>ENCRYPTED</em>=<code>y</code> and <em>LOCKED</em>=<code>n</code>,
<em>SHADOW MBR</em> on boot disks should be <code>hidden</code>, otherwise <code>disabled</code>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_routine_administrative_tasks">13.4.4. Routine Administrative Tasks</h4>
<div class="paragraph">
<p>The following tasks can be safely performed on the original system (with <code>sudo</code>)
or on the rescue system.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Display disk information: <code>rear opaladmin info</code></p>
</li>
<li>
<p>Change the disk password: <code>rear opaladmin changePW</code></p>
</li>
<li>
<p>Upload the PBA onto the boot disk(s): <code>rear opaladmin uploadPBA</code></p>
</li>
<li>
<p>Unlock disk(s): <code>rear opaladmin unlock</code></p>
</li>
<li>
<p>Persistently deactivate the locking mechanism on disk(s): <code>rear opaladmin deactivate</code></p>
</li>
<li>
<p>Reactivate the locking mechanism on disk(s): <code>rear opaladmin reactivate</code></p>
</li>
<li>
<p>For help: <code>rear opaladmin help</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_erasing_a_self_encrypting_disk">13.4.5. Erasing a Self-Encrypting Disk</h4>
<div class="paragraph">
<p>To <strong>ERASE ALL DATA ON THE DISK</strong> but retain the setup:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Boot the Relax-and-Recover rescue system.</p>
</li>
<li>
<p>Run <code>rear opaladmin resetDEK <em>DEVICE</em> &#8230;&#8203;</code></p>
<div class="ulist">
<ul>
<li>
<p><code><em>DEVICE</em></code> is the disk device path like <code>/dev/sda</code>, or <code>ALL</code> for all available
devices</p>
</li>
<li>
<p>If mounted disk partitions are detected, the disk&#8217;s contents will not be
erased.</p>
</li>
<li>
<p>If unmounted disk partitions are detected, you will be asked whether the
disk&#8217;s contents shall be erased.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>To <strong>ERASE ALL DATA ON THE DISK</strong> and reset the disk to factory settings:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Boot the Relax-and-Recover rescue system.</p>
</li>
<li>
<p>Run <code>rear opaladmin factoryRESET <em>DEVICE</em> &#8230;&#8203;</code></p>
<div class="ulist">
<ul>
<li>
<p><code><em>DEVICE</em></code> is the disk device path like <code>/dev/sda</code>, or <code>ALL</code> for all available
devices</p>
</li>
<li>
<p>If mounted disk partitions are detected, the disk&#8217;s contents will not be
erased.</p>
</li>
<li>
<p>If unmounted disk partitions are detected, you will be asked whether the
disk&#8217;s contents shall be erased.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_details">13.5. Details</h3>
<div class="sect3">
<h4 id="_how_to_build_sedutil_cli_version_1_15_1">13.5.1. How to Build sedutil-cli Version 1.15.1</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download <a href="https://github.com/Drive-Trust-Alliance/sedutil/archive/1.15.1.tar.gz">Drive-Trust-Alliance/sedutil version 1.15.1</a> source code.</p>
</li>
<li>
<p>Extract the archive, creating a directory <code>sedutil-1.15.1</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">tar xof sedutil-1.15.1.tar.gz</code></pre>
</div>
</div>
</li>
<li>
<p>Configure the build system:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cd sedutil-1.15.1
aclocal
autoconf
./configure</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Ignore the following error: <code>configure: error: cannot find install-sh,
install.sh, or shtool in "." "./.." "./../.."</code>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If there are any other error messages, you may have to install required
packages like <code>build-essential</code>, then re-run <code>./configure</code>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Compile the executable (on the x86_64 architecture in this example):</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cd linux/CLI
make CONF=Release_x86_64</code></pre>
</div>
</div>
</li>
<li>
<p>Install the executable into a directory root&#8217;s search path (<code>/usr/local/bin</code>
in this example):</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cp dist/Release_x86_64/GNU-Linux/sedutil-cli /usr/local/bin</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_setting_up_uefi_firmware_to_boot_from_a_self_encrypting_disk">13.5.2. Setting up UEFI Firmware to Boot From a Self-Encrypting Disk</h4>
<div class="paragraph">
<p>If the UEFI firmware is configured to boot from the disk <em>device</em> (instead of
some specific operating system entry), no further configuration is necessary.</p>
</div>
<div class="paragraph">
<p>Otherwise, the UEFI firmware (formerly BIOS setup) must be configured to boot two
different targets:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The PBA system (which is only accessible while the disk is locked).</p>
</li>
<li>
<p>The regular operating system (which is only accessible while the disk is
unlocked).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This can be configured as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ensure that the PBA system has been correctly installed to the boot drive.</p>
</li>
<li>
<p>Power off, then power on the system.</p>
</li>
<li>
<p>Enter the firmware setup.</p>
</li>
<li>
<p>Configure the firmware to boot from the (only) EFI entry of the boot drive.</p>
</li>
<li>
<p>Once a regular operating system has been installed:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Unlock the disk.</p>
</li>
<li>
<p>Reboot without powering off.</p>
</li>
<li>
<p>Enter the firmware setup.</p>
</li>
<li>
<p>Configure the firmware to boot from the EFI entry of your regular operating
system. Do not delete the previously configured boot entry for the PBA system.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_references">13.5.3. References</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/Drive-Trust-Alliance/sedutil">Drive-Trust-Alliance/sedutil:DTA sedutil Self encrypting drive software</a></p>
</li>
<li>
<p><a href="https://trustedcomputinggroup.org/wp-content/uploads/TCG_Storage-Opal_SSC_v2.01_rev1.00.pdf">TCG Storage Security Subsystem Class: Opal Specification Version 2.01</a></p>
</li>
<li>
<p><a href="https://trustedcomputinggroup.org">Trusted Computing Group</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_documentation_for_the_zypper_and_yum_methods">13.6. Documentation for the ZYPPER and YUM Methods</h3>
<div class="sect3">
<h4 id="_background">13.6.1. Background</h4>
<div class="paragraph">
<p>Both the ZYPPER and YUM methods are used to recreate a system "from scratch" by
capturing a list of RPMs installed on the source system and installing those RPMs
on the target system during the restore phase.</p>
</div>
<div class="paragraph">
<p>As of ReaR 2.4, the YUM method also includes the option to backup certain files.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_zypper">13.7. ZYPPER</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
ZYPPER method support was added to Relax-and-Recover 2.1.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is not the usual file-based backup/restore method where one gets the files
of an old system back as they had been before.</p>
</div>
<div class="paragraph">
<p>This new kind of "backup" method does not work on files but on RPM packages and
is intended for use with Linux distributions which use the zypper package
manager (SUSE, openSUSE, etc).</p>
</div>
<div class="sect3">
<h4 id="_configuration_8">13.7.1. Configuration</h4>
<div class="paragraph">
<p><strong>Option: ZYPPER REPOSITORIES</strong></p>
</div>
<div class="paragraph">
<p>During <code>rear mkbackup</code> it will basically only save a list of installed RPM
packages into <em>var/lib/rear/backup/ZYPPER/installed_RPM_packages</em> and during
<code>rear recover</code> it will basically only install those RPM packages as pristine
RPM packages from those zypper repositories that are specified in
<em>ZYPPER_REPOSITORIES</em> or in a
<em>var/lib/rear/backup/ZYPPER/zypper_repositories.repo</em> file.</p>
</div>
<div class="paragraph">
<p>Any other files that should be restored (e.g. prepared config files or
/home directories) must be done by "Using Multiple Backups for
Relax-and-Recover", see doc/user-guide/11-multiple-backups.adoc</p>
</div>
<div class="paragraph">
<p>For each member <em>zypper_repository</em> in the <em>ZYPPER_REPOSITORIES</em> array, the
following command is called
   <code>zypper --root $TARGET_FS_ROOT addrepo $zypper_repository &#8230;&#8203;</code>
which means each array member in <em>ZYPPER_REPOSITORIES</em> must be a valid zypper
repository URI.</p>
</div>
<div class="paragraph">
<p>See what <code>zypper repos -u</code> shows as URI and what <code>zypper repos -u -</code> returns.
Also see <code>man zypper</code>.</p>
</div>
<div class="paragraph">
<div class="title">Automatic zypper repo detection</div>
<p>The default empty <em>ZYPPER_REPOSITORIES</em> array means that, during <code>rear mkbackup</code>, the command
   <code>zypper repos --export var/lib/rear/backup/ZYPPER/zypper_repositories.repo</code>
is run (<em>var/lib/rear/backup/ZYPPER/zypper_repositories.repo</em> gets included in
the ReaR recovery system) and when, during <code>rear recover</code> in the ReaR recovery
system, <em>/var/lib/rear/backup/ZYPPER/zypper_repositories.repo</em> exists,
   <code>zypper --root $TARGET_FS_ROOT addrepo --repo /var/lib/rear/backup/ZYPPER/zypper_repositories.repo</code>
is run in the ReaR recovery system so that by default during <code>rear recover</code> the same
zypper repositories are used as in the original system. A precondition for that is
that during <code>rear recover</code> those zypper repositories are somehow "just accessible".</p>
</div>
<div class="paragraph">
<p>ReaR has nothing implemented to make zypper repositories accessible.</p>
</div>
<div class="paragraph">
<p>If that precondition is not fulfilled one must explicitly specify in
<em>etc/rear/local.conf</em> the <em>ZYPPER_REPOSITORIES</em> array with appropriate valid
zypper repository URI value(s) that are "just accessible" during <code>rear recover</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Currently the above described automated zypper repositories usage is not
implemented.
The current default is to use a SUSE installation DVD in the first CDROM drive:<br>
<code>ZYPPER_REPOSITORIES=( "cd:///?devices=/dev/sr0" )</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Option: ZYPPER_INSTALL_RPMS</strong></p>
</div>
<div class="paragraph">
<p>ZYPPER_INSTALL_RPMS specifies which kind of RPM packages are installed in which
way for BACKUP=ZYPPER.  The by default empty ZYPPER_INSTALL_RPMS means that,
during <code>rear recover</code>, each RPM package that is installed on the original
system gets re-installed on the target system.  Plus, all RPM packages that are
required by the one that gets re-installed automatically.</p>
</div>
<div class="paragraph">
<p>The list of all installed RPMs is stored during <code>rear mkbackup</code> by default in
<em>var/lib/rear/backup/ZYPPER/installed_RPMs</em>.</p>
</div>
<div class="paragraph">
<p>With <code>ZYPPER_INSTALL_RPMS="independent_RPMs"</code>, only those RPM packages that are
not required by other RPM packages on the original system get re-installed
on the target system PLUS all RPM packages that are required and recommended
by the ones that gets re-installed.</p>
</div>
<div class="paragraph">
<p>RPM packages that are not required by other RPMs are independently installed
RPM packages.  The list of independently installed RPMs is stored during <code>rear
mkbackup</code> by default in <em>var/lib/rear/backup/ZYPPER/independent_RPMs</em>.</p>
</div>
<div class="paragraph">
<p>Independently installed RPM packages are those that either are intentionally
installed by the admin (the ones that are really wanted) or got unintentionally
installed as recommended by other RPMs (those are perhaps needed) or are no
longer required after other RPMs had been removed (those are probably orphans).</p>
</div>
<div class="paragraph">
<p><strong>Option: COPY_AS_IS_ZYPPER and COPY_AS_IS_EXCLUDE_ZYPPER</strong></p>
</div>
<div class="paragraph">
<p>The COPY_AS_IS_ZYPPER array contains by default basically what <code>rpm -qc
zypper ; rpm -ql libzypp | grep -Ev 'locale|man'</code> shows (currently determined
on openSUSE Leap 42.1) plus the special <em>/etc/products.d/baseproduct</em> link
and whereto it points and rpm because that is required by zypper/libzypp and
finally all kernel modules because otherwise modules like 'isofs' and some
'nls*' modules that are needed to mount a iso9660 image (e.g. a SUSE
installation medium in a CDROM drive) are not available in the ReaR recovery
system which can be a dead end for <code>rear recover</code>.</p>
</div>
<div class="paragraph">
<p>COPY_AS_IS_EXCLUDE_ZYPPER behaves the same as COPY_AS_IS_EXCLUDE, but
specifically for the ZYPPER method.</p>
</div>
<div class="paragraph">
<p><strong>Option: REQUIRED_PROGS_ZYPPER and PROGS_ZYPPER</strong></p>
</div>
<div class="paragraph">
<p>By default, the REQUIRED_PROGS_ZYPPER array contains all zypper, libzypp
and libsolv-tools binaries - i.e. all what <code>rpm -ql zypper | grep bin ; rpm -ql libzypp | grep bin ; rpm -ql libsolv-tools | grep bin</code>
shows (currently determined on openSUSE Leap 42.1) and all rpm binaries
because RPM is required by zypper/libzypp/libsolv-tools.</p>
</div>
<div class="paragraph">
<p>The PROGS_ZYPPER array is empty by default and intended to contain additional
useful programs that are not strictly required in the ReaR recovery system to
run <code>rear recover</code>.</p>
</div>
<div class="paragraph">
<p><strong>Option: ZYPPER_ROOT_PASSWORD</strong></p>
</div>
<div class="paragraph">
<p>ZYPPER_ROOT_PASSWORD specifies the initial root password in the target system.
This initial root password should not be the actually intended root password
because its value is stored in usually insecure files (e.g.
<em>/etc/rear/local.conf</em>) which are included in the ReaR recovery system that
is stored in also usually insecure files (like ISO images e.g.
<code>rear-HOSTNAME.iso</code>) so that the actually intended root password for the
target system should be set manually by the admin after <code>rear recover</code>.</p>
</div>
<div class="paragraph">
<p>As fallback <code>rear recover</code> sets 'root' as root password in the target system.</p>
</div>
<div class="paragraph">
<p>If SSH_ROOT_PASSWORD is specified it is used as root password in the target
system unless ZYPPER_ROOT_PASSWORD is specified, which is used with highest
priority.</p>
</div>
<div class="paragraph">
<p><strong>Option: ZYPPER_NETWORK_SETUP_COMMANDS</strong></p>
</div>
<div class="paragraph">
<p>ZYPPER_NETWORK_SETUP_COMMANDS specifies the initial network setup for the
target system.</p>
</div>
<div class="paragraph">
<p>This initial network setup is only meant to make the target system accessible
from remote in a very basic way (e.g. for 'ssh'). The actually intended
network setup for the target system should be done manually by the admin
after <code>rear recover</code>.</p>
</div>
<div class="paragraph">
<p>The by default empty ZYPPER_NETWORK_SETUP_COMMANDS array means that, during
<code>rear recover</code>, no network setup happens in the target system.  The
ZYPPER_NETWORK_SETUP_COMMANDS array can be used for manual network setup, for
example, like <code>ZYPPER_NETWORK_SETUP_COMMANDS=( 'ip addr add 192.168.100.2/24 dev eth0' 'ip link set dev eth0 up' 'ip route add default via 192.168.100.1' )</code>
where each command in ZYPPER_NETWORK_SETUP_COMMANDS is run during
<code>rear recover</code> in the target system (via 'chroot').  When one of the
commands in ZYPPER_NETWORK_SETUP_COMMANDS is the special string
'NETWORKING_PREPARATION_COMMANDS', the commands in
NETWORKING_PREPARATION_COMMANDS are called inside the target system.</p>
</div>
<div class="paragraph">
<p>When one of the commands in ZYPPER_NETWORK_SETUP_COMMANDS is the special
string 'YAST', initial network setup in the target system happens by
calling the hardcoded command <code>yast2 --ncurses lan add name=eth0 ethdevice=eth0 bootproto=dhcp</code>.</p>
</div>
<div class="paragraph">
<p>If something else is needed, an appropriate yast2 command can be manually specified.</p>
</div>
</div>
<div class="sect3">
<h4 id="_example">13.7.2. Example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">OUTPUT=ISO
BACKUP=ZYPPER
BACKUP_OPTIONS="nfsvers=3,nolock"
BACKUP_URL=nfs://10.160.4.244/nfs
SSH_ROOT_PASSWORD='password_on_the_rear_recovery_system'
USE_DHCLIENT="yes"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_yum">13.8. YUM</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
YUM method support was added to Relax-and-Recover 2.3.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>YUM is a port of the ZYPPER method for Linux distributions which use the yum
package manager, such as RHEL, CentOS, Fedora, etc.</p>
</div>
<div class="paragraph">
<p>Most options are the similar to, or the same as, the ZYPPER options.  If a
particular option is not documented here, look at the equivalent ZYPPER_*
option.</p>
</div>
<div class="paragraph">
<p><strong>Option: YUM_EXCLUDE_PKGS</strong></p>
</div>
<div class="paragraph">
<p>Packages listed in this array will not be installed on the target
system, even if they are present on the source system.</p>
</div>
<div class="paragraph">
<p>This can be useful if, for instance, more than one kernel is installed
and you want to exclude the older kernel(s) from being installed on
the target system.</p>
</div>
<div class="sect3">
<h4 id="_example_2">13.8.1. Example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">OUTPUT=ISO
BACKUP=YUM
BACKUP_URL=iso://backup
OUTPUT_URL=null
YUM_EXCLUDE_PKGS=( 'kernel*327*' 'tree' )
export http_proxy="http://10.0.2.2:8080"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_yumbackup">13.9. YUM+backup</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
YUM with file backup support was added to Relax-and-Recover 2.4.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This extension to the YUM method behaves a little differently than
folks usually expect:  A full system backup is possible, but the
backup archive contains only the bare minimum files required to end
up with a full restore.</p>
</div>
<div class="paragraph">
<p>The backup archive is created in a similar manner as that used in
the NETFS method (tar.gz), but all files which have been installed
via RPM, and have not been modified, are excluded.  All other files,
including those installed via RPM that have been modified, are
captured by the backup.</p>
</div>
<div class="paragraph">
<p>With file backup, ReaR will capture all modified configuration files,
user directories, custom scripts, etc without also storing all of the
files which ReaR will install as part of a package during recovery.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
At present, YUM+backup has only been tested with <code>OUTPUT=ISO</code>.
Since files like <em>/etc/passwd</em> will have been modified, they will, by
default, be included in the backup archive which is stored in the ISO.
<strong>Any time that your backup archive is contained on the ISO, such as
with YUM+backup or NETFS, it is prudent to exercise proper security
so that the contents of the ISO do not fall into the wrong hands!</strong>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_configuration_9">13.9.1. Configuration</h4>
<div class="paragraph">
<p><strong>Option: YUM_BACKUP_FILES</strong></p>
</div>
<div class="paragraph">
<p>When set to a true value (yes, true, 1, etc), ReaR will create a
backup archive the files on the source which must be restored after
the packages are installed in order to result in a fully recovered
system.</p>
</div>
</div>
<div class="sect3">
<h4 id="_options_only_available_with_yum_backup_filesyes">13.9.2. Options only available with YUM_BACKUP_FILES=yes</h4>
<div class="paragraph">
<p><strong>Option: RECREATE_USERS_GROUPS</strong></p>
</div>
<div class="paragraph">
<p>This option determines if/how users and groups that are present on the
source system at the time that the backup is created, are recreated on the
target system.</p>
</div>
<div class="paragraph">
<p>By default, users and groups are not added to the target system during
<code>rear recover</code> unless they are added when a package is installed.</p>
</div>
<div class="paragraph">
<p>The <code>RECREATE_USERS_GROUPS="yes"</code> setting will tell ReaR to recreate all
users and groups on the target system, but passwords are locked.</p>
</div>
<div class="paragraph">
<p>Adding "passwords" to the RECREATE_USERS_GROUPS array
(<code>RECREATE_USERS_GROUPS=("yes" "passwords")</code>) will also set the target
system passwords.</p>
</div>
<div class="paragraph">
<p><strong>Option: YUM_BACKUP_FILES_FULL_EXCL</strong></p>
</div>
<div class="paragraph">
<p>This option determines if a comprehensive exclusion list is built
during backup.</p>
</div>
<div class="paragraph">
<p>The reason behind this option is that symlinks in file paths will
cause files which have been excluded (usually due to being provided
when a package is installed) to be implicitly included via the
alternate path(s) present on the system.</p>
</div>
<div class="paragraph">
<div class="title">Example</div>
<p>On a system where <em>/sbin</em> is a symlink to <em>/usr/sbin</em>,
<em>/usr/sbin/ifup</em> will be excluded due to being provided by the
initscripts package, but <em>/sbin/ifup</em> will still be present in the
archive due to the alternate path.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ ls -ald /sbin
lrwxrwxrwx. 1 root root 8 Jun 15  2017 /sbin -&gt; usr/sbin</code></pre>
</div>
</div>
<div class="paragraph">
<p>A full, comprehensive exclusion list will find all paths to excluded
files, making the backup archive as small as possible, but can
potentially take a LOT longer due to the file system scans.</p>
</div>
<div class="paragraph">
<p><strong>Option: YUM_BACKUP_SELINUX_CONTEXTS</strong></p>
</div>
<div class="paragraph">
<p>ReaR can also capture the SELinux security contexts of every file
on the source system and reapply those contexts after the packages
have been reinstalled (and the backups, if any, have been extracted).</p>
</div>
</div>
<div class="sect3">
<h4 id="_example_3">13.9.3. Example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">OUTPUT=ISO
BACKUP=YUM
BACKUP_URL=iso://backup
OUTPUT_URL=null
BACKUP_SELINUX_DISABLE=0
YUM_BACKUP_FILES=yes
YUM_BACKUP_FILES_FULL_EXCL=yes
YUM_BACKUP_SELINUX_CONTEXTS=yes
RECREATE_USERS_GROUPS=( "yes" "passwords" )
export http_proxy="http://10.0.2.2:8080"</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_efistub_support">14. EFISTUB support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>EFISTUB booting allows EFI firmware to directly load Linux kernel as an EFI executable. At the time of writing, EFISTUB support in kernel is widely available across all major distributions like SLES, Debian, Ubuntu, Fedora, Arch &#8230;&#8203;
When using traditional boot-loaders ((E)LILO, Grub), ReaR does not auto-magically recreate booting information on restore, but respective code must exist and this also applies for EFISTUB booting.</p>
</div>
<div class="sect2">
<h3 id="_prerequisites_2">14.1. Prerequisites</h3>
<div class="paragraph">
<p>There is plenty of ways how EFISTUB can be setup on source system but for the start I&#8217;ve decided to keep first EFISTUB implementation as simple as possible and eventually cover more robust configuration later (if need arise). For this reason ReaR currently offers very basic implementation, where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>active Linux kernel must be compiled with <strong>CONFIG_EFI_STUB=y</strong></p>
</li>
<li>
<p>active Linux kernel and initrd are located directly on <strong>vfat</strong> partition</p>
</li>
<li>
<p><strong>no intermediate boot loader</strong> (ELILO, Grub, systemd-boot, &#8230;&#8203;) is in use and OS is booted directly from UEFI boot menu</p>
</li>
<li>
<p>systemd-boot binary (for booting of ReaR recovery system) is available on system (usually as part of Systemd)</p>
</li>
<li>
<p>currently works only with <strong>OUTPUT=ISO</strong></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_rear_configuration">14.2. ReaR Configuration</h3>
<div class="paragraph">
<p>By default EFISTUB is disabled in ReaR and user must explicitly enable this functionality. Detection of EFISTUB booting is quite a problematic topic since it can co-exist with traditional boot loaders. Many Linux distributions are shipping Linux kernels with enabled EFISTUB support despite a fact that it is not used, and OS is using traditional intermediate boot loaders instead. You should enable EFISTUB in ReaR only if your system is really configured to boot this way, otherwise ReaR will try to perform migration.</p>
</div>
<div class="paragraph">
<p>To enable EFISTUB booting in ReaR one must specify following variable in <em>local.conf</em> or <em>site.conf</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>EFI_STUB="yes"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_migration">14.3. Migration</h3>
<div class="paragraph">
<p>Migrating from traditional boot-loader to EFISTUB is kind of side effect of current implementation. Current EFISTUB code can&#8217;t reliably determine if system is configured with EFISTUB boot hence user must explicitly specify that he wishes his system is considered EFISTUB bootable by ReaR.
If operating system is set to boot using intermediate boot loaders and despite this <code>EFI_STUB="yes"</code> is explicitly set, ReaR will omit installation of intermediate boot loaders and just creates UEFI boot entry pointing directly to EFISTUB boot capable kernel when system is restored.</p>
</div>
</div>
<div class="sect2">
<h3 id="_checks_done_by_rear">14.4. Checks done by ReaR</h3>
<div class="paragraph">
<p>When user enables EFISTUB, ReaR does some basic checks and tries to ensure that ReaR recovery runs without problems and resulting operating system is able to boot. However it is very hard to cover all configuration possibilities and corner cases, so it is important to ALWAYS TEST full ReaR backup and restore before relying on it. Short list of checks done by ReaR during <code>rear mkbackup/mkrescue</code> includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>check if Systemd boot loader (systemd-bootx64.efi) exists and is regular file</p>
</li>
<li>
<p>check if some of basic EFISTUB symbols are present in Linux kernel file in use</p>
</li>
<li>
<p>check if Linux kernel in use is located on vfat partition</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_tests">14.5. Tests</h3>
<div class="paragraph">
<p>Current code was primarily created and tested with Arch Linux, since most requests for EFISTUB functionality in ReaR keeps coming from this community.
Test system was running under VirtualBox host with following configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OS version</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>arch-efi:(/root)(root)# lsb_release -a
LSB Version:    1.4
Distributor ID: Arch
Description:    Arch Linux
Release:    rolling
Codename:   n/a

arch-efi:(/root)(root)# uname -a
Linux arch-efi.virtual.sk 4.20.5-arch1-1-ARCH #1 SMP PREEMPT Sat Jan 26 12:59:18 UTC 2019 x86_64 GNU/Linux</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>boot entry for Arch Linux (<em>Boot0003</em>) created in UEFI</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>arch-efi:(/root)(root)# efibootmgr -v
BootCurrent: 0003
BootOrder: 0003,0000,0001,0002
Boot0000* EFI DVD/CDROM PciRoot(0x0)/Pci(0x1,0x1)/Ata(1,0,0)
Boot0001* EFI Hard Drive    PciRoot(0x0)/Pci(0xd,0x0)/Sata(0,0,0)
Boot0002* EFI Internal Shell    MemoryMapped(11,0x2100000,0x28fffff)/FvFile(7c04a583-9e3e-4f1c-ad65-e05268d0b4d1)
Boot0003* Arch Linux    HD(1,GPT,e3b3601c-8037-4bf6-a938-4772cfb1ad9f,0x800,0x113000)/File(vmlinuz-linux)i.n.i.t.r.d.=.i.n.i.t.r.a.m.f.s.-.l.i.n.u.x...i.m.g. .r.o.o.t.=./.d.e.v./.s.d.a.2.</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>ReaR configuration</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>arch-efi:(/root)(root)# cat /etc/rear/local.conf
BACKUP=NETFS
OUTPUT=ISO

BACKUP_URL=nfs://backup.virtual.sk/mnt/rear
OUTPUT_URL=nfs://backup.virtual.sk/mnt/rear/iso

BACKUP_OPTIONS="nfsvers=3,nolock"

EFI_STUB=yes</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>File system layout</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>arch-efi:(/root)(root)# df -Th
Filesystem     Type      Size  Used Avail Use% Mounted on
dev            devtmpfs  485M     0  485M   0% /dev
run            tmpfs     492M  404K  491M   1% /run
/dev/sda2      ext4      7.3G  2.1G  4.9G  30% /
tmpfs          tmpfs     492M     0  492M   0% /dev/shm
tmpfs          tmpfs     492M     0  492M   0% /sys/fs/cgroup
/dev/sda1      vfat      549M   41M  509M   8% /boot
tmpfs          tmpfs      99M     0   99M   0% /run/user/0</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Content of /boot</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>arch-efi:(/root)(root)# ls -l /boot
total 41684
-rwxr-xr-x 1 root root    31232 Jan 22 10:14 amd-ucode.img
-rwxr-xr-x 1 root root 29094161 Feb  3 09:09 initramfs-linux-fallback.img
-rwxr-xr-x 1 root root  7686652 Feb  3 09:09 initramfs-linux.img
drwxr-xr-x 2 root root     4096 Jan 31 14:56 syslinux
-rwxr-xr-x 1 root root  5855104 Jan 31 09:17 vmlinuz-linux</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_migration_from_grub2_to_efistub_on_sles12_sp2">14.6. Migration from GRUB2 to EFISTUB on SLES12 SP2</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Do not start migration to EFISTUB until you are familiar with all the eventualities. It might happen that you end up with un-bootable system. Most of the time it is possible to fix un-bootable system, but some deeper knowledge might be required to succeed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When prerequisites are fulfilled one can use ReaR EFISTUB code to migrate system from intermediate boot loaders like GRUB, ELILO to EFISTUB.
For the demonstration purposes I&#8217;ve tried migration from GRUB2 to EFISTUB on SLES12 SP2.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OS version</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sp2:~ # cat /etc/os-release
NAME="SLES_SAP"
VERSION="12-SP2"
VERSION_ID="12.2"
PRETTY_NAME="SUSE Linux Enterprise Server for SAP Applications 12 SP2"
ID="sles_sap"
ANSI_COLOR="0;32"
CPE_NAME="cpe:/o:suse:sles_sap:12:sp2"</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Basic ReaR configuration (does not include all EFISTUB configuration pieces yet)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sp2:~ # cat /etc/rear/local.conf
BACKUP=NETFS
OUTPUT=ISO

BACKUP_URL=nfs://backup.virtual.sk/mnt/rear
OUTPUT_URL=nfs://backup.virtual.sk/mnt/rear/iso

BACKUP_OPTIONS="nfsvers=3,nolock"

BACKUP_PROG_EXCLUDE+=( /mnt )

#BTRFS stuff
REQUIRED_PROGS+=( snapper chattr lsattr xfs_repair )
COPY_AS_IS+=( /usr/lib/snapper/installation-helper /etc/snapper/config-templates/default )
BACKUP_PROG_INCLUDE=( $(findmnt -n -r -t btrfs | cut -d ' ' -f 1 | grep -v '^/$' | grep -Ev 'snapshots|crash' ) )

EFI_STUB=y</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>File system layout</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Filesystem              Type      Size  Used Avail Use% Mounted on
devtmpfs                devtmpfs  235M     0  235M   0% /dev
tmpfs                   tmpfs     8.0G     0  8.0G   0% /dev/shm
tmpfs                   tmpfs     244M  4.8M  239M   2% /run
tmpfs                   tmpfs     244M     0  244M   0% /sys/fs/cgroup
/dev/mapper/system-root btrfs     7.8G  3.9G  3.3G  55% /
/dev/mapper/system-root btrfs     7.8G  3.9G  3.3G  55% /var/lib/named
/dev/mapper/system-root btrfs     7.8G  3.9G  3.3G  55% /home
/dev/mapper/system-root btrfs     7.8G  3.9G  3.3G  55% /var/lib/pgsql
/dev/mapper/system-root btrfs     7.8G  3.9G  3.3G  55% /var/cache
/dev/mapper/system-root btrfs     7.8G  3.9G  3.3G  55% /var/tmp
/dev/mapper/system-root btrfs     7.8G  3.9G  3.3G  55% /var/lib/mailman
/dev/mapper/system-root btrfs     7.8G  3.9G  3.3G  55% /var/log
/dev/mapper/system-root btrfs     7.8G  3.9G  3.3G  55% /var/lib/libvirt/images
/dev/mapper/system-root btrfs     7.8G  3.9G  3.3G  55% /usr/local
/dev/mapper/system-root btrfs     7.8G  3.9G  3.3G  55% /boot/grub2/x86_64-efi
/dev/mapper/system-root btrfs     7.8G  3.9G  3.3G  55% /var/spool
/dev/mapper/system-root btrfs     7.8G  3.9G  3.3G  55% /var/crash
/dev/mapper/system-root btrfs     7.8G  3.9G  3.3G  55% /opt
/dev/mapper/system-root btrfs     7.8G  3.9G  3.3G  55% /var/lib/mariadb
/dev/mapper/system-root btrfs     7.8G  3.9G  3.3G  55% /tmp
/dev/mapper/system-root btrfs     7.8G  3.9G  3.3G  55% /var/opt
/dev/mapper/system-root btrfs     7.8G  3.9G  3.3G  55% /srv
/dev/mapper/system-root btrfs     7.8G  3.9G  3.3G  55% /var/lib/mysql
/dev/mapper/system-root btrfs     7.8G  3.9G  3.3G  55% /var/lib/machines
/dev/mapper/system-root btrfs     7.8G  3.9G  3.3G  55% /boot/grub2/i386-pc
/dev/sda1               vfat      156M   26M  131M  17% /boot/efi
tmpfs                   tmpfs      49M     0   49M   0% /run/user/0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since we don&#8217;t have condition that active Linux kernel and initrd must reside on vfat file system, we can fulfill this requirement in two ways:</p>
</div>
<div class="paragraph">
<p><strong>1. Copy active Linux kernel and initrd files to vfat file system and configure ReaR to use alternate kernel file.</strong></p>
</div>
<div class="paragraph">
<p>In this particular case active kernel and initrd image are represented by following files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sp2:~ # ls -al /boot/vmlinuz-* /boot/initrd-*
-rw------- 1 root root 16365388 Aug 30 17:29 /boot/initrd-4.4.21-69-default
-rw-r--r-- 1 root root  5742352 Oct 25  2016 /boot/vmlinuz-4.4.21-69-default</code></pre>
</div>
</div>
<div class="paragraph">
<p>To copy files to vfat file system <em>/boot/efi</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sp2:~ # cp /boot/initrd-4.4.21-69-default /boot/efi
sp2:~ # cp /boot/vmlinuz-4.4.21-69-default /boot/efi</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we need to tell ReaR that we have kernel on vfat file system by adding <code>KERNEL_FILE="/boot/efi/vmlinuz-4.4.21-69-default"</code> configuration option into <em>/etc/rear/local.conf</em></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Using kernel and initrd from other location than <em>/boot</em>, might require to perform some additional steps every time kernel and initrd changes (e.g. after each kernel or initrd update), like copy updated files to alternate location.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>2. Convert /boot to vfat file system</strong></p>
</div>
<div class="paragraph">
<p>There is several ways how one can convert <em>/boot</em> into vfat. Easiest one is to create additional partition, format it with vfat and mount it under <em>/boot</em>.
As to cover this topic can be quite exhausting, it is not part of this document. In general if you don&#8217;t know how to migrate <em>/boot</em> to vfat, you should consider your decision to migrate system to EFISTUB carefully once more&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Whether you&#8217;ve decided to use <em>1st</em> or <em>2nd</em> method, last thing remaining is to configure custom boot attributes for EFISTUB. Normally when ReaR is configured to backup EFISTUB enabled system, it takes boots option from <code>/proc/cmdline</code>. During migration however <code>/proc/cmdline</code> does not contain sufficient information for successful EFISTUB boot. In our case:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sp2:~ # cat /proc/cmdline
BOOT_IMAGE=/boot/vmlinuz-4.4.21-69-default root=/dev/mapper/system-root ro resume=/dev/system/swap splash=silent quiet showopts</code></pre>
</div>
</div>
<div class="paragraph">
<p>lacks information about which <em>initrd</em> image should be booted. This information can be passed to ReaR by <code>EFI_STUB_EFIBOOTMGR_ARGS</code> configuration option. In our case we will add</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>EFI_STUB_EFIBOOTMGR_ARGS="initrd=initrd-4.4.21-69-default root=/dev/mapper/system-root ro resume=/dev/system/swap splash=silent quiet showopts"</code></pre>
</div>
</div>
<div class="paragraph">
<p>configuration directive into <em>/etc/rear/local.conf</em>.</p>
</div>
<div class="paragraph">
<p>With ReaR configured as described in previous lines, we can start OS backup with <code>rear mkbackup</code>.</p>
</div>
<div class="paragraph">
<p>When ReaR recovery system is booted, we can start restore process as usual with <code>rear recover</code>. Once operation is over and you&#8217;ve used 1st method (<em>Copy active Linux kernel and initrd files to vfat file system and configure ReaR to use alternate kernel file</em>) you must copy <em>initrd</em> image file, recently modified by ReaR, from <em>/mnt/local/boot</em> into its alternate location (<em>/mnt/local/boot/efi</em> in our case)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>RESCUE sp2:~ # cp /mnt/local/boot/initrd-4.4.21-69-default /mnt/local/boot/efi/</code></pre>
</div>
</div>
<div class="paragraph">
<p>because of reason mentioned in <em>WARNING</em> section of 1st method. If you&#8217;ve been using 2nd method (<em>Convert /boot to vfat file system</em>), you can reboot ReaR recovery system without any further modifications.</p>
</div>
<div class="paragraph">
<p>Now restored system is ready for reboot!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_documentation_for_the_rubrik_cloud_data_management_cdm_backup_and_restore_method">15. Documentation for the Rubrik Cloud Data Management (CDM) Backup and Restore Method</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_summary_2">15.1. Summary</h3>
<div class="paragraph">
<p>The Rubrik CDM backup and restore method for ReaR allows Rubrik CDM to perform bare metal recovery of Linux systems that are supported by ReaR. It does this by including the installed Rubrik CDM RBS agent files in the ISO that is created by <code>rear mkrescue</code> via a pre-script in the fileset. The ISO is left in place under <code>/var/lib/rear/output/rear-&lt;hostname&gt;.iso</code> by default. During the fileset backup Rubrik will backup the main operating system files as well as the ReaR ISO file.</p>
</div>
<div class="paragraph">
<p>Bare Metal Recovery is performed by first restoring the ReaR ISO file from Rubrik CDM to an alternate host. Next the host being restored is booted from the ISO via CD/DVD, USB, vSphere Datastore ISO, etc&#8230;&#8203; Once booted running <code>rear recover</code> will prepare the host for restore and start the Rubrik CDM RBS agent. If the host has a new IP address the new RBS agent will need to be registered with the Rubrik cluster. Registration is not necessary if the recovery host is reusing the same IP address as the original. All of the files for the host are then recovered from Rubrik CDM to the recovery host&#8217;s <code>/mnt/local</code> directory by the user. Once complete the user exit&#8217;s ReaR and reboots the host.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_10">15.2. Configuration</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install and configure ReaR in accordance with:</p>
<div class="ulist">
<ul>
<li>
<p>Red Hat</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/deployment_guide/ch-relax-and-recover_rear" class="bare">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/deployment_guide/ch-relax-and-recover_rear</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Ubuntu</p>
<div class="ulist">
<ul>
<li>
<p><a href="http://manpages.ubuntu.com/manpages/disco/en/man8/rear.8.html" class="bare">http://manpages.ubuntu.com/manpages/disco/en/man8/rear.8.html</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>SUSE</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://en.opensuse.org/SDB:Disaster_Recovery" class="bare">https://en.opensuse.org/SDB:Disaster_Recovery</a></p>
</li>
<li>
<p><a href="https://documentation.suse.com/sle-ha/15-SP1/html/SLE-HA-all/cha-ha-rear.html" class="bare">https://documentation.suse.com/sle-ha/15-SP1/html/SLE-HA-all/cha-ha-rear.html</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Generic</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/rear/rear" class="bare">https://github.com/rear/rear</a></p>
<div class="literalblock">
<div class="content">
<pre>NOTE: Ignore any instructions to configure external storage like NFS, CIFS/SMB or ftp. Also ignore any instructions to configure a specific backup method. This will be taken care of in the next steps.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>NOTE: Ignore any instructions to schedule ReaR to run via the host based scheduler (cron). Rubrik CDM will run ReaR via a pre-script in the fileset. If this is not preferred ReaR can be scheduled on the host, however, the ISOs created may not be in sync with the backups.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>NOTE: If installing the pre-release or development version for which there is no installer, copy the repo to the host being protected. Then run `make install` from its root directory of the repo.</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Install the Rubrik CDM RBS agent as directed by the Rubrik documentation.</p>
</li>
<li>
<p>Edit <code>/etc/rear/local.conf</code> and enter:</p>
<div class="literalblock">
<div class="content">
<pre>OUTPUT=ISO
BACKUP=CDM</pre>
</div>
</div>
</li>
<li>
<p>Test <code>ReaR</code> by running <code>rear -v mkrescue</code></p>
</li>
<li>
<p>Configure fileset backup of the host and add <code>/usr/sbin/rear mkrescue</code> as a prescript.</p>
</li>
<li>
<p>ISOs will be saved as <code>/var/lib/rear/output/*.iso</code></p>
<div class="ulist">
<ul>
<li>
<p>Recovery</p>
</li>
</ul>
</div>
</li>
<li>
<p>Recover <code>/var/lib/rear/output/rear-&lt;hostname&gt;.iso</code> from host to be restored.</p>
</li>
<li>
<p>Boot recovery machine using recovered ISO.</p>
<div class="literalblock">
<div class="content">
<pre>NOTE: Recovered system will use the same networking as the original machine. Verify no IP conflicts will occur.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>NOTE: If the same static IP address may be used it will need to be changed if the original machine is still running.</pre>
</div>
</div>
</li>
<li>
<p>Verify Firewall is down on recovery host.</p>
</li>
<li>
<p>Run <code>rear recover</code></p>
</li>
<li>
<p>Answer inline questions until <code>rear&gt;</code> prompt appears.</p>
</li>
<li>
<p>Run <code>ps -eaf</code> and verify that <code>backup_agent_main</code> and <code>bootstrap_agent_main</code> are running.</p>
</li>
<li>
<p>Get the IP address of the system using <code>ip addr</code></p>
</li>
<li>
<p>Register the new IP with the Rubrik appliance (if needed)</p>
</li>
<li>
<p>Perform a re-directed export of <code>/</code> to <code>/mnt/local</code></p>
</li>
<li>
<p>Reboot</p>
</li>
<li>
<p>Recover other file systems as needed.</p>
<div class="literalblock">
<div class="content">
<pre>Note: that the Rubrik RBS agent will connect as the original machine now. The host may need to be reinstalled and re-registered if the original machine is still running.</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_known_issues">15.3. Known Issues</h3>
<div class="ulist">
<ul>
<li>
<p>Recovery via IPv6 is not yet supported.</p>
</li>
<li>
<p>Automatic recovery from replica CDM cluster is not supported</p>
</li>
<li>
<p>CDM may take some time to recognize that the IP address has moved from one system to another. When restoring using the same IP give CDM up to 10 minutes to recognize that the agent is running on another machine. This usually comes up during testing when the original machine is shutdown but not being restored to.</p>
</li>
<li>
<p>Recovery from a replica CDM cluster is only supported with CDM v4.2.1 and higher.</p>
</li>
<li>
<p>Care must be taken with SUSE systems on DHCP. They tend to request the same IP as the original host. If this is not the desired behavior the system will have to be adjusted after booting from the ReaR ISO.</p>
</li>
<li>
<p>If multiple restores are performed using the same temporary IP, the temporary IP must first be deleted from Servers &amp; Apps &#8594; Linux and Unix Servers and re-added upon each reuse.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_troubleshooting">15.4. Troubleshooting</h3>
<div class="ulist">
<ul>
<li>
<p>Verify that ReaR will recover your system without using the CDM backup and restore method. Most errors are due to configuration with ReaR itself and not Rubrik CDM. Use the default ReaR backup and restore method to test with.</p>
</li>
<li>
<p>Follow the OS specific configuration guides as mentioned at the beginning of this document.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_test_matrix">15.5. Test Matrix</h3>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Test Matrix</caption>
<colgroup>
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6924%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operating System</th>
<th class="tableblock halign-left valign-top">DHCP</th>
<th class="tableblock halign-left valign-top">Static IP</th>
<th class="tableblock halign-left valign-top">Virtual</th>
<th class="tableblock halign-left valign-top">Physical</th>
<th class="tableblock halign-left valign-top">LVM Root Disk</th>
<th class="tableblock halign-left valign-top">Plain Root Disk</th>
<th class="tableblock halign-left valign-top">EXT3</th>
<th class="tableblock halign-left valign-top">EXT4</th>
<th class="tableblock halign-left valign-top">XFS</th>
<th class="tableblock halign-left valign-top">BTRFS</th>
<th class="tableblock halign-left valign-top">Original Cluster</th>
<th class="tableblock halign-left valign-top">Replication Cluster</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CentOS 7.3</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pass</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CentOS 7.6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CentOS 7.7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CentOS 8.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CentOS 5.11</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CentOS 6.10</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RHEL 7.6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RHEL 7.4</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RHEL 6.10</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SUSE 11 SP4</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SUSE 12 SP4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass (uses same IP as original)</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ubuntu 14.04 LTS</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ubuntu 16.04 LTS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ubuntu 17.04 LTS</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>Empty cells indicate that no tests were run.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-02-05 00:00:00 UTC
</div>
</div>
</body>
</html>